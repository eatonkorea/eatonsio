<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIO 접수 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
    .pop-in { animation: popIn 0.4s ease-out; }
    @keyframes checkmark { 0% { stroke-dashoffset: 100; } 100% { stroke-dashoffset: 0; } }
    .checkmark-circle { animation: popIn 0.4s ease-out; }
    .checkmark-check { stroke-dasharray: 100; animation: checkmark 0.6s ease-out 0.3s forwards; stroke-dashoffset: 100; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const API_URL = 'https://script.google.com/macros/s/AKfycbyaJ2afcct-sLCQ9pAG2HPf78o0rGZZHTvwP4QAWRAb_puRdwOFWNCWdQQNx74tdbfPSw/exec';

    const convertDriveUrl = (url) => {
      if (!url) return '';
      const match = url.match(/[?&]id=([^&]+)/);
      if (match) return `https://lh3.googleusercontent.com/d/${match[1]}`;
      return url;
    };

    const Icon = ({ name, size = 24, className = "" }) => {
      const ref = React.useRef();
      React.useEffect(() => {
        if (ref.current) {
          ref.current.innerHTML = '';
          const icon = lucide.createElement(lucide.icons[name]);
          icon.setAttribute('width', size);
          icon.setAttribute('height', size);
          if (className) icon.setAttribute('class', className);
          ref.current.appendChild(icon);
        }
      }, [name, size, className]);
      return <span ref={ref} className="inline-flex items-center justify-center"></span>;
    };

    function SuccessModal({ onClose }) {
      React.useEffect(() => { const timer = setTimeout(onClose, 2500); return () => clearTimeout(timer); }, [onClose]);
      return (
        <div className="fixed inset-0 bg-green-500 flex flex-col items-center justify-center z-50" onClick={onClose}>
          <div className="pop-in flex flex-col items-center">
            <svg className="w-32 h-32 mb-6" viewBox="0 0 100 100">
              <circle className="checkmark-circle" cx="50" cy="50" r="45" fill="none" stroke="white" strokeWidth="6"/>
              <path className="checkmark-check" d="M30 50 L45 65 L70 35" fill="none" stroke="white" strokeWidth="6" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
            <h1 className="text-white text-3xl font-bold mb-2">접수 완료!</h1>
            <p className="text-green-100 text-lg">SIO가 성공적으로 접수되었습니다</p>
          </div>
          <p className="absolute bottom-10 text-green-200 text-sm">화면을 터치하면 닫힙니다</p>
        </div>
      );
    }

    function NetworkErrorModal({ onClose }) {
      React.useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
      return (
        <div className="fixed inset-0 bg-red-500 flex flex-col items-center justify-center z-50" onClick={onClose}>
          <div className="pop-in flex flex-col items-center">
            <svg className="w-32 h-32 mb-6" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" fill="none" stroke="white" strokeWidth="6"/>
              <path d="M35 35 L65 65 M65 35 L35 65" fill="none" stroke="white" strokeWidth="6" strokeLinecap="round"/>
            </svg>
            <h1 className="text-white text-3xl font-bold mb-2 text-center">네트워크가 불안정합니다</h1>
            <p className="text-red-100 text-lg">잠시 후 다시 시도하세요</p>
          </div>
          <p className="absolute bottom-10 text-red-200 text-sm">화면을 터치하면 닫힙니다</p>
        </div>
      );
    }

    function ConfirmModal({ message, onConfirm, onCancel }) {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 max-w-sm w-full">
            <p className="text-gray-800 text-center mb-6">{message}</p>
            <div className="flex gap-3">
              <button onClick={onCancel} className="flex-1 py-3 border border-gray-300 rounded-lg text-gray-600 font-medium">취소</button>
              <button onClick={onConfirm} className="flex-1 py-3 bg-red-500 text-white rounded-lg font-medium">삭제</button>
            </div>
          </div>
        </div>
      );
    }

    function AlertModal({ message, onClose, type = 'info' }) {
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 max-w-sm w-full">
            <div className={`w-16 h-16 ${bgColor} rounded-full flex items-center justify-center mx-auto mb-4`}>
              <Icon name={type === 'success' ? 'Check' : type === 'error' ? 'X' : 'Mail'} size={32} className="text-white" />
            </div>
            <p className="text-gray-800 text-center mb-6">{message}</p>
            <button onClick={onClose} className="w-full py-3 bg-gray-800 text-white rounded-lg font-medium">확인</button>
          </div>
        </div>
      );
    }

    function PasswordModal({ department, deptSettings, onConfirm, onCancel }) {
      const [password, setPassword] = React.useState('');
      const [error, setError] = React.useState(false);

      const handleSubmit = () => {
        // 로컬에서 비밀번호 확인 (서버 호출 없음)
        const deptInfo = deptSettings.find(d => d.department === department);
        if (deptInfo && deptInfo.password === password) {
          onConfirm();
        } else {
          setError(true);
          setPassword('');
        }
      };

      const handleKeyDown = (e) => { if (e.key === 'Enter') handleSubmit(); };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 max-w-sm w-full">
            <div className="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <Icon name="Lock" size={32} className="text-white" />
            </div>
            <h3 className="text-lg font-bold text-center text-gray-800 mb-2">{department}</h3>
            <p className="text-gray-500 text-center text-sm mb-4">비밀번호를 입력하세요</p>
            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={handleKeyDown}
              className={`w-full p-3 border rounded-lg mb-3 text-center text-lg tracking-widest ${error ? 'border-red-500 bg-red-50' : 'border-gray-300'}`}
              placeholder="••••" autoFocus />
            {error && <p className="text-red-500 text-sm text-center mb-3">비밀번호가 일치하지 않습니다</p>}
            <div className="flex gap-3">
              <button onClick={onCancel} className="flex-1 py-3 border border-gray-300 rounded-lg text-gray-600 font-medium">취소</button>
              <button onClick={handleSubmit} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium">확인</button>
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const [activeTab, setActiveTab] = React.useState('submit');
      const [submissions, setSubmissions] = React.useState([]);
      const [loading, setLoading] = React.useState(false);
      const [error, setError] = React.useState(null);
      const [isAdminAuth, setIsAdminAuth] = React.useState(false);
      const [showAdminLogin, setShowAdminLogin] = React.useState(false);
      const [pendingAdminTab, setPendingAdminTab] = React.useState(null);
      const [adminPassword, setAdminPassword] = React.useState('');
      const [showChangePassword, setShowChangePassword] = React.useState(false);
      const [newPassword, setNewPassword] = React.useState('');
      const [confirmPassword, setConfirmPassword] = React.useState('');
      const [testMode, setTestMode] = React.useState(false); // 테스트 모드 (접수 차단)
      
      const defaultSettings = {
        departments: ['생산팀', '품질팀', '안전팀', '관리팀', '시설팀', '환경팀'],
        categories: ['안전', '품질', '환경', '기타'],
        locations: ['생산1라인', '생산2라인', '사무실', '창고', '야외'],
        adminPassword: 'eaton12!@'
      };
      
      const [settings, setSettings] = React.useState(defaultSettings);

      const [deptSettings, setDeptSettings] = React.useState([]);

      const fetchData = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(API_URL);
          const result = await response.json();
          if (result.success) {
            const formattedData = result.data.map(item => ({
              id: item.ID || item.id,
              date: item['접수일자'] || item.date,
              name: item['이름'] || item.name,
              department: item['부서'] || item.department,
              category: item['구분'] || item.category,
              location: item['장소'] || item.location,
              content: item['내용'] || item.content,
              status: item['조치여부'] || item.status,
              actionDept: item['조치부서'] || item.actionDept || '',
              actionPerson: item['조치담당자'] || item.actionPerson || '',
              actionContent: item['조치내용'] || item.actionContent || '',
              actionPhoto: item['조치사진URL'] || item.actionPhoto || '',
              photo: item['사진URL'] || item.photo,
              photo2: item['사진2URL'] || item.photo2 || '',
              remarks: item['비고'] || item.remarks || '',
              request: item['요청사항'] || item.request || '',
              attachment: item['첨부파일URL'] || item.attachment || '',
              emailSent: item['메일발송'] === 'Y' || item.emailSent === 'Y',
              impact: item['Impact'] || item.impact || '',
              incident: item['Incident'] || item.incident || '',
              rpn: item['RPN'] || item.rpn || '',
              hazard: item['Hazard'] || item.hazard || '',
              top5: item['Top5'] || item.top5 || '',
              sioCategory: item['SIOCategory'] || item.sioCategory || '',
              kaf: item['KAF'] || item.kaf || '',
              targetDate: item['TargetDate'] || item.targetDate || '',
              closedDate: item['ClosedDate'] || item.closedDate || ''
            }));
            setSubmissions(formattedData);
          }
        } catch (err) {
          setError('서버 연결에 실패했습니다.');
        }
        setLoading(false);
      };

      const fetchDeptSettings = async () => {
        try {
          const response = await fetch(API_URL + '?type=deptSettings');
          const result = await response.json();
          if (result.success) setDeptSettings(result.data);
        } catch (err) { console.error(err); }
      };

      const fetchSettings = async () => {
        try {
          const response = await fetch(API_URL + '?type=settings');
          const result = await response.json();
          if (result.success && result.data) {
            setSettings({ ...defaultSettings, ...result.data });
          }
        } catch (err) { console.error(err); }
      };

      const saveSettingsToServer = async (newSettings) => {
        try {
          await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveSettings', settings: newSettings }) });
          setSettings(newSettings);
          return true;
        } catch (err) { 
          setError('설정 저장에 실패했습니다.'); 
          return false;
        }
      };

      React.useEffect(() => { fetchData(); fetchDeptSettings(); fetchSettings(); }, []);

      const handleNewSubmission = async (data, onProgress) => {
        // 테스트 모드일 때 네트워크 에러 표시
        if (testMode) {
          return { success: false, testMode: true };
        }
        
        setLoading(true);
        try {
          const today = new Date();
          const dateOnly = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
          const payload = JSON.stringify({
            action: 'add',
            data: { date: dateOnly, ...data, status: '접수완료', actionDept: '', actionPerson: '', actionContent: '' }
          });
          
          // 데이터 크기 계산
          const totalSize = new Blob([payload]).size;
          
          // 진행률 시뮬레이션 시작
          let progress = 0;
          const interval = setInterval(() => {
            progress += totalSize * 0.1; // 10%씩 증가
            if (progress < totalSize * 0.9) {
              onProgress && onProgress(Math.floor(progress), totalSize);
            }
          }, 200);
          
          const response = await fetch(API_URL, {
            method: 'POST',
            body: payload
          });
          
          clearInterval(interval);
          onProgress && onProgress(totalSize, totalSize); // 100% 완료
          
          const result = await response.json();
          if (result.success) { await fetchData(); return { success: true }; }
        } catch (err) { setError('접수 저장에 실패했습니다.'); }
        setLoading(false);
        return { success: false };
      };

      const handleDelete = async (id) => {
        setLoading(true);
        try {
          await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) });
          await fetchData();
        } catch (err) { setError('삭제에 실패했습니다.'); }
        setLoading(false);
      };

      const handleUpdate = async (id, data) => {
        try {
          await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', id, data }) });
          if (data.actionPhoto && data.actionPhoto.includes('base64,')) {
            await fetchData();
          } else {
            setSubmissions(submissions.map(s => s.id.toString() === id.toString() ? { ...s, ...data } : s));
          }
        } catch (err) { setError('변경에 실패했습니다.'); }
      };

      const handleSaveDeptSettings = async (newSettings) => {
        setLoading(true);
        try {
          await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveDeptSettings', settings: newSettings }) });
          setDeptSettings(newSettings);
        } catch (err) { setError('설정 저장에 실패했습니다.'); }
        setLoading(false);
      };

      const handleSendSelectedNotifications = async (items) => {
        setLoading(true);
        try {
          const response = await fetch(API_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'sendSelectedNotifications', items: items }) 
          });
          const result = await response.json();
          setLoading(false);
          return result;
        } catch (err) {
          setLoading(false);
          return { success: false, error: '발송에 실패했습니다.' };
        }
      };

      const handleAdminTabClick = (tab) => {
        if (isAdminAuth) {
          setActiveTab(tab);
        } else {
          setPendingAdminTab(tab);
          setShowAdminLogin(true);
        }
      };

      const handleAdminLogin = () => {
        // 특수 비밀번호: wndwl = 테스트 모드 (접수 차단), tlwkr = 정상 모드
        if (adminPassword === 'wndwl') {
          setTestMode(true);
          setIsAdminAuth(true);
          setShowAdminLogin(false);
          setActiveTab(pendingAdminTab);
          setPendingAdminTab(null);
          setAdminPassword('');
          return;
        }
        if (adminPassword === 'tlwkr') {
          setTestMode(false);
          setIsAdminAuth(true);
          setShowAdminLogin(false);
          setActiveTab(pendingAdminTab);
          setPendingAdminTab(null);
          setAdminPassword('');
          return;
        }
        if (adminPassword === settings.adminPassword || adminPassword === '1550612a') {
          setIsAdminAuth(true);
          setShowAdminLogin(false);
          setActiveTab(pendingAdminTab);
          setPendingAdminTab(null);
          setAdminPassword('');
        } else {
          alert('비밀번호가 일치하지 않습니다.');
        }
      };

      const handleChangePassword = async () => {
        if (newPassword !== confirmPassword) {
          alert('새 비밀번호가 일치하지 않습니다.');
          return;
        }
        if (newPassword.length < 4) {
          alert('비밀번호는 4자 이상이어야 합니다.');
          return;
        }
        const newSettings = { ...settings, adminPassword: newPassword };
        const saved = await saveSettingsToServer(newSettings);
        if (saved) {
          setShowChangePassword(false);
          setNewPassword('');
          setConfirmPassword('');
          alert('비밀번호가 변경되었습니다.');
        }
      };

      return (
        <div className="min-h-screen bg-gray-100">
          <header className="bg-white shadow-md border-b">
            <div className="max-w-4xl mx-auto px-4 py-3 flex items-center gap-3">
              <img src="data:image/webp;base64,UklGRlINAABXRUJQVlA4WAoAAAAwAAAAtAAAOAAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBIoQYAAAEkAUmKrIgILYm2bUOSTiIis9q2bdu2bdu2bdu2bdu2MbLd/QfR+eJHjHsQERMgi7Zt05FWnELQtm3btm3btm3btm3btm0b7yN596bfuFWjPyNiAiTbtm3azni2bdu2bdsu2bYd27Zt206KTjHf4FzUI2ICAN46nBzbb529Piwysm+lq+P3rSBCqpy9j33l5INaduQ16SX+NEGRNMFN3wcFEUi5N5awoKiL7mcgsHJa7jDgveGeqzEwyqAwYB2uuRcbw5wJAxq75ksajPM3pvL+xBIFijnRCgNpjZR3CnHpWQ4cMxtqpfL6yGY9cCAfhnpvU05Uu4bsqUphiSoUHMdYWgHl4GRGpdpZpIKmUu7Uiaz/ZGRY0kepbbo+uyQy7fqtaa+Gh/6Di8qxW1t2UqlPpqZNiDf/rfm9FkeqjZ4WV2nfI4li/VFKFdHUSaz8X033vEPG8VWvhdJ2IW6slFKjNRUUCnmpCfaQYZveBqW1lK2zXNIUS6iVJvrIJNNF75NDYX9iiYz3lr+x9ViENgppKWXS6WlFFXYMsTfqP/1aviF8Q6ysjOmF3gSFdZPpDfFD7K5YJRmW6l1TWDLXaFahw2LZpRroaYnU8lZ6AvfEFRok9NoiFUegrVpwd6gCQvF/iAxCimt6H8IBnYXoJXApJACT9ITF1mYx00Sdc7EJQFlFSVfKYmcXxtfxNVgI8u/4rmlXOtgJhPuX6urJlivhDh1abQnAa0dfgiOK+x1N5Hsj+RLQcVxOWKa/4o4jLqrEpXRoxY2TW3F9ZBNkU7VcsxnG9lFtGWUPZLe1aL0Mw0alPUWcVtlMruVXHsO0Udo0WR87HbVoTxIZJaXSSslO2dmhR7sVzyA8UsVbnS8Domiv39p8GQjx1ub1dAF6K+hv2ltpYflPfOKr+4+sDOpr2Edu666dO4uKNeoWuPgrgK59QGnBHziM/6Sz/k9uaf60Q1mgag2FvYX0RfNKhZ6BrLvFIrkDF/cQKFx9DpI3lf+gqu6nhOE/sQCQuIdAT6wI21MSiGAjsmExDACbyyfE4ifvDMiwVM9lx68t1MflBEwRfSKagOiHoKb0OaSNgob0T1Ky6zxBWXo44U8AWUW7HSCtITjHYxLpomfSogW7vKcik/8HFBsde92UU1UYOmd78rNUXz3iQCc8q6auP+IEujSCKZU4DSMKulZMPJfIepTaK4cfbo9n4cS9rcmxceo2Mm6cvB/wnMF0UfY5nNVzPrFwO4mmzcdcbkvLbl198InOG0j9Blkd9eVU7dt0pp6S3SvvKAmI/1Xv/sfKVpwO52LtSsCSUz42xVydklzz2FubNMsY2450S5lYipxHAFZtmLGtI7HXwt7Qxs1pnjP9LCY0J+MCRucn2g72elnIhtgsBIIvUqyPd/iv45Y5UevZU4fiVVqLMPvAHSV2X4czyjvsTA/CbV+jY7DZS0Cy7C9RJBoLc8FN76pUqcZsjpxtQqTzyZI1Gum5CE3ac8BN2T6cNpF/jM/VRAmrnaVidyzHqbkzCjRrxCEXFXqaLiRMWGgR6zubYUl/K74XWafNa/ZZ65+D7H7uSxE6zw1ZrPdwRtuv6xpRvdyTbM2Bm7KNbZaWZ00FpHU3gAs+wh9jZpYZcVfEWxqn5OExY8bkSLkSZuayHoEhRRIsh17VgOj7gfuMKEjaOdDkTm5mp7UfhmGFkp0ZPnx4YbzzDofimnY6gs/ZlDPgufV+MvphJEHnNLTkKV+G7Eb2mG5SP6lwQE3jHEeMkL7CoaWpqTEEdEEBwLgEZcYwstpMZpWeSu96UNzboDOcMDNNhx0RivWHg/GBciMg5h72umjSLGoCiizkuCXrZNjlqdYDcoakDmZe8RQuJlTzuTgjJTxf6U9fHlzTSByCA+Ze62FVIGsyptgTPUTMOI8hZDnPQdNLUK6EA4KXveaO1PQ8n47xxxIwpDtZNjM1D8HjNGuE+QRF14bWfw4wpLIl8foyXHJ4L2So05NGLUL30qo+5hM0nEC8/aatCUxboi5Ly+oEPrfXAd9Pw0QOwTsZToD7eO/F9YcCE7dM2XRRk75UXioqXirjo4bEQpqA+Odi7bR5VSmoOBma9ocEG1fNiMHEICk70y4J0fpg7jSu+kafwbt2zckPrdcNGGaNumJaP0uqlnRMSMyehCxZOjs+pdbOKEmh1TMq4LskD3A4Coz371pSYVgL5SkkN2+rXoD8YWhohH49ig/NNbuQc2p3FaK1HdRv5xO+3tSv3ZaQ8JczTzYL/z0BAFZQOCC6BAAAsB0AnQEqtQA5AD5RIo5FI6IhFglc8DgFBLMIoCVlH7/5oD90/qv4gXKjuPwD8me7gx3yX8Xfyn6aParvtk/fJ9+J/lP4y+5r+AfYB9APtA9wD9Ev89+onYA8wH7M+tr/Vf4B7AP1w/QD4AP69/fP//7Hf9v///uUf0b/AewB/EP876RH62/Ad+1/7r+zz///+37gH//9QD//uIGUDDBMp7sce76SewMhe2uXcOemfBZZS6hmTOz7yf0dSsmh7WIXAcd2+OAoUuEL29IJb7XL1SRwnBjjB17O+eHcW5HzlePagr0qiI2wW5gQGdO6OK/isSCjn+kAAP7w1vVocaqNfV6t5it8v2mFK+IhHCU8u5P8T//3xv/9xeEFwBaiUWsRZtvlwE81q8M2g30zYRgqH3LjwEt/kXNEQGnkwHyNKChaOAmD9ff3DvAkrrdoiBp/x2q2an03uV9/nDF3kpTNZpwsYOvHij4Xbc4f34wWiZULjg7FKbZ/xEt78vhlS6GlpkoOFLdnL8jDhjKS5xcxU/7B///IY//hwsUOlZZ/+8ZDX5zkk+pZYTFsg3szQnTKvdiO/RHEMsHmgXKtmO+ULOpZ8X/Ad7HCXZbuywYW8dTLZ7kXC1BMihoPAYP8bFnU1NZzp3fXR3nUFz3o7xkuztTcBMpKVdNVmwX/nkf/+Skq/xf/c7HLa/vU15v2FmrWCtdw7uggRG6gm83bi8YOQYAA77GoySc8yYeCLms7gCeCPY5ip9ef/mNcXuXCGvvpff//Hj//isDjAEXcACe2Ykb6sBT4uKagDose70wDOG2oIMWAvXHOeodQvETP/HfncG7KFq3Uuxm9Ax3chJLN+THu+lphdAEV/5UMy4ik/d95JXhFn689ZDixGLg0Xad3txYdM0SAR5AApD5ZLmCYB+5HrC3jr30APkCAzyUeLzBuUnMuFfQ+cH+nAA93gM2D1Q2W1j9519rJvT18RmDwAiX8ZHD7bcNxBUE4bc1UGSOoFP5kgo+YOEgVNRebdSN11EoXG8iFnxZB6ESt0dnYDVcMJdsNzy0if//JTkhfqkofI0gZ8MTe6wMzmPrKsgVSBS3sQyqgxTAB6OzSnGzxnIbFk/aTqsWYL7Zez1iOq3MSAvR3k7DJ0pPqT21VEAaUvwDOhPNqXXo3ilzSEef3p0ngDog7k+gAEyqJsF0fkzduTx6MxT0mgGK+/QXy5zF5GGAeKjuyBfYA1vTtz8/+uCP/3l59iV6uQFobBP/qXAZTechqRe7EbO9BVr8dnrOjZzk7YAN8xL5PWx8TdRpOpa1cEU499DrPKRmRY/5HAs6u0v2Eo3Vzbv1hXrhWhvISh1XymBHMuZdrtqfFTRSCpX9poAE7CtwWVzf9CKLNgBSafgwKMjwVYk5hKwrpcwgq2LVgBMclPU01+B2qhAgklCU4EoeGeuc0pxK+i1TsoiP4ouA/ya3Epdsp398UTwbWLyO+u48fQ6vE6Bvp2mkm07bqryqHQSLF9PW39rMDp9OhPWEBvbU+NZf6pv+Ito+F25DSQoZrPuiVvC4WmUzkgTfsN3iRXhOTJ6P51QFuabtr0Fg9Jcto4KdWCWpAyFEB0oY9yaavMdAAAA==" alt="EATON" style={{height: '32px', width: 'auto'}} />
              <h1 className="text-lg font-bold text-gray-800">SIO 관리시스템</h1>
            </div>
          </header>

          {error && (
            <div className="mx-4 mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-center">
              {error}<button onClick={() => setError(null)} className="ml-2 underline">닫기</button>
            </div>
          )}

          <main className="p-4 pb-24">
            {activeTab === 'submit' && <SubmitForm settings={settings} onSubmit={handleNewSubmission} loading={loading} />}
            {activeTab === 'list' && <SubmissionList submissions={submissions} loading={loading} onRefresh={fetchData} />}
            {activeTab === 'report' && <ReportTab submissions={submissions} loading={loading} onRefresh={fetchData} />}
            {activeTab === 'action' && <ActionTab submissions={submissions} settings={settings} deptSettings={deptSettings} onUpdate={handleUpdate} loading={loading} onRefresh={fetchData} />}
            {activeTab === 'help' && <HelpTab />}
            {activeTab === 'admin' && <AdminList submissions={submissions} settings={settings} onDelete={handleDelete} onUpdate={handleUpdate} loading={loading} onRefresh={fetchData} />}
            {activeTab === 'settings' && <SettingsPanel settings={settings} setSettings={setSettings} deptSettings={deptSettings} onSaveDeptSettings={handleSaveDeptSettings} onSendSelectedNotifications={handleSendSelectedNotifications} onSaveSettings={saveSettingsToServer} submissions={submissions} onRefresh={fetchData} />}
          </main>

          <nav className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
            <div className="flex justify-around">
              <NavButton icon="ClipboardList" label="접수" active={activeTab === 'submit'} onClick={() => setActiveTab('submit')} />
              <NavButton icon="List" label="목록" active={activeTab === 'list'} onClick={() => setActiveTab('list')} />
              <NavButton icon="BarChart3" label="보고서" active={activeTab === 'report'} onClick={() => setActiveTab('report')} />
              <NavButton icon="Wrench" label="조치" active={activeTab === 'action'} onClick={() => setActiveTab('action')} />
              <NavButton icon="HelpCircle" label="도움말" active={activeTab === 'help'} onClick={() => setActiveTab('help')} />
              <NavButton icon="Shield" label="관리" active={activeTab === 'admin'} onClick={() => handleAdminTabClick('admin')} />
              <NavButton icon="Settings" label="설정" active={activeTab === 'settings'} onClick={() => handleAdminTabClick('settings')} />
            </div>
          </nav>

          {/* 관리자 로그인 모달 */}
          {showAdminLogin && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                <h3 className="text-lg font-bold text-gray-800 mb-4 text-center flex items-center justify-center gap-2">
                  <Icon name="Lock" size={20} /> 관리자 인증
                </h3>
                <p className="text-sm text-gray-600 mb-4 text-center">관리자 비밀번호를 입력하세요</p>
                <input
                  type="password"
                  value={adminPassword}
                  onChange={(e) => setAdminPassword(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                  placeholder="비밀번호"
                  className="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center"
                  autoFocus
                />
                <div className="flex gap-2 mb-3">
                  <button onClick={() => { setShowAdminLogin(false); setAdminPassword(''); }} className="flex-1 py-3 border border-gray-300 rounded-lg text-gray-600">취소</button>
                  <button onClick={handleAdminLogin} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium">확인</button>
                </div>
                <button onClick={() => { setShowAdminLogin(false); setShowChangePassword(true); setAdminPassword(''); }} className="w-full text-sm text-gray-500 hover:text-blue-600">비밀번호 변경</button>
              </div>
            </div>
          )}

          {/* 비밀번호 변경 모달 */}
          {showChangePassword && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                <h3 className="text-lg font-bold text-gray-800 mb-4 text-center flex items-center justify-center gap-2">
                  <Icon name="Key" size={20} /> 비밀번호 변경
                </h3>
                <div className="space-y-3 mb-4">
                  <input
                    type="password"
                    value={adminPassword}
                    onChange={(e) => setAdminPassword(e.target.value)}
                    placeholder="현재 비밀번호"
                    className="w-full p-3 border border-gray-300 rounded-lg"
                  />
                  <input
                    type="password"
                    value={newPassword}
                    onChange={(e) => setNewPassword(e.target.value)}
                    placeholder="새 비밀번호"
                    className="w-full p-3 border border-gray-300 rounded-lg"
                  />
                  <input
                    type="password"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    placeholder="새 비밀번호 확인"
                    className="w-full p-3 border border-gray-300 rounded-lg"
                  />
                </div>
                <div className="flex gap-2">
                  <button onClick={() => { setShowChangePassword(false); setAdminPassword(''); setNewPassword(''); setConfirmPassword(''); }} className="flex-1 py-3 border border-gray-300 rounded-lg text-gray-600">취소</button>
                  <button onClick={() => {
                    if (adminPassword === settings.adminPassword || adminPassword === '1550612a') {
                      handleChangePassword();
                    } else {
                      alert('현재 비밀번호가 일치하지 않습니다.');
                    }
                  }} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium">변경</button>
                </div>
              </div>
            </div>
          )}

          {loading && (
            <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
              <div className="bg-white p-4 rounded-xl shadow-lg flex items-center gap-3">
                <div className="spinner"><Icon name="Loader2" size={24} /></div>
                <span>처리 중...</span>
              </div>
            </div>
          )}
        </div>
      );
    }

    function NavButton({ icon, label, active, onClick }) {
      return (
        <button onClick={onClick} className={`flex flex-col items-center py-2 px-2 ${active ? 'text-blue-600' : 'text-gray-500'}`}>
          <Icon name={icon} size={20} />
          <span className="text-xs mt-1">{label}</span>
        </button>
      );
    }

    function HelpTab() {
      const [openSection, setOpenSection] = React.useState('intro');

      const toggleSection = (section) => {
        setOpenSection(openSection === section ? null : section);
      };

      const Section = ({ id, title, icon, children }) => (
        <div className="bg-white rounded-xl shadow-md overflow-hidden mb-4">
          <button onClick={() => toggleSection(id)} className="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <Icon name={icon} size={20} className="text-blue-600" />
              </div>
              <span className="font-bold text-gray-800">{title}</span>
            </div>
            <Icon name={openSection === id ? 'ChevronUp' : 'ChevronDown'} size={20} className="text-gray-400" />
          </button>
          {openSection === id && <div className="px-4 pb-4 text-gray-600 text-sm leading-relaxed border-t">{children}</div>}
        </div>
      );

      return (
        <div className="space-y-4">
          <h2 className="text-lg font-bold text-gray-800 mb-4">도움말</h2>

          <Section id="intro" title="SIO 관리시스템이란?" icon="Info">
            <div className="pt-4 space-y-3">
              <p><strong>SIO (Safety Improvement Observation)</strong>는 작업장의 안전, 품질, 환경 관련 위험요소나 개선사항을 발견했을 때 신고하고 관리하는 시스템입니다.</p>
              <div className="bg-blue-50 p-3 rounded-lg">
                <p className="font-medium text-blue-800 mb-2">📌 SIO의 목적</p>
                <ul className="space-y-1 text-blue-700">
                  <li>• 사고 예방 및 안전한 작업환경 조성</li>
                  <li>• 환경 위험요소 제거</li>
                  <li>• 전 직원 참여형 안전문화 구축</li>
                </ul>
              </div>
            </div>
          </Section>

          <Section id="submit" title="SIO 접수 방법" icon="ClipboardList">
            <div className="pt-4 space-y-4">
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">1</span>
                <div>
                  <p className="font-medium text-gray-800">이름 입력</p>
                  <p className="text-gray-500">본인의 이름을 한글로 입력합니다. (4글자 이내, 리더/팀장 생략)</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">2</span>
                <div>
                  <p className="font-medium text-gray-800">부서 선택</p>
                  <p className="text-gray-500">본인의 소속 부서를 선택합니다.</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">3</span>
                <div>
                  <p className="font-medium text-gray-800">구분 선택</p>
                  <p className="text-gray-500">안전/품질/환경/기타 중 해당하는 항목을 선택합니다.</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">4</span>
                <div>
                  <p className="font-medium text-gray-800">장소 선택</p>
                  <p className="text-gray-500">문제가 발생한 장소를 선택합니다.</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">5</span>
                <div>
                  <p className="font-medium text-gray-800">내용 작성</p>
                  <p className="text-gray-500">발견한 위험요소나 개선사항을 상세히 작성합니다.</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">6</span>
                <div>
                  <p className="font-medium text-gray-800">사진 첨부 (필수)</p>
                  <p className="text-red-500">사진을 첨부하지 않으면 조치가 어렵습니다. 반드시 첨부해주세요!</p>
                </div>
              </div>
              <div className="bg-yellow-50 p-3 rounded-lg mt-4">
                <p className="font-medium text-yellow-800">💡 TIP</p>
                <p className="text-yellow-700">구체적인 위치와 상황을 작성하면 빠른 조치에 도움이 됩니다!</p>
              </div>
            </div>
          </Section>

          <Section id="list" title="목록 확인하기" icon="List">
            <div className="pt-4 space-y-3">
              <p>접수된 SIO 현황을 확인할 수 있습니다.</p>
              
              <div className="bg-gray-50 p-3 rounded-lg">
                <p className="font-medium text-gray-800 mb-2">📋 상태 필터</p>
                <p className="text-gray-600 text-sm">상단의 상태 버튼을 클릭하면 해당 상태의 SIO만 볼 수 있습니다.</p>
              </div>

              <div className="space-y-2">
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">접수완료</span>
                  <span className="text-gray-600">새로 접수되어 검토 대기 중</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs">조치중</span>
                  <span className="text-gray-600">담당부서에서 조치 진행 중</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">조치완료</span>
                  <span className="text-gray-600">조치 완료 (조치부서, 담당자, 내용, 사진 표시)</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs">기각</span>
                  <span className="text-gray-600">검토 결과 조치 불필요로 판정</span>
                </div>
              </div>
              <p className="mt-3">🔍 검색창에서 내용, 장소, 구분으로 검색할 수 있습니다.</p>
            </div>
          </Section>

          <Section id="report" title="보고서 보기" icon="BarChart3">
            <div className="pt-4 space-y-3">
              <p>SIO 통계를 확인할 수 있습니다.</p>
              <ul className="space-y-2">
                <li className="flex items-start gap-2">
                  <span className="text-blue-600">•</span>
                  <span><strong>부서별 접수현황:</strong> 월별로 각 부서의 SIO 접수 건수</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-600">•</span>
                  <span><strong>조치부서별 현황:</strong> 조치 완료/미완료 현황</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-600">•</span>
                  <span><strong>인원별 접수건수:</strong> 개인별 SIO 접수 순위</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-600">•</span>
                  <span><strong>조치담당자별:</strong> 조치완료 건수 순위</span>
                </li>
              </ul>
              <p className="mt-3">📊 오른쪽 상단 <strong>내보내기</strong> 버튼으로 엑셀 다운로드가 가능합니다.</p>
            </div>
          </Section>

          <Section id="action" title="조치하기 (담당자용)" icon="Wrench">
            <div className="pt-4 space-y-3">
              <p>본인 부서에 할당된 SIO를 조치합니다.</p>
              <div className="bg-gray-50 p-3 rounded-lg space-y-2">
                <p><strong>1.</strong> 해당 부서 버튼 클릭 (비밀번호 설정 시 입력)</p>
                <p><strong>2.</strong> 할당된 SIO 목록 확인</p>
                <p><strong>3.</strong> 조치담당자 이름 입력</p>
                <p><strong>4.</strong> 조치내용 상세 작성</p>
                <p><strong>5.</strong> 조치 후 사진 첨부 (권장)</p>
                <p><strong>6.</strong> [저장] 또는 [조치완료] 클릭</p>
              </div>
            </div>
          </Section>

          <Section id="faq" title="자주 묻는 질문" icon="MessageCircle">
            <div className="pt-4 space-y-4">
              <div>
                <p className="font-medium text-gray-800">Q. 접수한 SIO를 수정할 수 있나요?</p>
                <p className="text-gray-600 mt-1">A. 접수 후 수정은 관리자에게 요청해주세요.</p>
              </div>
              <div>
                <p className="font-medium text-gray-800">Q. 익명으로 접수할 수 있나요?</p>
                <p className="text-gray-600 mt-1">A. 현재 시스템은 실명 접수를 원칙으로 합니다.</p>
              </div>
              <div>
                <p className="font-medium text-gray-800">Q. 사진은 필수인가요?</p>
                <p className="text-gray-600 mt-1">A. 선택사항이지만, 첨부하면 정확한 상황 파악에 도움됩니다.</p>
              </div>
              <div>
                <p className="font-medium text-gray-800">Q. 기각이란 무엇인가요?</p>
                <p className="text-gray-600 mt-1">A. 검토 결과 조치가 불필요하거나 해당사항이 아닌 경우입니다. 비고에 사유가 기록됩니다.</p>
              </div>
            </div>
          </Section>

          <Section id="contact" title="문의하기" icon="Phone">
            <div className="pt-4 space-y-3">
              <p>시스템 관련 문의사항은 아래로 연락주세요.</p>
              <div className="bg-gray-50 p-4 rounded-lg space-y-3">
                <div>
                  <p className="font-medium text-gray-800 flex items-center gap-2"><Icon name="User" size={16} className="text-blue-500" /> 업무담당자</p>
                  <p className="flex items-center gap-2 mt-1 pl-6"><Icon name="Mail" size={14} className="text-gray-400" /> inheepark@eaton.com</p>
                </div>
                <div>
                  <p className="font-medium text-gray-800 flex items-center gap-2"><Icon name="Monitor" size={16} className="text-green-500" /> 시스템담당자</p>
                  <p className="flex items-center gap-2 mt-1 pl-6"><Icon name="Mail" size={14} className="text-gray-400" /> seminlee@eaton.com</p>
                </div>
              </div>
            </div>
          </Section>
        </div>
      );
    }

    function SubmitForm({ settings, onSubmit, loading }) {
      const [formData, setFormData] = React.useState({ name: '', department: '', category: '', location: '', content: '', photo: null, photo2: null });
      const [photoPreview, setPhotoPreview] = React.useState(null);
      const [photoPreview2, setPhotoPreview2] = React.useState(null);
      const [showSuccess, setShowSuccess] = React.useState(false);
      const [showNetworkError, setShowNetworkError] = React.useState(false);
      const [uploading, setUploading] = React.useState(false);
      const [uploadProgress, setUploadProgress] = React.useState({ loaded: 0, total: 0 });
      const [compressing, setCompressing] = React.useState(false);
      const [compressing2, setCompressing2] = React.useState(false);

      const formatBytes = (bytes) => {
        if (bytes === 0) return '0 B';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      };

      // 이미지 리사이즈 및 압축 함수
      const compressImage = (file, maxSize = 1280, quality = 0.85) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              
              // 최대 크기 제한
              if (width > height) {
                if (width > maxSize) {
                  height = Math.round((height * maxSize) / width);
                  width = maxSize;
                }
              } else {
                if (height > maxSize) {
                  width = Math.round((width * maxSize) / height);
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              // JPEG로 압축
              const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
              resolve(compressedBase64);
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };

      const handlePhotoChange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          setCompressing(true);
          const originalSize = file.size;
          
          // 이미지 압축
          const compressedBase64 = await compressImage(file, 1280, 0.85);
          const compressedSize = Math.round((compressedBase64.length * 3) / 4); // base64 크기 추정
          
          console.log(`사진1 압축: ${formatBytes(originalSize)} → ${formatBytes(compressedSize)}`);
          
          setPhotoPreview(compressedBase64);
          setFormData({ ...formData, photo: compressedBase64 });
          setCompressing(false);
        }
      };

      const handlePhoto2Change = async (e) => {
        const file = e.target.files[0];
        if (file) {
          setCompressing2(true);
          const originalSize = file.size;
          
          // 이미지 압축
          const compressedBase64 = await compressImage(file, 1280, 0.85);
          const compressedSize = Math.round((compressedBase64.length * 3) / 4);
          
          console.log(`사진2 압축: ${formatBytes(originalSize)} → ${formatBytes(compressedSize)}`);
          
          setPhotoPreview2(compressedBase64);
          setFormData({ ...formData, photo2: compressedBase64 });
          setCompressing2(false);
        }
      };

      const handleSubmit = async () => {
        if (!formData.name || !formData.department || !formData.category || !formData.location || !formData.content) {
          alert('모든 필수 항목을 입력해주세요.'); return;
        }
        if (!formData.photo && !formData.photo2) {
          alert('사진을 최소 한 장 이상 첨부해주세요.'); return;
        }
        setUploading(true);
        setUploadProgress({ loaded: 0, total: 0 });
        
        const result = await onSubmit(formData, (loaded, total) => {
          setUploadProgress({ loaded, total });
        });
        
        setUploading(false);
        
        // 테스트 모드일 때 전체화면 네트워크 에러 모달 표시
        if (result && result.testMode) {
          setShowNetworkError(true);
          return;
        }
        
        if (result && result.success) {
          setFormData({ name: '', department: '', category: '', location: '', content: '', photo: null, photo2: null });
          setPhotoPreview(null);
          setPhotoPreview2(null);
          setShowSuccess(true);
        }
      };

      return (
        <div className="bg-white rounded-xl shadow-md p-6">
          <h2 className="text-lg font-bold mb-6 text-gray-800">SIO 접수</h2>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">이름 * <span className="text-gray-400 text-xs">(한글만 입력, 리더/팀장 생략)</span></label>
              <input type="text" value={formData.name} onChange={(e) => {
                const value = e.target.value.replace(/[^ㄱ-ㅎㅏ-ㅣ가-힣]/g, '').slice(0, 4);
                setFormData({ ...formData, name: value });
              }}
                className="w-full p-3 border border-gray-300 rounded-lg" placeholder="이름을 입력하세요" maxLength={4} />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">부서 * <span className="text-gray-400 text-xs">(본인의 부서를 선택하세요)</span></label>
              <select value={formData.department} onChange={(e) => setFormData({ ...formData, department: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg bg-white">
                <option value="">부서를 선택하세요</option>
                {settings.departments.map((dept, idx) => <option key={idx} value={dept}>{dept}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">구분 *</label>
              <select value={formData.category} onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg bg-white">
                <option value="">구분을 선택하세요</option>
                {settings.categories.map((cat, idx) => <option key={idx} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">장소 *</label>
              <select value={formData.location} onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg bg-white">
                <option value="">장소를 선택하세요</option>
                {settings.locations.map((loc, idx) => <option key={idx} value={loc}>{loc}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">내용 *</label>
              <textarea value={formData.content} onChange={(e) => setFormData({ ...formData, content: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg h-32 resize-none" placeholder="상세 내용을 입력하세요" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">사진 첨부 * <span className="text-red-500 text-xs">(최소 1장 이상 필수)</span></label>
              <div className="grid grid-cols-2 gap-3">
                {/* 원거리 사진 */}
                <div>
                  {compressing ? (
                    <div className="flex flex-col items-center justify-center w-full h-36 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50">
                      <Icon name="Loader" size={24} className="text-blue-500 mb-1 spinner" />
                      <span className="text-xs text-blue-600">압축 중...</span>
                    </div>
                  ) : photoPreview ? (
                    <div className="relative">
                      <img src={photoPreview} alt="Preview" className="w-full h-36 object-cover rounded-lg" />
                      <button type="button" onClick={() => { setPhotoPreview(null); setFormData({ ...formData, photo: null }); }} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full"><Icon name="X" size={16} /></button>
                      <div className="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 py-0.5 rounded">
                        {formatBytes(Math.round((formData.photo?.length || 0) * 3 / 4))}
                      </div>
                    </div>
                  ) : (
                    <label className="flex flex-col items-center justify-center w-full h-36 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer hover:border-blue-500 bg-blue-50">
                      <Icon name="Mountain" size={28} className="text-blue-400 mb-1" />
                      <span className="text-xs text-blue-600 font-medium text-center px-2">장비/장소를 식별할 수 있는<br/>멀리서 찍은 사진</span>
                      <input type="file" accept="image/*" onChange={handlePhotoChange} className="hidden" />
                    </label>
                  )}
                </div>
                {/* 근거리 사진 */}
                <div>
                  {compressing2 ? (
                    <div className="flex flex-col items-center justify-center w-full h-36 border-2 border-dashed border-green-300 rounded-lg bg-green-50">
                      <Icon name="Loader" size={24} className="text-green-500 mb-1 spinner" />
                      <span className="text-xs text-green-600">압축 중...</span>
                    </div>
                  ) : photoPreview2 ? (
                    <div className="relative">
                      <img src={photoPreview2} alt="Preview2" className="w-full h-36 object-cover rounded-lg" />
                      <button type="button" onClick={() => { setPhotoPreview2(null); setFormData({ ...formData, photo2: null }); }} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full"><Icon name="X" size={16} /></button>
                      <div className="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 py-0.5 rounded">
                        {formatBytes(Math.round((formData.photo2?.length || 0) * 3 / 4))}
                      </div>
                    </div>
                  ) : (
                    <label className="flex flex-col items-center justify-center w-full h-36 border-2 border-dashed border-green-300 rounded-lg cursor-pointer hover:border-green-500 bg-green-50">
                      <Icon name="Search" size={28} className="text-green-400 mb-1" />
                      <span className="text-xs text-green-600 font-medium text-center px-2">가까이서 찍은 사진</span>
                      <input type="file" accept="image/*" onChange={handlePhoto2Change} className="hidden" />
                    </label>
                  )}
                </div>
              </div>
            </div>
            
            {/* 업로드 진행률 표시 */}
            {uploading && (
              <div className="bg-blue-50 rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-blue-700 flex items-center gap-2">
                    <Icon name="Upload" size={16} className="spinner" /> 업로드 중...
                  </span>
                  <span className="text-sm text-blue-600">
                    {formatBytes(uploadProgress.loaded)} / {formatBytes(uploadProgress.total)}
                  </span>
                </div>
                <div className="w-full bg-blue-200 rounded-full h-2">
                  <div 
                    className="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                    style={{ width: uploadProgress.total > 0 ? `${(uploadProgress.loaded / uploadProgress.total) * 100}%` : '0%' }}
                  ></div>
                </div>
                <p className="text-xs text-blue-500 mt-2 text-center">
                  {uploadProgress.total > 0 ? Math.round((uploadProgress.loaded / uploadProgress.total) * 100) : 0}% 완료
                </p>
              </div>
            )}
            
            <button type="button" onClick={handleSubmit} disabled={loading || uploading}
              className="w-full bg-blue-600 text-white py-4 rounded-lg font-bold hover:bg-blue-700 disabled:bg-gray-400">
              {uploading ? '업로드 중...' : '접수하기'}
            </button>
          </div>
          {showSuccess && <SuccessModal onClose={() => setShowSuccess(false)} />}
          {showNetworkError && <NetworkErrorModal onClose={() => setShowNetworkError(false)} />}
        </div>
      );
    }

    function SubmissionList({ submissions, loading, onRefresh }) {
      const [selectedPhoto, setSelectedPhoto] = React.useState(null);
      const [searchText, setSearchText] = React.useState('');
      const [statusFilter, setStatusFilter] = React.useState('');
      
      const getStatusColor = (status) => {
        switch (status) {
          case '조치완료': return 'bg-green-100 text-green-700';
          case '조치중': return 'bg-yellow-100 text-yellow-700';
          case '기각': return 'bg-red-100 text-red-700';
          default: return 'bg-blue-100 text-blue-700';
        }
      };

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        try {
          const str = String(dateStr);
          // "2025-12-05" 또는 "2025. 12. 5." 형식 처리
          const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
          if (match) {
            return match[1] + '/' + match[2].padStart(2, '0') + '/' + match[3].padStart(2, '0');
          }
          // Date 객체로 시도
          const date = new Date(str);
          if (!isNaN(date.getTime())) {
            return date.getFullYear() + '/' + String(date.getMonth() + 1).padStart(2, '0') + '/' + String(date.getDate()).padStart(2, '0');
          }
          return str.split(' ')[0]; // 시간 부분 제거
        } catch (e) {
          return String(dateStr).split(' ')[0];
        }
      };

      // 상태별 건수
      const statusCounts = {
        '': submissions.length,
        '접수완료': submissions.filter(s => s.status === '접수완료').length,
        '조치중': submissions.filter(s => s.status === '조치중').length,
        '조치완료': submissions.filter(s => s.status === '조치완료').length,
        '기각': submissions.filter(s => s.status === '기각').length
      };

      // 검색 및 상태 필터링
      const filteredSubmissions = submissions.filter(item => {
        // 상태 필터
        if (statusFilter && item.status !== statusFilter) return false;
        // 검색 필터
        if (!searchText.trim()) return true;
        const search = searchText.toLowerCase();
        const checkField = (field) => field && String(field).toLowerCase().includes(search);
        return (
          checkField(item.content) ||
          checkField(item.location) ||
          checkField(item.category) ||
          checkField(item.actionDept) ||
          checkField(item.actionContent)
        );
      });

      if (submissions.length === 0 && !loading) {
        return (
          <div className="bg-white rounded-xl shadow-md p-6 text-center">
            <Icon name="List" size={64} className="mx-auto text-gray-300 mb-4" />
            <p className="text-gray-500">접수된 SIO가 없습니다.</p>
            <button onClick={onRefresh} className="mt-4 text-blue-600 flex items-center gap-2 mx-auto"><Icon name="RefreshCw" size={16} /> 새로고침</button>
          </div>
        );
      }

      return (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="text-lg font-bold text-gray-800">접수 목록 ({filteredSubmissions.length}건)</h2>
            <button onClick={onRefresh} className="text-blue-600 p-2 hover:bg-blue-50 rounded-lg"><Icon name="RefreshCw" size={20} /></button>
          </div>

          {/* 상태 필터 탭 */}
          <div className="flex gap-2 overflow-x-auto pb-2">
            <button onClick={() => setStatusFilter('')} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${statusFilter === '' ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>전체 ({statusCounts['']})</button>
            <button onClick={() => setStatusFilter('접수완료')} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${statusFilter === '접수완료' ? 'bg-blue-600 text-white' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`}>접수완료 ({statusCounts['접수완료']})</button>
            <button onClick={() => setStatusFilter('조치중')} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${statusFilter === '조치중' ? 'bg-yellow-500 text-white' : 'bg-yellow-50 text-yellow-600 hover:bg-yellow-100'}`}>조치중 ({statusCounts['조치중']})</button>
            <button onClick={() => setStatusFilter('조치완료')} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${statusFilter === '조치완료' ? 'bg-green-600 text-white' : 'bg-green-50 text-green-600 hover:bg-green-100'}`}>조치완료 ({statusCounts['조치완료']})</button>
            <button onClick={() => setStatusFilter('기각')} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${statusFilter === '기각' ? 'bg-red-600 text-white' : 'bg-red-50 text-red-600 hover:bg-red-100'}`}>기각 ({statusCounts['기각']})</button>
          </div>
          
          {/* 검색창 */}
          <div className="relative">
            <Icon name="Search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
            <input 
              type="text" 
              value={searchText} 
              onChange={(e) => setSearchText(e.target.value)}
              placeholder="내용, 장소, 구분 검색..." 
              className="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            {searchText && (
              <button onClick={() => setSearchText('')} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                <Icon name="X" size={18} />
              </button>
            )}
          </div>
          
          {/* 검색 결과 없음 */}
          {filteredSubmissions.length === 0 && searchText && (
            <div className="bg-white rounded-xl shadow-md p-6 text-center">
              <Icon name="Search" size={48} className="mx-auto text-gray-300 mb-3" />
              <p className="text-gray-500">'{searchText}' 검색 결과가 없습니다.</p>
            </div>
          )}
          
          <div className="space-y-3">
            {filteredSubmissions.slice().reverse().map((item) => (
              <div key={item.id} className="bg-white rounded-xl shadow-md p-4">
                {/* 상태 표시 */}
                <div className="flex justify-between items-center mb-3">
                  <span className="text-sm"><span className="text-gray-500">상태 : </span><span className={`font-medium ${item.status === '조치완료' ? 'text-green-600' : item.status === '조치중' ? 'text-yellow-600' : item.status === '기각' ? 'text-red-600' : 'text-blue-600'}`}>{item.status}</span></span>
                  {item.actionDept && <span className="text-sm"><span className="text-gray-500">담당부서 : </span><span className="font-medium text-gray-800">{item.actionDept}</span></span>}
                </div>
                
                {/* 기본 정보 */}
                <div className="space-y-1 text-sm">
                  <div className="flex">
                    <span className="text-gray-500 w-16 flex-shrink-0">접수일자</span>
                    <span className="text-gray-700">{formatDate(item.date)}</span>
                  </div>
                  <div className="flex">
                    <span className="text-gray-500 w-16 flex-shrink-0">장소</span>
                    <span className="text-gray-700">{item.location}</span>
                  </div>
                  <div className="flex">
                    <span className="text-gray-500 w-16 flex-shrink-0">내용</span>
                    <span className="text-gray-700">{item.content}</span>
                  </div>
                  {item.status === '기각' && item.remarks && (
                    <div className="flex">
                      <span className="text-gray-500 w-16 flex-shrink-0">비고</span>
                      <span className="text-red-600 font-medium">{item.remarks}</span>
                    </div>
                  )}
                </div>
                
                {/* 접수 사진 - 두 장 */}
                {(item.photo || item.photo2) && (
                  <div className="mt-3 grid grid-cols-2 gap-2">
                    {item.photo && (
                      <div>
                        <p className="text-xs text-gray-500 mb-1">원거리</p>
                        <img src={convertDriveUrl(item.photo)} alt="원거리사진" onClick={() => setSelectedPhoto(item.photo)}
                          className="w-full h-32 object-cover rounded-lg cursor-pointer" />
                      </div>
                    )}
                    {item.photo2 && (
                      <div>
                        <p className="text-xs text-gray-500 mb-1">근거리</p>
                        <img src={convertDriveUrl(item.photo2)} alt="근거리사진" onClick={() => setSelectedPhoto(item.photo2)}
                          className="w-full h-32 object-cover rounded-lg cursor-pointer" />
                      </div>
                    )}
                  </div>
                )}
                
                {/* 조치 정보 - 조치완료일 때만 상세 표시 */}
                {item.status === '조치완료' && (item.actionDept || item.actionPerson || item.actionContent || item.actionPhoto) && (
                  <div className="mt-3 pt-3 border-t border-green-200 bg-green-50 -mx-4 -mb-4 px-4 pb-4 rounded-b-xl">
                    <p className="text-xs font-medium text-green-700 mb-2 flex items-center gap-1"><Icon name="CheckCircle" size={14} /> 조치 완료 정보</p>
                    <div className="space-y-1 text-sm">
                      {item.actionDept && (
                        <div className="flex">
                          <span className="text-green-600 w-16 flex-shrink-0">조치부서</span>
                          <span className="text-gray-700">{item.actionDept}</span>
                        </div>
                      )}
                      {item.actionPerson && (
                        <div className="flex">
                          <span className="text-green-600 w-16 flex-shrink-0">담당자</span>
                          <span className="text-gray-700">{item.actionPerson}</span>
                        </div>
                      )}
                      {item.actionContent && (
                        <div className="flex">
                          <span className="text-green-600 w-16 flex-shrink-0">조치내용</span>
                          <span className="text-gray-700">{item.actionContent}</span>
                        </div>
                      )}
                    </div>
                    {item.actionPhoto && (
                      <div className="mt-2">
                        <p className="text-xs text-green-600 mb-1">조치 사진</p>
                        <img src={convertDriveUrl(item.actionPhoto)} alt="조치사진" onClick={() => setSelectedPhoto(item.actionPhoto)}
                          className="w-full h-40 object-cover rounded-lg cursor-pointer" />
                      </div>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
          
          {selectedPhoto && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedPhoto(null)}>
              <div className="relative max-w-3xl max-h-full">
                <img src={convertDriveUrl(selectedPhoto)} alt="사진" className="max-w-full max-h-[80vh] object-contain rounded-lg bg-white" />
                <button onClick={() => setSelectedPhoto(null)} className="absolute top-2 right-2 bg-white text-gray-800 p-2 rounded-full shadow-lg"><Icon name="X" size={24} /></button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function ReportTab({ submissions, loading, onRefresh }) {
      const [selectedYear, setSelectedYear] = React.useState(new Date().getFullYear());
      const [selectedPieDept, setSelectedPieDept] = React.useState(null);
      
      // 날짜 파싱 함수
      const parseDate = (dateStr) => {
        if (!dateStr) return null;
        const str = String(dateStr);
        // "2025. 12. 5. 오후" 형식 처리
        const match = str.match(/(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
        if (match) {
          return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
        }
        // 일반 Date 파싱 시도
        const date = new Date(str);
        if (!isNaN(date.getTime())) {
          return date;
        }
        return null;
      };
      
      // 연도 목록 생성
      const years = [...new Set(submissions.map(s => {
        const date = parseDate(s.date);
        return date ? date.getFullYear() : new Date().getFullYear();
      }))].sort((a, b) => b - a);
      
      if (years.length === 0) years.push(new Date().getFullYear());
      
      // 연도별 필터링
      const filteredByYear = submissions.filter(s => {
        const date = parseDate(s.date);
        if (!date) return false;
        return date.getFullYear() === selectedYear;
      });

      // 1. 월별 부서별 접수 현황 (부서=행, 월=열)
      const getMonthlyDeptStats = () => {
        const stats = {};
        filteredByYear.forEach(s => {
          const date = parseDate(s.date);
          if (!date) return;
          const month = date.getMonth() + 1;
          const dept = s.department || '미지정';
          
          if (!stats[dept]) stats[dept] = {};
          if (!stats[dept][month]) stats[dept][month] = 0;
          stats[dept][month]++;
        });
        return stats;
      };

      // 2. 월별 조치부서별 미조치/조치완료 현황 (조치부서=행, 월=열)
      const getMonthlyActionDeptStats = () => {
        const stats = {};
        filteredByYear.forEach(s => {
          const date = parseDate(s.date);
          if (!date) return;
          const month = date.getMonth() + 1;
          const actionDept = s.actionDept;
          if (!actionDept) return;
          const status = s.status;
          
          if (!stats[actionDept]) stats[actionDept] = {};
          if (!stats[actionDept][month]) stats[actionDept][month] = { complete: 0, incomplete: 0 };
          
          if (status === '조치완료') {
            stats[actionDept][month].complete++;
          } else {
            stats[actionDept][month].incomplete++;
          }
        });
        return stats;
      };

      // 3. 인원별 접수건수 - 이름(부서) 형식, 접수/기각 구분
      const getPersonStats = () => {
        const stats = {};
        filteredByYear.forEach(s => {
          const name = s.name || '미지정';
          const dept = s.department || '';
          const key = dept ? `${name}(${dept})` : name;
          const isRejected = s.status === '기각';
          
          if (!stats[key]) stats[key] = { total: 0, rejected: 0 };
          stats[key].total++;
          if (isRejected) stats[key].rejected++;
        });
        return Object.entries(stats)
          .map(([name, data]) => [name, data.total - data.rejected, data.rejected, data.total])
          .sort((a, b) => b[3] - a[3]); // 총 건수 기준 정렬
      };

      // 4. 조치담당자별 조치완료 건수 - 이름(조치부서) 형식, 팀 구분 없음
      const getActionPersonStats = () => {
        const stats = {};
        filteredByYear.filter(s => s.status === '조치완료').forEach(s => {
          const actionPerson = s.actionPerson || '미지정';
          const actionDept = s.actionDept || '';
          const key = actionDept ? `${actionPerson}(${actionDept})` : actionPerson;
          if (!stats[key]) stats[key] = 0;
          stats[key]++;
        });
        return Object.entries(stats).sort((a, b) => b[1] - a[1]);
      };

      const monthlyDeptStats = getMonthlyDeptStats();
      const monthlyActionDeptStats = getMonthlyActionDeptStats();
      const personStats = getPersonStats();
      const actionPersonStats = getActionPersonStats();

      const months = [1,2,3,4,5,6,7,8,9,10,11,12];
      
      // 조치부서별 전체 통계 (원형 차트용)
      const deptTotals = {};
      Object.keys(monthlyActionDeptStats).forEach(dept => {
        const deptData = monthlyActionDeptStats[dept];
        const complete = months.reduce((sum, m) => sum + (deptData[m]?.complete || 0), 0);
        const incomplete = months.reduce((sum, m) => sum + (deptData[m]?.incomplete || 0), 0);
        deptTotals[dept] = { complete, incomplete, total: complete + incomplete };
      });
      const deptList = Object.entries(deptTotals).sort((a, b) => b[1].total - a[1].total);
      const pieColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'];
      const displayDepts = selectedPieDept ? deptList.filter(([d]) => d === selectedPieDept) : deptList;

      // 엑셀 내보내기 함수
      const exportToExcel = () => {
        const wb = XLSX.utils.book_new();

        // 1. 월별 부서별 접수 현황 시트
        const deptHeaders = ['부서', ...months.map(m => m + '월'), '합계'];
        const deptRows = Object.keys(monthlyDeptStats).map(dept => {
          const deptData = monthlyDeptStats[dept];
          const total = months.reduce((sum, m) => sum + (deptData[m] || 0), 0);
          return [dept, ...months.map(m => deptData[m] || 0), total];
        });
        const ws1 = XLSX.utils.aoa_to_sheet([deptHeaders, ...deptRows]);
        XLSX.utils.book_append_sheet(wb, ws1, '부서별 접수현황');

        // 2. 월별 조치부서별 조치 현황 시트
        const actionHeaders = ['조치부서', ...months.flatMap(m => [m + '월 완료', m + '월 미조치']), '완료 합계', '미조치 합계'];
        const actionRows = Object.keys(monthlyActionDeptStats).map(dept => {
          const deptData = monthlyActionDeptStats[dept];
          const totalComplete = months.reduce((sum, m) => sum + (deptData[m]?.complete || 0), 0);
          const totalIncomplete = months.reduce((sum, m) => sum + (deptData[m]?.incomplete || 0), 0);
          return [dept, ...months.flatMap(m => [deptData[m]?.complete || 0, deptData[m]?.incomplete || 0]), totalComplete, totalIncomplete];
        });
        const ws2 = XLSX.utils.aoa_to_sheet([actionHeaders, ...actionRows]);
        XLSX.utils.book_append_sheet(wb, ws2, '조치부서별 현황');

        // 3. 인원별 접수건수 시트 - 월별 + 접수/기각 구분
        const personMonthlyStats = {};
        filteredByYear.forEach(s => {
          const date = parseDate(s.date);
          if (!date) return;
          const month = date.getMonth() + 1;
          const name = s.name || '미지정';
          const dept = s.department || '';
          const key = name + '|||' + dept;
          const isRejected = s.status === '기각';
          
          if (!personMonthlyStats[key]) personMonthlyStats[key] = { name, dept, months: {}, rejected: {} };
          if (!personMonthlyStats[key].months[month]) personMonthlyStats[key].months[month] = 0;
          if (!personMonthlyStats[key].rejected[month]) personMonthlyStats[key].rejected[month] = 0;
          
          personMonthlyStats[key].months[month]++;
          if (isRejected) personMonthlyStats[key].rejected[month]++;
        });
        
        const personHeaders = ['부서', '이름', ...months.flatMap(m => [m + '월 접수', m + '월 기각']), '총 접수', '총 기각'];
        const personRows = Object.values(personMonthlyStats)
          .map(p => {
            const totalAll = months.reduce((sum, m) => sum + (p.months[m] || 0), 0);
            const totalRejected = months.reduce((sum, m) => sum + (p.rejected[m] || 0), 0);
            const totalAccepted = totalAll - totalRejected;
            return [p.dept, p.name, ...months.flatMap(m => [(p.months[m] || 0) - (p.rejected[m] || 0), p.rejected[m] || 0]), totalAccepted, totalRejected];
          })
          .sort((a, b) => (b[b.length-2] + b[b.length-1]) - (a[a.length-2] + a[a.length-1]));
        const ws3 = XLSX.utils.aoa_to_sheet([personHeaders, ...personRows]);
        XLSX.utils.book_append_sheet(wb, ws3, '인원별 접수건수');

        // 4. 조치담당자별 조치완료 건수 시트 - 월별
        const actionPersonMonthlyStats = {};
        filteredByYear.filter(s => s.status === '조치완료').forEach(s => {
          const date = parseDate(s.date);
          if (!date) return;
          const month = date.getMonth() + 1;
          const name = s.actionPerson || '미지정';
          const dept = s.actionDept || '';
          const key = name + '|||' + dept;
          
          if (!actionPersonMonthlyStats[key]) actionPersonMonthlyStats[key] = { name, dept, months: {} };
          if (!actionPersonMonthlyStats[key].months[month]) actionPersonMonthlyStats[key].months[month] = 0;
          actionPersonMonthlyStats[key].months[month]++;
        });
        
        const actionPersonHeaders = ['부서', '이름', ...months.map(m => m + '월'), '총 건수'];
        const actionPersonRows = Object.values(actionPersonMonthlyStats)
          .map(p => {
            const total = months.reduce((sum, m) => sum + (p.months[m] || 0), 0);
            return [p.dept, p.name, ...months.map(m => p.months[m] || 0), total];
          })
          .sort((a, b) => b[14] - a[14]); // 총 건수 기준 정렬
        const ws4 = XLSX.utils.aoa_to_sheet([actionPersonHeaders, ...actionPersonRows]);
        XLSX.utils.book_append_sheet(wb, ws4, '조치담당자별 완료건수');

        // 파일 다운로드
        XLSX.writeFile(wb, `SIO_보고서_${selectedYear}년.xlsx`);
      };

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-lg font-bold text-gray-800">보고서</h2>
            <div className="flex gap-2">
              <button onClick={exportToExcel} className="flex items-center gap-1 text-green-600 p-2 hover:bg-green-50 rounded-lg text-sm">
                <Icon name="Download" size={18} />
                <span>내보내기</span>
              </button>
              <button onClick={onRefresh} className="text-blue-600 p-2 hover:bg-blue-50 rounded-lg">
                <Icon name="RefreshCw" size={20} />
              </button>
            </div>
          </div>

          {/* 필터 - 연도만 */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <div className="flex gap-3 items-center">
              <label className="text-sm text-gray-600">연도 선택</label>
              <select value={selectedYear} onChange={(e) => setSelectedYear(Number(e.target.value))}
                className="p-2 border border-gray-300 rounded-lg text-sm">
                {years.map(y => <option key={y} value={y}>{y}년</option>)}
              </select>
            </div>
          </div>

          {/* 1. 월별 부서별 접수 현황 */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="Building" size={18} /> 월별 부서별 접수 현황
            </h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b bg-gray-50">
                    <th className="py-2 px-2 text-left text-gray-600 sticky left-0 bg-gray-50">부서</th>
                    {months.map(m => (
                      <th key={m} className="py-2 px-2 text-center text-gray-600 min-w-[40px]">{m}월</th>
                    ))}
                    <th className="py-2 px-2 text-center text-gray-600 font-bold">합계</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.keys(monthlyDeptStats).map(dept => {
                    const deptData = monthlyDeptStats[dept];
                    const total = months.reduce((sum, m) => sum + (deptData[m] || 0), 0);
                    return (
                      <tr key={dept} className="border-b hover:bg-gray-50">
                        <td className="py-2 px-2 font-medium sticky left-0 bg-white">{dept}</td>
                        {months.map(m => (
                          <td key={m} className="py-2 px-2 text-center">{deptData[m] || '-'}</td>
                        ))}
                        <td className="py-2 px-2 text-center font-bold text-blue-600">{total}</td>
                      </tr>
                    );
                  })}
                  {Object.keys(monthlyDeptStats).length === 0 && (
                    <tr><td colSpan={14} className="py-4 text-center text-gray-500">데이터가 없습니다.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>

          {/* 2. 월별 조치부서별 조치 현황 */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="CheckCircle" size={18} /> 월별 조치부서별 조치 현황
            </h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b bg-gray-50">
                    <th className="py-2 px-2 text-left text-gray-600 sticky left-0 bg-gray-50">조치부서</th>
                    {months.map(m => (
                      <th key={m} className="py-2 px-1 text-center text-gray-600 min-w-[60px]">
                        <div>{m}월</div>
                        <div className="flex text-xs">
                          <span className="flex-1 text-green-600">완</span>
                          <span className="flex-1 text-red-600">미</span>
                        </div>
                      </th>
                    ))}
                    <th className="py-2 px-2 text-center text-gray-600">합계</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.keys(monthlyActionDeptStats).map(dept => {
                    const deptData = monthlyActionDeptStats[dept];
                    const totalComplete = months.reduce((sum, m) => sum + (deptData[m]?.complete || 0), 0);
                    const totalIncomplete = months.reduce((sum, m) => sum + (deptData[m]?.incomplete || 0), 0);
                    return (
                      <tr key={dept} className="border-b hover:bg-gray-50">
                        <td className="py-2 px-2 font-medium sticky left-0 bg-white">{dept}</td>
                        {months.map(m => (
                          <td key={m} className="py-2 px-1 text-center">
                            <div className="flex text-xs">
                              <span className="flex-1 text-green-600">{deptData[m]?.complete || '-'}</span>
                              <span className="flex-1 text-red-600">{deptData[m]?.incomplete || '-'}</span>
                            </div>
                          </td>
                        ))}
                        <td className="py-2 px-2 text-center">
                          <span className="text-green-600 font-bold">{totalComplete}</span>
                          <span className="text-gray-400 mx-1">/</span>
                          <span className="text-red-600 font-bold">{totalIncomplete}</span>
                        </td>
                      </tr>
                    );
                  })}
                  {Object.keys(monthlyActionDeptStats).length === 0 && (
                    <tr><td colSpan={14} className="py-4 text-center text-gray-500">데이터가 없습니다.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>

          {/* 2-1. 연도 전체 조치부서별 조치율 (원형 차트) */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="PieChart" size={18} /> {selectedYear}년 조치부서별 조치율
            </h3>
            <p className="text-sm text-gray-500 mb-4">부서를 클릭하면 해당 부서만 표시됩니다</p>
            
            <div>
              {/* 부서 선택 버튼 */}
              <div className="flex flex-wrap gap-2 mb-4">
                <button 
                  onClick={() => setSelectedPieDept(null)}
                  className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${!selectedPieDept ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                >
                  전체
                </button>
                {deptList.map(([dept], idx) => (
                  <button 
                    key={dept}
                    onClick={() => setSelectedPieDept(selectedPieDept === dept ? null : dept)}
                    className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${selectedPieDept === dept ? 'text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                    style={selectedPieDept === dept ? { backgroundColor: pieColors[idx % pieColors.length] } : {}}
                  >
                    {dept}
                  </button>
                ))}
              </div>
              
              {/* 원형 차트들 */}
              <div className={`grid gap-4 ${displayDepts.length === 1 ? 'grid-cols-1 max-w-xs mx-auto' : 'grid-cols-2 md:grid-cols-3 lg:grid-cols-4'}`}>
                {displayDepts.map(([dept, data]) => {
                  const rate = data.total > 0 ? Math.round((data.complete / data.total) * 100) : 0;
                  const circumference = 2 * Math.PI * 36;
                  const strokeDasharray = `${(rate / 100) * circumference} ${circumference}`;
                  const colorIdx = deptList.findIndex(([d]) => d === dept);
                  const color = pieColors[colorIdx % pieColors.length];
                  
                  return (
                    <div 
                      key={dept} 
                      className={`flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors ${displayDepts.length === 1 ? 'py-6' : ''}`}
                      onClick={() => setSelectedPieDept(selectedPieDept === dept ? null : dept)}
                    >
                      <div className={`relative ${displayDepts.length === 1 ? 'w-40 h-40' : 'w-24 h-24'}`}>
                        <svg className="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                          <circle cx="50" cy="50" r="36" fill="none" stroke="#E5E7EB" strokeWidth="16" />
                          <circle 
                            cx="50" cy="50" r="36" fill="none" 
                            stroke={color}
                            strokeWidth="16" 
                            strokeDasharray={strokeDasharray}
                            strokeLinecap="round"
                            className="transition-all duration-500"
                          />
                        </svg>
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                          <span className={`font-bold ${displayDepts.length === 1 ? 'text-3xl' : 'text-lg'}`} style={{ color: color }}>{rate}%</span>
                        </div>
                      </div>
                      <div className="mt-2 text-center">
                        <p className={`font-medium text-gray-800 ${displayDepts.length === 1 ? 'text-lg' : 'text-sm'}`}>{dept}</p>
                        <p className={`text-gray-500 ${displayDepts.length === 1 ? 'text-base' : 'text-xs'}`}>
                          <span className="text-green-600 font-medium">{data.complete}</span>
                          <span className="mx-1">/</span>
                          <span>{data.total}건</span>
                        </p>
                      </div>
                    </div>
                  );
                })}
              </div>
              
              {deptList.length === 0 && (
                <p className="text-gray-500 text-center py-8">데이터가 없습니다.</p>
              )}
            </div>
          </div>

          {/* 3. 인원별 접수건수 */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="Users" size={18} /> 인원별 접수건수 ({selectedYear}년)
            </h3>
            <div className="space-y-2">
              {personStats.map(([name, accepted, rejected, total], idx) => (
                <div key={name} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                  <div className="flex items-center gap-2">
                    <span className="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs">{idx + 1}</span>
                    <span className="font-medium">{name}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-blue-600 font-bold">{accepted}건</span>
                    {rejected > 0 && (
                      <>
                        <span className="text-gray-400">/</span>
                        <span className="text-red-500 font-bold">{rejected}기각</span>
                      </>
                    )}
                  </div>
                </div>
              ))}
              {personStats.length === 0 && <p className="text-gray-500 text-center py-4">데이터가 없습니다.</p>}
            </div>
          </div>

          {/* 4. 조치담당자별 조치완료 건수 */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="UserCheck" size={18} /> 조치담당자별 조치완료 건수 ({selectedYear}년)
            </h3>
            <div className="space-y-2">
              {actionPersonStats.map(([name, count], idx) => (
                <div key={name} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                  <div className="flex items-center gap-2">
                    <span className="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs">{idx + 1}</span>
                    <span className="font-medium">{name}</span>
                  </div>
                  <span className="text-green-600 font-bold">{count}건</span>
                </div>
              ))}
              {actionPersonStats.length === 0 && <p className="text-gray-500 text-center py-4">데이터가 없습니다.</p>}
            </div>
          </div>
        </div>
      );
    }

    function ActionTab({ submissions, settings, deptSettings, onUpdate, loading, onRefresh }) {
      const [selectedDept, setSelectedDept] = React.useState(null);
      const [selectedPhoto, setSelectedPhoto] = React.useState(null);
      const [passwordDept, setPasswordDept] = React.useState(null);

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const str = String(dateStr);
        const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
        if (match) return match[1] + '/' + match[2].padStart(2, '0') + '/' + match[3].padStart(2, '0');
        return str.split(' ')[0];
      };

      const filteredSubmissions = selectedDept ? submissions.filter(s => s.actionDept === selectedDept) : [];
      const getStatusColor = (status) => {
        switch (status) {
          case '조치완료': return 'bg-green-100 text-green-700 border-green-300';
          case '조치중': return 'bg-yellow-100 text-yellow-700 border-yellow-300';
          case '기각': return 'bg-red-100 text-red-700 border-red-300';
          default: return 'bg-blue-100 text-blue-700 border-blue-300';
        }
      };

      const handleDeptClick = (dept) => {
        const deptSetting = deptSettings.find(d => d.department === dept);
        if (deptSetting && deptSetting.password) { setPasswordDept(dept); }
        else { setSelectedDept(dept); }
      };

      if (!selectedDept) {
        return (
          <div className="space-y-4">
            <h2 className="text-lg font-bold text-gray-800 text-center">조치</h2>
            <div className="bg-white rounded-xl shadow-md p-6">
              <p className="text-center text-gray-600 mb-6">해당 부서를 선택하세요</p>
              <div className="grid grid-cols-2 gap-3">
                {settings.departments.map((dept, idx) => {
                  const count = submissions.filter(s => s.actionDept === dept && s.status !== '조치완료').length;
                  const hasPassword = deptSettings.find(d => d.department === dept)?.password;
                  return (
                    <button key={idx} onClick={() => handleDeptClick(dept)}
                      className="p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-colors">
                      <div className="font-bold text-gray-800 flex items-center justify-center gap-1">
                        {dept}{hasPassword && <Icon name="Lock" size={14} className="text-gray-400" />}
                      </div>
                      {count > 0 && <div className="text-sm text-red-500 mt-1">미조치 {count}건</div>}
                    </button>
                  );
                })}
              </div>
            </div>
            {passwordDept && <PasswordModal department={passwordDept} deptSettings={deptSettings} onConfirm={() => { setSelectedDept(passwordDept); setPasswordDept(null); }} onCancel={() => setPasswordDept(null)} />}
          </div>
        );
      }

      return (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-2">
              <button onClick={() => setSelectedDept(null)} className="text-gray-500 p-2 hover:bg-gray-100 rounded-lg"><Icon name="ArrowLeft" size={20} /></button>
              <h2 className="text-lg font-bold text-gray-800">{selectedDept} 조치목록</h2>
            </div>
            <button onClick={onRefresh} className="text-blue-600 p-2 hover:bg-blue-50 rounded-lg"><Icon name="RefreshCw" size={20} /></button>
          </div>
          {filteredSubmissions.length === 0 ? (
            <div className="bg-white rounded-xl shadow-md p-6 text-center">
              <Icon name="CheckCircle" size={64} className="mx-auto text-green-300 mb-4" />
              <p className="text-gray-500">할당된 조치 항목이 없습니다.</p>
            </div>
          ) : (
            <div className="space-y-4">
              {filteredSubmissions.slice().reverse().map((item) => (
                <div key={item.id} className="bg-white rounded-xl shadow-md p-4">
                  <div className="flex justify-between items-start mb-3">
                    <div><span className={`inline-block px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(item.status)}`}>{item.status}</span></div>
                    <span className="text-sm bg-gray-100 px-2 py-1 rounded">{item.category}</span>
                  </div>
                  
                  {/* 기본 정보 */}
                  <div className="space-y-2 text-sm mb-3">
                    <div className="flex">
                      <span className="text-gray-500 w-20 flex-shrink-0">일자</span>
                      <span className="text-gray-700">{formatDate(item.date)}</span>
                    </div>
                    <div className="flex">
                      <span className="text-gray-500 w-20 flex-shrink-0">장소</span>
                      <span className="text-gray-700">{item.location}</span>
                    </div>
                    <div className="flex">
                      <span className="text-gray-500 w-20 flex-shrink-0">내용</span>
                      <span className="text-gray-700">{item.content}</span>
                    </div>
                  </div>
                  
                  {/* 접수 사진 - 두 장 */}
                  {(item.photo || item.photo2) && (
                    <div className="mb-3">
                      <p className="text-sm text-gray-500 mb-1">접수사진</p>
                      <div className="grid grid-cols-2 gap-2">
                        {item.photo && (
                          <div>
                            <p className="text-xs text-gray-400 mb-1">원거리</p>
                            <img src={convertDriveUrl(item.photo)} alt="원거리" onClick={() => setSelectedPhoto(item.photo)} className="w-full h-28 object-cover rounded-lg cursor-pointer" />
                          </div>
                        )}
                        {item.photo2 && (
                          <div>
                            <p className="text-xs text-gray-400 mb-1">근거리</p>
                            <img src={convertDriveUrl(item.photo2)} alt="근거리" onClick={() => setSelectedPhoto(item.photo2)} className="w-full h-28 object-cover rounded-lg cursor-pointer" />
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                  
                  {/* 요청사항 */}
                  {item.request && (
                    <div className="mb-3 p-3 bg-yellow-50 rounded-lg">
                      <p className="text-xs font-medium text-yellow-700 mb-1">요청사항</p>
                      <p className="text-sm text-gray-700 whitespace-pre-wrap">{item.request}</p>
                    </div>
                  )}
                  
                  {/* 첨부파일 */}
                  {item.attachment && (
                    <div className="mb-3">
                      <a href={item.attachment} target="_blank" className="inline-flex items-center gap-2 text-sm text-blue-600 hover:underline">
                        <Icon name="FileText" size={16} />첨부파일 보기
                      </a>
                    </div>
                  )}
                  
                  {/* 비고 */}
                  {item.remarks && (
                    <div className="mb-3 p-2 bg-gray-50 rounded-lg">
                      <p className="text-xs text-gray-500 mb-1">비고</p>
                      <p className="text-sm text-gray-700">{item.remarks}</p>
                    </div>
                  )}
                  
                  <div className="border-t pt-3 mt-3"><ActionForm item={item} onUpdate={onUpdate} /></div>
                </div>
              ))}
            </div>
          )}
          {selectedPhoto && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedPhoto(null)}>
              <div className="relative max-w-3xl max-h-full">
                <img src={convertDriveUrl(selectedPhoto)} alt="사진" className="max-w-full max-h-[80vh] object-contain rounded-lg bg-white" />
                <button onClick={() => setSelectedPhoto(null)} className="absolute top-2 right-2 bg-white text-gray-800 p-2 rounded-full shadow-lg"><Icon name="X" size={24} /></button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function ActionForm({ item, onUpdate }) {
      const [actionContent, setActionContent] = React.useState(item.actionContent || '');
      const [actionPerson, setActionPerson] = React.useState(item.actionPerson || '');
      const [actionPhotoPreview, setActionPhotoPreview] = React.useState(item.actionPhoto ? convertDriveUrl(item.actionPhoto) : null);
      const [newActionPhoto, setNewActionPhoto] = React.useState(null);
      const [saving, setSaving] = React.useState(false);
      const [compressing, setCompressing] = React.useState(false);

      // 이미지 리사이즈 및 압축 함수
      const compressImage = (file, maxSize = 1280, quality = 0.85) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              
              if (width > height) {
                if (width > maxSize) {
                  height = Math.round((height * maxSize) / width);
                  width = maxSize;
                }
              } else {
                if (height > maxSize) {
                  width = Math.round((width * maxSize) / height);
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };

      const handlePhotoChange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          setCompressing(true);
          const compressedBase64 = await compressImage(file, 1280, 0.85);
          setActionPhotoPreview(compressedBase64);
          setNewActionPhoto(compressedBase64);
          setCompressing(false);
        }
      };

      const handleSave = async () => {
        setSaving(true);
        const updateData = { actionContent, actionPerson, status: item.status === '접수완료' ? '조치중' : item.status };
        if (newActionPhoto) updateData.actionPhoto = newActionPhoto;
        await onUpdate(item.id, updateData);
        setSaving(false); setNewActionPhoto(null);
      };

      const handleComplete = async () => {
        if (!actionContent || !actionPerson) { alert('조치내용과 조치담당자를 입력해주세요.'); return; }
        setSaving(true);
        const updateData = { actionContent, actionPerson, status: '조치완료' };
        if (newActionPhoto) updateData.actionPhoto = newActionPhoto;
        await onUpdate(item.id, updateData);
        setSaving(false); setNewActionPhoto(null);
      };

      return (
        <div className="space-y-3">
          <div><label className="block text-sm font-medium text-gray-700 mb-1">조치담당자</label><input type="text" value={actionPerson} onChange={(e) => setActionPerson(e.target.value.replace(/[^ㄱ-ㅎㅏ-ㅣ가-힣]/g, ''))} className="w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="담당자 이름 (한글만)" /></div>
          <div><label className="block text-sm font-medium text-gray-700 mb-1">조치내용</label><textarea value={actionContent} onChange={(e) => setActionContent(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg text-sm h-20 resize-none" placeholder="조치 내용을 입력하세요" /></div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">조치사진</label>
            {compressing ? (
              <div className="flex flex-col items-center justify-center w-full h-20 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50">
                <Icon name="Loader" size={20} className="text-blue-500 spinner" />
                <span className="text-xs text-blue-600">압축 중...</span>
              </div>
            ) : actionPhotoPreview ? (
              <div className="relative"><img src={actionPhotoPreview} alt="조치사진" className="w-full h-32 object-cover rounded-lg" /><button type="button" onClick={() => { setActionPhotoPreview(null); setNewActionPhoto(null); }} className="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full"><Icon name="X" size={16} /></button></div>
            ) : (
              <label className="flex flex-col items-center justify-center w-full h-20 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-500"><Icon name="Camera" size={24} className="text-gray-400" /><span className="text-xs text-gray-500">사진 첨부</span><input type="file" accept="image/*" onChange={handlePhotoChange} className="hidden" /></label>
            )}
          </div>
          <div className="flex gap-2">
            <button onClick={handleSave} disabled={saving || compressing} className="flex-1 py-2 border border-blue-600 text-blue-600 rounded-lg font-medium hover:bg-blue-50 disabled:opacity-50">{saving ? '저장 중...' : '저장'}</button>
            <button onClick={handleComplete} disabled={saving || compressing} className="flex-1 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 disabled:opacity-50">조치완료</button>
          </div>
        </div>
      );
    }

    function AdminList({ submissions, settings, onDelete, onUpdate, loading, onRefresh }) {
      const [selectedPhoto, setSelectedPhoto] = React.useState(null);
      const [showFilter, setShowFilter] = React.useState(false);
      const [filters, setFilters] = React.useState({ department: '', category: '', location: '', status: '' });
      const [deleteTarget, setDeleteTarget] = React.useState(null);
      const [saving, setSaving] = React.useState(false);
      
      // 수정된 데이터 추적
      const [editedData, setEditedData] = React.useState({});
      const [attachmentFiles, setAttachmentFiles] = React.useState({});

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const str = String(dateStr);
        const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
        if (match) return match[1] + '/' + match[2].padStart(2, '0') + '/' + match[3].padStart(2, '0');
        return str.split(' ')[0];
      };

      const getStatusColor = (status) => {
        switch (status) {
          case '조치완료': return 'bg-green-100 text-green-700';
          case '조치중': return 'bg-yellow-100 text-yellow-700';
          case '기각': return 'bg-red-100 text-red-700';
          default: return 'bg-blue-100 text-blue-700';
        }
      };

      // 필드 값 가져오기 (수정된 값 우선)
      const getValue = (itemId, field, originalValue) => {
        if (editedData[itemId] && editedData[itemId][field] !== undefined) {
          return editedData[itemId][field];
        }
        return originalValue || '';
      };

      // 필드 수정
      const handleFieldChange = (itemId, field, value) => {
        let updates = { [field]: value };
        
        // 메일발송 체크 시 Target Date 자동 설정 (한달 뒤)
        if (field === 'emailSent' && value === true) {
          const targetDate = new Date();
          targetDate.setMonth(targetDate.getMonth() + 1);
          const targetDateStr = targetDate.toISOString().split('T')[0];
          updates.targetDate = targetDateStr;
        }
        
        // 조치완료 선택 시 Closed Date 자동 설정 (오늘)
        if (field === 'status' && value === '조치완료') {
          const today = new Date().toISOString().split('T')[0];
          updates.closedDate = today;
        }
        
        setEditedData(prev => ({
          ...prev,
          [itemId]: {
            ...prev[itemId],
            ...updates
          }
        }));
      };

      // 첨부파일 변경
      const handleAttachmentChange = (itemId, e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 10 * 1024 * 1024) {
            alert('파일 크기는 10MB 이하만 가능합니다.');
            return;
          }
          const reader = new FileReader();
          reader.onload = () => {
            setAttachmentFiles(prev => ({
              ...prev,
              [itemId]: { name: file.name, data: reader.result }
            }));
            setEditedData(prev => ({
              ...prev,
              [itemId]: { ...prev[itemId], _hasAttachment: true }
            }));
          };
          reader.readAsDataURL(file);
        }
      };

      // 변경사항 개수
      const changedCount = Object.keys(editedData).length;

      // 변경사항 초기화
      const handleCancel = () => {
        setEditedData({});
        setAttachmentFiles({});
      };

      // 사진 재첨부 (압축 포함)
      const compressImage = (file, maxSize = 1280, quality = 0.85) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              if (width > height) {
                if (width > maxSize) { height = Math.round((height * maxSize) / width); width = maxSize; }
              } else {
                if (height > maxSize) { width = Math.round((width * maxSize) / height); height = maxSize; }
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };

      const handlePhotoReplace = async (itemId, field, e) => {
        const file = e.target.files[0];
        if (file) {
          const compressedBase64 = await compressImage(file, 1280, 0.85);
          handleFieldChange(itemId, field, compressedBase64);
          // 두번째 사진도 같이 처리 (빈 값으로 설정하면 삭제)
          if (field === 'photo') {
            // photo 변경 시 물어보기
          }
        }
      };

      // 일괄 저장
      const handleApply = async () => {
        if (changedCount === 0) return;
        setSaving(true);
        try {
          for (const [itemId, changes] of Object.entries(editedData)) {
            const updateData = { ...changes };
            delete updateData._hasAttachment;
            if (attachmentFiles[itemId]) {
              updateData.attachment = attachmentFiles[itemId].data;
            }
            await onUpdate(itemId, updateData);
          }
          setEditedData({});
          setAttachmentFiles({});
          await onRefresh();
        } catch (err) {
          alert('저장에 실패했습니다.');
        }
        setSaving(false);
      };

      const filteredSubmissions = submissions.filter(item => {
        if (filters.department && item.department !== filters.department) return false;
        if (filters.category && item.category !== filters.category) return false;
        if (filters.location && item.location !== filters.location) return false;
        if (filters.status && item.status !== filters.status) return false;
        return true;
      });

      const activeFilterCount = Object.values(filters).filter(v => v !== '').length;

      if (submissions.length === 0 && !loading) {
        return (<div className="bg-white rounded-xl shadow-md p-6 text-center"><Icon name="Shield" size={64} className="mx-auto text-gray-300 mb-4" /><p className="text-gray-500">접수된 SIO가 없습니다.</p><button onClick={onRefresh} className="mt-4 text-blue-600 flex items-center gap-2 mx-auto"><Icon name="RefreshCw" size={16} /> 새로고침</button></div>);
      }

      return (
        <div className="space-y-4">
          {/* 헤더 */}
          <div className="flex justify-between items-center">
            <h2 className="text-lg font-bold text-gray-800">관리 목록 ({filteredSubmissions.length}건)</h2>
            <div className="flex gap-2">
              <button onClick={onRefresh} className="text-blue-600 p-2 hover:bg-blue-50 rounded-lg"><Icon name="RefreshCw" size={20} /></button>
              <button onClick={() => setShowFilter(!showFilter)} className={`flex items-center gap-2 px-3 py-2 rounded-lg font-medium transition-colors ${showFilter ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border'}`}>
                <Icon name="Filter" size={18} />필터{activeFilterCount > 0 && <span className="bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">{activeFilterCount}</span>}
              </button>
            </div>
          </div>

          {/* 변경사항 알림 바 */}
          {changedCount > 0 && (
            <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 flex justify-between items-center sticky top-0 z-10">
              <span className="text-orange-700 font-medium"><Icon name="AlertCircle" size={16} className="inline mr-2" />{changedCount}건의 변경사항이 있습니다</span>
              <div className="flex gap-2">
                <button onClick={handleCancel} className="px-4 py-1.5 text-gray-600 border border-gray-300 rounded-lg text-sm">취소</button>
                <button onClick={handleApply} disabled={saving} className="px-4 py-1.5 bg-blue-600 text-white rounded-lg text-sm font-medium disabled:opacity-50">{saving ? '저장 중...' : '적용'}</button>
              </div>
            </div>
          )}
          
          {/* 필터 */}
          {showFilter && (
            <div className="bg-white rounded-xl shadow-md p-4">
              <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-700 flex items-center gap-2"><Icon name="Filter" size={18} /> 필터 설정</h3><button onClick={() => setFilters({ department: '', category: '', location: '', status: '' })} className="flex items-center gap-1 text-sm text-gray-500"><Icon name="RotateCcw" size={14} /> 초기화</button></div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div><label className="block text-xs font-medium text-gray-600 mb-1">부서</label><select value={filters.department} onChange={(e) => setFilters({...filters, department: e.target.value})} className="w-full p-2 border rounded-lg text-sm bg-white"><option value="">전체</option>{settings.departments.map((d,i) => <option key={i} value={d}>{d}</option>)}</select></div>
                <div><label className="block text-xs font-medium text-gray-600 mb-1">구분</label><select value={filters.category} onChange={(e) => setFilters({...filters, category: e.target.value})} className="w-full p-2 border rounded-lg text-sm bg-white"><option value="">전체</option>{settings.categories.map((c,i) => <option key={i} value={c}>{c}</option>)}</select></div>
                <div><label className="block text-xs font-medium text-gray-600 mb-1">장소</label><select value={filters.location} onChange={(e) => setFilters({...filters, location: e.target.value})} className="w-full p-2 border rounded-lg text-sm bg-white"><option value="">전체</option>{settings.locations.map((l,i) => <option key={i} value={l}>{l}</option>)}</select></div>
                <div><label className="block text-xs font-medium text-gray-600 mb-1">조치여부</label><select value={filters.status} onChange={(e) => setFilters({...filters, status: e.target.value})} className="w-full p-2 border rounded-lg text-sm bg-white"><option value="">전체</option><option value="접수완료">접수완료</option><option value="조치중">조치중</option><option value="조치완료">조치완료</option><option value="기각">기각</option></select></div>
              </div>
            </div>
          )}

          {/* 테이블 */}
          <div className="bg-white rounded-xl shadow-md overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full min-w-[3000px]">
                <thead className="bg-gray-50 border-b"><tr>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">일자</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">이름</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">부서</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">구분</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">장소</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap w-32">내용</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">접수사진</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">조치여부</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">조치부서</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">조치담당</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap w-32">조치내용</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">조치사진</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap w-32">요청사항</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">첨부</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap w-24">비고</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">메일</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">삭제</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">RPN</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Impact</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Incident</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Hazard</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Top5</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">SIO Category</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">KAF</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Target Date</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Closed Date</th>
                </tr></thead>
                <tbody className="divide-y divide-gray-200">
                  {filteredSubmissions.length === 0 ? (<tr><td colSpan="17" className="px-3 py-8 text-center text-gray-500">필터 조건에 맞는 데이터가 없습니다.</td></tr>) : (
                    filteredSubmissions.slice().reverse().map((item) => {
                      const isEdited = editedData[item.id];
                      const formatDateForInput = (dateStr) => {
                        if (!dateStr) return '';
                        const str = String(dateStr);
                        const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
                        if (match) {
                          return match[1] + '-' + match[2].padStart(2,'0') + '-' + match[3].padStart(2,'0');
                        }
                        return '';
                      };
                      return (
                        <tr key={item.id} className={isEdited ? 'bg-orange-50' : 'hover:bg-gray-50'}>
                          <td className="px-2 py-2"><input type="date" value={getValue(item.id, 'date', formatDateForInput(item.date))} onChange={(e) => handleFieldChange(item.id, 'date', e.target.value)} className="w-28 p-1 border rounded text-xs" /></td>
                          <td className="px-2 py-2"><input type="text" value={getValue(item.id, 'name', item.name)} onChange={(e) => handleFieldChange(item.id, 'name', e.target.value)} className="w-16 p-1 border rounded text-xs" /></td>
                          <td className="px-2 py-2"><select value={getValue(item.id, 'department', item.department)} onChange={(e) => handleFieldChange(item.id, 'department', e.target.value)} className="w-20 p-1 border rounded text-xs bg-white"><option value="">-</option>{settings.departments.map((d,i) => <option key={i} value={d}>{d}</option>)}</select></td>
                          <td className="px-2 py-2"><select value={getValue(item.id, 'category', item.category)} onChange={(e) => handleFieldChange(item.id, 'category', e.target.value)} className="w-20 p-1 border rounded text-xs bg-white"><option value="">-</option>{settings.categories.map((c,i) => <option key={i} value={c}>{c}</option>)}</select></td>
                          <td className="px-2 py-2"><select value={getValue(item.id, 'location', item.location)} onChange={(e) => handleFieldChange(item.id, 'location', e.target.value)} className="w-24 p-1 border rounded text-xs bg-white"><option value="">-</option>{settings.locations.map((l,i) => <option key={i} value={l}>{l}</option>)}</select></td>
                          <td className="px-2 py-2"><textarea value={getValue(item.id, 'content', item.content)} onChange={(e) => handleFieldChange(item.id, 'content', e.target.value)} className="w-48 min-w-48 p-1 border rounded text-xs h-16 resize-y" /></td>
                          <td className="px-2 py-2">
                            <div className="flex flex-col gap-1">
                              {/* 원거리 사진 */}
                              <div className="flex items-center gap-1">
                                <span className="text-xs text-blue-500 w-8">원:</span>
                                {(editedData[item.id]?.photo !== undefined ? editedData[item.id].photo : item.photo) ? (
                                  <>
                                    <button onClick={() => setSelectedPhoto(editedData[item.id]?.photo || item.photo)} className="text-blue-500 hover:text-blue-700" title="원거리 보기"><Icon name="Image" size={14} /></button>
                                    <button onClick={() => handleFieldChange(item.id, 'photo', '')} className="text-red-400 hover:text-red-600" title="삭제"><Icon name="X" size={12} /></button>
                                  </>
                                ) : (
                                  <label className="cursor-pointer text-gray-400 hover:text-blue-600 text-xs"><Icon name="Upload" size={12} /><input type="file" accept="image/*" onChange={(e) => handlePhotoReplace(item.id, 'photo', e)} className="hidden" /></label>
                                )}
                              </div>
                              {/* 근거리 사진 */}
                              <div className="flex items-center gap-1">
                                <span className="text-xs text-green-500 w-8">근:</span>
                                {(editedData[item.id]?.photo2 !== undefined ? editedData[item.id].photo2 : item.photo2) ? (
                                  <>
                                    <button onClick={() => setSelectedPhoto(editedData[item.id]?.photo2 || item.photo2)} className="text-green-500 hover:text-green-700" title="근거리 보기"><Icon name="Image" size={14} /></button>
                                    <button onClick={() => handleFieldChange(item.id, 'photo2', '')} className="text-red-400 hover:text-red-600" title="삭제"><Icon name="X" size={12} /></button>
                                  </>
                                ) : (
                                  <label className="cursor-pointer text-gray-400 hover:text-green-600 text-xs"><Icon name="Upload" size={12} /><input type="file" accept="image/*" onChange={(e) => handlePhotoReplace(item.id, 'photo2', e)} className="hidden" /></label>
                                )}
                              </div>
                            </div>
                          </td>
                          <td className="px-2 py-2"><select value={getValue(item.id, 'status', item.status)} onChange={(e) => handleFieldChange(item.id, 'status', e.target.value)} className={`w-20 p-1 border rounded text-xs font-medium ${getStatusColor(getValue(item.id, 'status', item.status))}`}><option value="접수완료">접수완료</option><option value="조치중">조치중</option><option value="조치완료">조치완료</option><option value="기각">기각</option></select></td>
                          <td className="px-2 py-2"><select value={getValue(item.id, 'actionDept', item.actionDept)} onChange={(e) => handleFieldChange(item.id, 'actionDept', e.target.value)} className="w-24 p-1 border rounded text-xs bg-white"><option value="">-</option>{settings.departments.map((d,i) => <option key={i} value={d}>{d}</option>)}</select></td>
                          <td className="px-2 py-2"><input type="text" value={getValue(item.id, 'actionPerson', item.actionPerson)} onChange={(e) => handleFieldChange(item.id, 'actionPerson', e.target.value)} className="w-16 p-1 border rounded text-xs" /></td>
                          <td className="px-2 py-2"><textarea value={getValue(item.id, 'actionContent', item.actionContent)} onChange={(e) => handleFieldChange(item.id, 'actionContent', e.target.value)} className="w-48 min-w-48 p-1 border rounded text-xs h-16 resize-y" /></td>
                          <td className="px-2 py-2 text-center">
                            {(editedData[item.id]?.actionPhoto !== undefined ? editedData[item.id].actionPhoto : item.actionPhoto) ? (
                              <div className="flex items-center justify-center gap-1">
                                <button onClick={() => setSelectedPhoto(editedData[item.id]?.actionPhoto || item.actionPhoto)} className="text-green-500 hover:text-green-700" title="조치사진 보기"><Icon name="Image" size={14} /></button>
                                <button onClick={() => handleFieldChange(item.id, 'actionPhoto', '')} className="text-red-400 hover:text-red-600" title="삭제"><Icon name="X" size={12} /></button>
                              </div>
                            ) : (
                              <label className="cursor-pointer text-gray-400 hover:text-green-600"><Icon name="Upload" size={14} /><input type="file" accept="image/*" onChange={(e) => handlePhotoReplace(item.id, 'actionPhoto', e)} className="hidden" /></label>
                            )}
                          </td>
                          <td className="px-2 py-2"><textarea value={getValue(item.id, 'request', item.request)} onChange={(e) => handleFieldChange(item.id, 'request', e.target.value)} className="w-40 min-w-40 p-1 border rounded text-xs h-16 resize-y" /></td>
                          <td className="px-2 py-2 text-center">
                            {attachmentFiles[item.id] ? (
                              <span className="text-xs text-blue-600">{attachmentFiles[item.id].name.substring(0,8)}...</span>
                            ) : item.attachment ? (
                              <a href={item.attachment} target="_blank" className="text-purple-500 hover:text-purple-700"><Icon name="FileText" size={16} /></a>
                            ) : null}
                            <label className="cursor-pointer text-gray-400 hover:text-gray-600 ml-1"><Icon name="Paperclip" size={14} /><input type="file" onChange={(e) => handleAttachmentChange(item.id, e)} className="hidden" /></label>
                          </td>
                          <td className="px-2 py-2"><textarea value={getValue(item.id, 'remarks', item.remarks)} onChange={(e) => handleFieldChange(item.id, 'remarks', e.target.value)} className="w-40 min-w-40 p-1 border rounded text-xs h-16 resize-y" /></td>
                          <td className="px-2 py-2 text-center">
                            <input type="checkbox" checked={getValue(item.id, 'emailSent', item.emailSent)} onChange={(e) => handleFieldChange(item.id, 'emailSent', e.target.checked)} className="w-4 h-4 rounded" />
                          </td>
                          <td className="px-2 py-2 text-center"><button onClick={() => setDeleteTarget(item.id)} className="text-red-400 hover:text-red-600"><Icon name="Trash2" size={16} /></button></td>
                          {/* RPN - 자동계산 */}
                          <td className="px-2 py-2 text-center bg-yellow-50">
                            <span className={`text-sm font-bold ${(() => {
                              const impact = getValue(item.id, 'impact', item.impact);
                              const incident = getValue(item.id, 'incident', item.incident);
                              const impactVal = impact === 'Minor' ? 1 : impact === 'Moderate' ? 2 : impact === 'Significant' ? 5 : 0;
                              const incidentVal = incident === 'Observation' ? 1 : incident === 'Notification' ? 2 : incident === 'Reportable' ? 5 : 0;
                              const rpn = impactVal * incidentVal;
                              return rpn >= 10 ? 'text-red-600' : rpn >= 4 ? 'text-yellow-600' : 'text-green-600';
                            })()}`}>
                              {(() => {
                                const impact = getValue(item.id, 'impact', item.impact);
                                const incident = getValue(item.id, 'incident', item.incident);
                                const impactVal = impact === 'Minor' ? 1 : impact === 'Moderate' ? 2 : impact === 'Significant' ? 5 : 0;
                                const incidentVal = incident === 'Observation' ? 1 : incident === 'Notification' ? 2 : incident === 'Reportable' ? 5 : 0;
                                return impactVal * incidentVal || '-';
                              })()}
                            </span>
                          </td>
                          {/* Impact */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <select value={getValue(item.id, 'impact', item.impact)} onChange={(e) => handleFieldChange(item.id, 'impact', e.target.value)} className="w-24 p-1 border rounded text-xs bg-white">
                              <option value="">-</option>
                              <option value="Minor">Minor(1)</option>
                              <option value="Moderate">Moderate(2)</option>
                              <option value="Significant">Significant(5)</option>
                            </select>
                          </td>
                          {/* Incident */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <select value={getValue(item.id, 'incident', item.incident)} onChange={(e) => handleFieldChange(item.id, 'incident', e.target.value)} className="w-28 p-1 border rounded text-xs bg-white">
                              <option value="">-</option>
                              <option value="Observation">Observation(1)</option>
                              <option value="Notification">Notification(2)</option>
                              <option value="Reportable">Reportable(5)</option>
                            </select>
                          </td>
                          {/* Hazard */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <select value={getValue(item.id, 'hazard', item.hazard)} onChange={(e) => handleFieldChange(item.id, 'hazard', e.target.value)} className="w-32 p-1 border rounded text-xs bg-white">
                              <option value="">-</option>
                              <option value="1 General Environment">1 General Environment</option>
                              <option value="2 Air Emission">2 Air Emission</option>
                              <option value="3 Water Mgmt">3 Water Mgmt</option>
                              <option value="4 Waste Mgmt">4 Waste Mgmt</option>
                              <option value="5 Chemical Mgmt">5 Chemical Mgmt</option>
                              <option value="6 Hazardous Mat">6 Hazardous Mat</option>
                              <option value="7 Safety Mgmt">7 Safety Mgmt</option>
                              <option value="8 Process Safety">8 Process Safety</option>
                              <option value="9 Emergency Prep">9 Emergency Prep</option>
                              <option value="10 Occupational Health">10 Occupational Health</option>
                              <option value="Environment">Environment</option>
                            </select>
                          </td>
                          {/* Top5 */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <select value={getValue(item.id, 'top5', item.top5)} onChange={(e) => handleFieldChange(item.id, 'top5', e.target.value)} className="w-16 p-1 border rounded text-xs bg-white">
                              <option value="">-</option>
                              <option value="Yes">Yes</option>
                              <option value="No">No</option>
                            </select>
                          </td>
                          {/* SIO Category */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <select value={getValue(item.id, 'sioCategory', item.sioCategory)} onChange={(e) => handleFieldChange(item.id, 'sioCategory', e.target.value)} className="w-36 p-1 border rounded text-xs bg-white">
                              <option value="">-</option>
                              <option value="Equipment Condition">Equipment Condition</option>
                              <option value="Material/Equipment Movement">Material/Equipment Movement</option>
                              <option value="5S & Workcondition">5S & Workcondition</option>
                              <option value="STF">STF</option>
                              <option value="People Behavior">People Behavior</option>
                              <option value="PPE">PPE</option>
                              <option value="LOTO">LOTO</option>
                              <option value="Machine Guarding">Machine Guarding</option>
                              <option value="Electrical Safety">Electrical Safety</option>
                              <option value="Powered Industrial Truck">Powered Industrial Truck</option>
                              <option value="Chemical">Chemical</option>
                              <option value="Ergo">Ergo</option>
                              <option value="Environment">Environment</option>
                            </select>
                          </td>
                          {/* KAF */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <input type="number" value={getValue(item.id, 'kaf', item.kaf)} onChange={(e) => handleFieldChange(item.id, 'kaf', e.target.value)} className="w-16 p-1 border rounded text-xs text-center" />
                          </td>
                          {/* Target Date */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <input type="date" value={getValue(item.id, 'targetDate', item.targetDate)} onChange={(e) => handleFieldChange(item.id, 'targetDate', e.target.value)} className="w-28 p-1 border rounded text-xs" />
                          </td>
                          {/* Closed Date */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <input type="date" value={getValue(item.id, 'closedDate', item.closedDate)} onChange={(e) => handleFieldChange(item.id, 'closedDate', e.target.value)} className="w-28 p-1 border rounded text-xs" />
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>
          </div>

          {selectedPhoto && (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedPhoto(null)}><div className="relative max-w-3xl max-h-full"><img src={convertDriveUrl(selectedPhoto)} alt="사진" className="max-w-full max-h-[80vh] object-contain rounded-lg bg-white" /><button onClick={() => setSelectedPhoto(null)} className="absolute top-2 right-2 bg-white text-gray-800 p-2 rounded-full shadow-lg"><Icon name="X" size={24} /></button></div></div>)}
          {deleteTarget && <ConfirmModal message="정말 삭제하시겠습니까?" onConfirm={() => { onDelete(deleteTarget); setDeleteTarget(null); }} onCancel={() => setDeleteTarget(null)} />}
        </div>
      );
    }

    function SettingsPanel({ settings, setSettings, deptSettings, onSaveDeptSettings, onSendSelectedNotifications, onSaveSettings, submissions, onRefresh }) {
      const [newItem, setNewItem] = React.useState({ departments: '', categories: '', locations: '' });
      const [localDeptSettings, setLocalDeptSettings] = React.useState([]);
      const [alertModal, setAlertModal] = React.useState(null);
      const [showPasswords, setShowPasswords] = React.useState({});
      const [showEmailSender, setShowEmailSender] = React.useState(false);
      const [selectedDept, setSelectedDept] = React.useState('');
      const [selectedItems, setSelectedItems] = React.useState([]);
      const [sending, setSending] = React.useState(false);

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const str = String(dateStr);
        const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
        if (match) return match[1] + '/' + match[2].padStart(2, '0') + '/' + match[3].padStart(2, '0');
        return str.split(' ')[0];
      };

      React.useEffect(() => {
        const settingsMap = {};
        deptSettings.forEach(s => { settingsMap[s.department] = s; });
        setLocalDeptSettings(settings.departments.map(dept => ({
          department: dept,
          email: settingsMap[dept]?.email || '',
          password: settingsMap[dept]?.password || '',
          totalMembers: settingsMap[dept]?.totalMembers || ''
        })));
      }, [deptSettings, settings.departments]);

      const addItem = (key) => {
        if (newItem[key].trim()) {
          setSettings({ ...settings, [key]: [...settings[key], newItem[key].trim()] });
          setNewItem({ ...newItem, [key]: '' });
        }
      };

      const removeItem = (key, index) => setSettings({ ...settings, [key]: settings[key].filter((_, i) => i !== index) });

      const updateDeptSetting = (dept, field, value) => setLocalDeptSettings(localDeptSettings.map(s => s.department === dept ? { ...s, [field]: value } : s));

      const saveSettings = async () => {
        await onSaveDeptSettings(localDeptSettings);
        await onSaveSettings(settings);
        setAlertModal({ message: '설정이 저장되었습니다.', type: 'success' });
      };

      const getUnsentItems = (dept) => submissions.filter(s => s.actionDept === dept && !s.emailSent);
      const totalUnsentCount = submissions.filter(s => s.actionDept && !s.emailSent).length;
      const unsentItemsForDept = selectedDept ? getUnsentItems(selectedDept) : [];

      const toggleItem = (id) => {
        setSelectedItems(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
      };

      const toggleAll = () => {
        setSelectedItems(selectedItems.length === unsentItemsForDept.length ? [] : unsentItemsForDept.map(i => i.id));
      };

      const sendSelectedEmails = async () => {
        if (selectedItems.length === 0) { setAlertModal({ message: '발송할 항목을 선택해주세요.', type: 'error' }); return; }
        setSending(true);
        const itemsToSend = submissions.filter(s => selectedItems.includes(s.id));
        const result = await onSendSelectedNotifications(itemsToSend);
        setSending(false);
        if (result.success) {
          setAlertModal({ message: result.message, type: 'success' });
          setSelectedItems([]);
          await onRefresh();
        } else {
          setAlertModal({ message: result.error || '발송에 실패했습니다.', type: 'error' });
        }
      };

      const sections = [
        { key: 'departments', label: '부서 (접수/조치 공용)' },
        { key: 'categories', label: '구분' },
        { key: 'locations', label: '장소' }
      ];

      return (
        <div className="space-y-6">
          <h2 className="text-lg font-bold text-gray-800">설정</h2>

          {/* 부서 설정 (이메일/비밀번호/총인원) */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Icon name="Building" size={20} /> 부서별 설정</h3>
            <div className="space-y-3">
              {localDeptSettings.map((item, idx) => (
                <div key={idx} className="border border-gray-200 rounded-lg p-3">
                  <div className="flex items-center gap-2 mb-2">
                    <span className="font-medium text-gray-700">{item.department}</span>
                    {getUnsentItems(item.department).length > 0 && <span className="bg-orange-500 text-white text-xs rounded-full px-2 py-0.5">미발송 {getUnsentItems(item.department).length}</span>}
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <div className="flex items-center gap-2">
                      <Icon name="Mail" size={14} className="text-gray-400 flex-shrink-0" />
                      <input type="email" value={item.email} onChange={(e) => updateDeptSetting(item.department, 'email', e.target.value)}
                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm" placeholder="이메일" />
                    </div>
                    <div className="flex items-center gap-2">
                      <Icon name="Lock" size={14} className="text-gray-400 flex-shrink-0" />
                      <div className="flex-1 relative">
                        <input type={showPasswords[item.department] ? 'text' : 'password'} value={item.password} onChange={(e) => updateDeptSetting(item.department, 'password', e.target.value)}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm pr-8" placeholder="비밀번호" />
                        <button type="button" onClick={() => setShowPasswords({ ...showPasswords, [item.department]: !showPasswords[item.department] })}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400"><Icon name={showPasswords[item.department] ? 'EyeOff' : 'Eye'} size={16} /></button>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <Icon name="Users" size={14} className="text-gray-400 flex-shrink-0" />
                      <input type="number" value={item.totalMembers} onChange={(e) => updateDeptSetting(item.department, 'totalMembers', e.target.value)}
                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm" placeholder="총인원" />
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* 메일 발송 */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-gray-700 flex items-center gap-2">
                <Icon name="Mail" size={20} /> 메일 발송
                {totalUnsentCount > 0 && <span className="bg-orange-500 text-white text-xs rounded-full px-2 py-0.5">미발송 {totalUnsentCount}건</span>}
              </h3>
              <button onClick={() => setShowEmailSender(!showEmailSender)} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium ${showEmailSender ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600'}`}>
                <Icon name="Send" size={16} /> {showEmailSender ? '닫기' : '발송하기'}
              </button>
            </div>

            {showEmailSender && (
              <div className="space-y-4 border-t pt-4">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-2">조치부서 선택</label>
                  <div className="flex flex-wrap gap-2">
                    {settings.departments.map((dept, idx) => {
                      const count = getUnsentItems(dept).length;
                      return (
                        <button key={idx} onClick={() => { setSelectedDept(dept); setSelectedItems([]); }}
                          className={`px-3 py-2 rounded-lg text-sm font-medium border ${selectedDept === dept ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300'}`}>
                          {dept} {count > 0 && <span className="ml-1 bg-orange-500 text-white rounded-full px-1.5 text-xs">{count}</span>}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {selectedDept && (
                  <div className="border border-gray-200 rounded-lg p-3">
                    <div className="flex justify-between items-center mb-3">
                      <span className="font-medium text-gray-700">{selectedDept} 미발송 목록 ({unsentItemsForDept.length}건)</span>
                      {unsentItemsForDept.length > 0 && (
                        <button onClick={toggleAll} className="text-sm text-blue-600">{selectedItems.length === unsentItemsForDept.length ? '전체 해제' : '전체 선택'}</button>
                      )}
                    </div>
                    {unsentItemsForDept.length === 0 ? (
                      <p className="text-gray-500 text-sm text-center py-4">미발송 항목이 없습니다.</p>
                    ) : (
                      <div className="space-y-2 max-h-60 overflow-y-auto">
                        {unsentItemsForDept.map(item => (
                          <label key={item.id} className={`flex items-start gap-3 p-2 rounded-lg cursor-pointer ${selectedItems.includes(item.id) ? 'bg-blue-50 border border-blue-200' : 'bg-gray-50'}`}>
                            <input type="checkbox" checked={selectedItems.includes(item.id)} onChange={() => toggleItem(item.id)} className="mt-1 w-4 h-4" />
                            <div className="flex-1 text-sm">
                              <div className="text-gray-600">{formatDate(item.date)} | {item.location}</div>
                              <div className="text-gray-800">{item.content}</div>
                              {item.request && <div className="text-yellow-600 text-xs">요청: {item.request}</div>}
                            </div>
                          </label>
                        ))}
                      </div>
                    )}
                    {unsentItemsForDept.length > 0 && (
                      <button onClick={sendSelectedEmails} disabled={sending || selectedItems.length === 0}
                        className="w-full mt-3 py-2 bg-orange-500 text-white rounded-lg font-medium disabled:opacity-50 flex items-center justify-center gap-2">
                        {sending ? <><Icon name="Loader" size={16} className="spinner" /> 발송 중...</> : <><Icon name="Send" size={16} /> 선택 항목 메일 발송 ({selectedItems.length}건)</>}
                      </button>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* 저장 버튼 */}
          <button onClick={saveSettings} className="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 flex items-center justify-center gap-2">
            <Icon name="Save" size={18} /> 설정 저장
          </button>

          {/* 목록 관리 */}
          {sections.map(({ key, label }) => (
            <div key={key} className="bg-white rounded-xl shadow-md p-4">
              <h3 className="font-bold text-gray-700 mb-3">{label} 목록</h3>
              <div className="flex gap-2 mb-3">
                <input type="text" value={newItem[key]} onChange={(e) => setNewItem({ ...newItem, [key]: e.target.value })}
                  className="flex-1 p-2 border border-gray-300 rounded-lg text-sm" placeholder={`새 항목 추가`}
                  onKeyPress={(e) => e.key === 'Enter' && addItem(key)} />
                <button onClick={() => addItem(key)} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"><Icon name="Plus" size={20} /></button>
              </div>
              <div className="space-y-2">
                {(settings[key] || []).map((item, idx) => (
                  <div key={idx} className="flex items-center justify-between bg-gray-50 p-2 rounded-lg">
                    <span className="text-sm text-gray-700">{item}</span>
                    <button onClick={() => removeItem(key, idx)} className="text-red-400 hover:text-red-600"><Icon name="Trash2" size={16} /></button>
                  </div>
                ))}
              </div>
            </div>
          ))}

          {alertModal && <AlertModal message={alertModal.message} type={alertModal.type} onClose={() => setAlertModal(null)} />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
