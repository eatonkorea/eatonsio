<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIO ì ‘ìˆ˜ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
    .pop-in { animation: popIn 0.4s ease-out; }
    @keyframes checkmark { 0% { stroke-dashoffset: 100; } 100% { stroke-dashoffset: 0; } }
    .checkmark-circle { animation: popIn 0.4s ease-out; }
    .checkmark-check { stroke-dasharray: 100; animation: checkmark 0.6s ease-out 0.3s forwards; stroke-dashoffset: 100; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const API_URL = 'https://script.google.com/macros/s/AKfycbyaJ2afcct-sLCQ9pAG2HPf78o0rGZZHTvwP4QAWRAb_puRdwOFWNCWdQQNx74tdbfPSw/exec';

    const convertDriveUrl = (url) => {
      if (!url) return '';
      const match = url.match(/[?&]id=([^&]+)/);
      if (match) return `https://lh3.googleusercontent.com/d/${match[1]}`;
      return url;
    };

    const Icon = ({ name, size = 24, className = "" }) => {
      const ref = React.useRef();
      React.useEffect(() => {
        if (ref.current) {
          ref.current.innerHTML = '';
          const icon = lucide.createElement(lucide.icons[name]);
          icon.setAttribute('width', size);
          icon.setAttribute('height', size);
          if (className) icon.setAttribute('class', className);
          ref.current.appendChild(icon);
        }
      }, [name, size, className]);
      return <span ref={ref} className="inline-flex items-center justify-center"></span>;
    };

    function SuccessModal({ onClose }) {
      React.useEffect(() => { const timer = setTimeout(onClose, 2500); return () => clearTimeout(timer); }, [onClose]);
      return (
        <div className="fixed inset-0 bg-green-500 flex flex-col items-center justify-center z-50" onClick={onClose}>
          <div className="pop-in flex flex-col items-center">
            <svg className="w-32 h-32 mb-6" viewBox="0 0 100 100">
              <circle className="checkmark-circle" cx="50" cy="50" r="45" fill="none" stroke="white" strokeWidth="6"/>
              <path className="checkmark-check" d="M30 50 L45 65 L70 35" fill="none" stroke="white" strokeWidth="6" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
            <h1 className="text-white text-3xl font-bold mb-2">ì ‘ìˆ˜ ì™„ë£Œ!</h1>
            <p className="text-green-100 text-lg">SIOê°€ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</p>
          </div>
          <p className="absolute bottom-10 text-green-200 text-sm">í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ë‹«í™ë‹ˆë‹¤</p>
        </div>
      );
    }

    function NetworkErrorModal({ onClose }) {
      React.useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
      return (
        <div className="fixed inset-0 bg-red-500 flex flex-col items-center justify-center z-50" onClick={onClose}>
          <div className="pop-in flex flex-col items-center">
            <svg className="w-32 h-32 mb-6" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" fill="none" stroke="white" strokeWidth="6"/>
              <path d="M35 35 L65 65 M65 35 L35 65" fill="none" stroke="white" strokeWidth="6" strokeLinecap="round"/>
            </svg>
            <h1 className="text-white text-3xl font-bold mb-2 text-center">ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤</h1>
            <p className="text-red-100 text-lg">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”</p>
          </div>
          <p className="absolute bottom-10 text-red-200 text-sm">í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ë‹«í™ë‹ˆë‹¤</p>
        </div>
      );
    }

    function ConfirmModal({ message, onConfirm, onCancel }) {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 max-w-sm w-full">
            <p className="text-gray-800 text-center mb-6">{message}</p>
            <div className="flex gap-3">
              <button onClick={onCancel} className="flex-1 py-3 border border-gray-300 rounded-lg text-gray-600 font-medium">ì·¨ì†Œ</button>
              <button onClick={onConfirm} className="flex-1 py-3 bg-red-500 text-white rounded-lg font-medium">ì‚­ì œ</button>
            </div>
          </div>
        </div>
      );
    }

    function AlertModal({ message, onClose, type = 'info' }) {
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 max-w-sm w-full">
            <div className={`w-16 h-16 ${bgColor} rounded-full flex items-center justify-center mx-auto mb-4`}>
              <Icon name={type === 'success' ? 'Check' : type === 'error' ? 'X' : 'Mail'} size={32} className="text-white" />
            </div>
            <p className="text-gray-800 text-center mb-6">{message}</p>
            <button onClick={onClose} className="w-full py-3 bg-gray-800 text-white rounded-lg font-medium">í™•ì¸</button>
          </div>
        </div>
      );
    }

    function PasswordModal({ department, deptSettings, onConfirm, onCancel }) {
      const [password, setPassword] = React.useState('');
      const [error, setError] = React.useState(false);

      const handleSubmit = () => {
        // ë¡œì»¬ì—ì„œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (ì„œë²„ í˜¸ì¶œ ì—†ìŒ)
        const deptInfo = deptSettings.find(d => d.department === department);
        if (deptInfo && deptInfo.password === password) {
          onConfirm();
        } else {
          setError(true);
          setPassword('');
        }
      };

      const handleKeyDown = (e) => { if (e.key === 'Enter') handleSubmit(); };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 max-w-sm w-full">
            <div className="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <Icon name="Lock" size={32} className="text-white" />
            </div>
            <h3 className="text-lg font-bold text-center text-gray-800 mb-2">{department}</h3>
            <p className="text-gray-500 text-center text-sm mb-4">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={handleKeyDown}
              className={`w-full p-3 border rounded-lg mb-3 text-center text-lg tracking-widest ${error ? 'border-red-500 bg-red-50' : 'border-gray-300'}`}
              placeholder="â€¢â€¢â€¢â€¢" autoFocus />
            {error && <p className="text-red-500 text-sm text-center mb-3">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>}
            <div className="flex gap-3">
              <button onClick={onCancel} className="flex-1 py-3 border border-gray-300 rounded-lg text-gray-600 font-medium">ì·¨ì†Œ</button>
              <button onClick={handleSubmit} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium">í™•ì¸</button>
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const [activeTab, setActiveTab] = React.useState('submit');
      const [submissions, setSubmissions] = React.useState([]);
      const [loading, setLoading] = React.useState(false);
      const [error, setError] = React.useState(null);
      const [isAdminAuth, setIsAdminAuth] = React.useState(false);
      const [showAdminLogin, setShowAdminLogin] = React.useState(false);
      const [pendingAdminTab, setPendingAdminTab] = React.useState(null);
      const [adminPassword, setAdminPassword] = React.useState('');
      const [showChangePassword, setShowChangePassword] = React.useState(false);
      const [newPassword, setNewPassword] = React.useState('');
      const [confirmPassword, setConfirmPassword] = React.useState('');
      const [testMode, setTestMode] = React.useState(false); // í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ì ‘ìˆ˜ ì°¨ë‹¨)
      
      const defaultSettings = {
        departments: ['ìƒì‚°íŒ€', 'í’ˆì§ˆíŒ€', 'ì•ˆì „íŒ€', 'ê´€ë¦¬íŒ€', 'ì‹œì„¤íŒ€', 'í™˜ê²½íŒ€'],
        categories: ['ì•ˆì „', 'í’ˆì§ˆ', 'í™˜ê²½', 'ê¸°íƒ€'],
        locations: ['ìƒì‚°1ë¼ì¸', 'ìƒì‚°2ë¼ì¸', 'ì‚¬ë¬´ì‹¤', 'ì°½ê³ ', 'ì•¼ì™¸'],
        adminPassword: 'eaton12!@'
      };
      
      const [settings, setSettings] = React.useState(defaultSettings);

      const [deptSettings, setDeptSettings] = React.useState([]);

      const fetchData = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch(API_URL);
          const result = await response.json();
          if (result.success) {
            const formattedData = result.data.map(item => ({
              id: item.ID || item.id,
              date: item['ì ‘ìˆ˜ì¼ì'] || item.date,
              name: item['ì´ë¦„'] || item.name,
              department: item['ë¶€ì„œ'] || item.department,
              category: item['êµ¬ë¶„'] || item.category,
              location: item['ì¥ì†Œ'] || item.location,
              content: item['ë‚´ìš©'] || item.content,
              status: item['ì¡°ì¹˜ì—¬ë¶€'] || item.status,
              actionDept: item['ì¡°ì¹˜ë¶€ì„œ'] || item.actionDept || '',
              actionPerson: item['ì¡°ì¹˜ë‹´ë‹¹ì'] || item.actionPerson || '',
              actionContent: item['ì¡°ì¹˜ë‚´ìš©'] || item.actionContent || '',
              actionPhoto: item['ì¡°ì¹˜ì‚¬ì§„URL'] || item.actionPhoto || '',
              photo: item['ì‚¬ì§„URL'] || item.photo,
              photo2: item['ì‚¬ì§„2URL'] || item.photo2 || '',
              remarks: item['ë¹„ê³ '] || item.remarks || '',
              request: item['ìš”ì²­ì‚¬í•­'] || item.request || '',
              attachment: item['ì²¨ë¶€íŒŒì¼URL'] || item.attachment || '',
              emailSent: item['ë©”ì¼ë°œì†¡'] === 'Y' || item.emailSent === 'Y',
              impact: item['Impact'] || item.impact || '',
              incident: item['Incident'] || item.incident || '',
              rpn: item['RPN'] || item.rpn || '',
              hazard: item['Hazard'] || item.hazard || '',
              top5: item['Top5'] || item.top5 || '',
              sioCategory: item['SIOCategory'] || item.sioCategory || '',
              kaf: item['KAF'] || item.kaf || '',
              targetDate: item['TargetDate'] || item.targetDate || '',
              closedDate: item['ClosedDate'] || item.closedDate || ''
            }));
            setSubmissions(formattedData);
          }
        } catch (err) {
          setError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        setLoading(false);
      };

      const fetchDeptSettings = async () => {
        try {
          const response = await fetch(API_URL + '?type=deptSettings');
          const result = await response.json();
          if (result.success) setDeptSettings(result.data);
        } catch (err) { console.error(err); }
      };

      const fetchSettings = async () => {
        try {
          const response = await fetch(API_URL + '?type=settings');
          const result = await response.json();
          if (result.success && result.data) {
            setSettings({ ...defaultSettings, ...result.data });
          }
        } catch (err) { console.error(err); }
      };

      const saveSettingsToServer = async (newSettings) => {
        try {
          await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveSettings', settings: newSettings }) });
          setSettings(newSettings);
          return true;
        } catch (err) { 
          setError('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); 
          return false;
        }
      };

      React.useEffect(() => { fetchData(); fetchDeptSettings(); fetchSettings(); }, []);

      const handleNewSubmission = async (data, onProgress) => {
        // í…ŒìŠ¤íŠ¸ ëª¨ë“œì¼ ë•Œ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ í‘œì‹œ
        if (testMode) {
          return { success: false, testMode: true };
        }
        
        setLoading(true);
        try {
          const today = new Date();
          const dateOnly = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
          const payload = JSON.stringify({
            action: 'add',
            data: { date: dateOnly, ...data, status: 'ì ‘ìˆ˜ì™„ë£Œ', actionDept: '', actionPerson: '', actionContent: '' }
          });
          
          // ë°ì´í„° í¬ê¸° ê³„ì‚°
          const totalSize = new Blob([payload]).size;
          
          // ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
          let progress = 0;
          const interval = setInterval(() => {
            progress += totalSize * 0.1; // 10%ì”© ì¦ê°€
            if (progress < totalSize * 0.9) {
              onProgress && onProgress(Math.floor(progress), totalSize);
            }
          }, 200);
          
          const response = await fetch(API_URL, {
            method: 'POST',
            body: payload
          });
          
          clearInterval(interval);
          onProgress && onProgress(totalSize, totalSize); // 100% ì™„ë£Œ
          
          const result = await response.json();
          if (result.success) { await fetchData(); return { success: true }; }
        } catch (err) { setError('ì ‘ìˆ˜ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        setLoading(false);
        return { success: false };
      };

      const handleDelete = async (id) => {
        setLoading(true);
        try {
          await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id }) });
          await fetchData();
        } catch (err) { setError('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        setLoading(false);
      };

      const handleUpdate = async (id, data) => {
        try {
          await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'update', id, data }) });
          if (data.actionPhoto && data.actionPhoto.includes('base64,')) {
            await fetchData();
          } else {
            setSubmissions(submissions.map(s => s.id.toString() === id.toString() ? { ...s, ...data } : s));
          }
        } catch (err) { setError('ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
      };

      const handleSaveDeptSettings = async (newSettings) => {
        setLoading(true);
        try {
          await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'saveDeptSettings', settings: newSettings }) });
          setDeptSettings(newSettings);
        } catch (err) { setError('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        setLoading(false);
      };

      const handleSendSelectedNotifications = async (items) => {
        setLoading(true);
        try {
          const response = await fetch(API_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'sendSelectedNotifications', items: items }) 
          });
          const result = await response.json();
          setLoading(false);
          return result;
        } catch (err) {
          setLoading(false);
          return { success: false, error: 'ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
        }
      };

      const handleAdminTabClick = (tab) => {
        if (isAdminAuth) {
          setActiveTab(tab);
        } else {
          setPendingAdminTab(tab);
          setShowAdminLogin(true);
        }
      };

      const handleAdminLogin = () => {
        // íŠ¹ìˆ˜ ë¹„ë°€ë²ˆí˜¸: wndwl = í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ì ‘ìˆ˜ ì°¨ë‹¨), tlwkr = ì •ìƒ ëª¨ë“œ
        if (adminPassword === 'wndwl') {
          setTestMode(true);
          setIsAdminAuth(true);
          setShowAdminLogin(false);
          setActiveTab(pendingAdminTab);
          setPendingAdminTab(null);
          setAdminPassword('');
          return;
        }
        if (adminPassword === 'tlwkr') {
          setTestMode(false);
          setIsAdminAuth(true);
          setShowAdminLogin(false);
          setActiveTab(pendingAdminTab);
          setPendingAdminTab(null);
          setAdminPassword('');
          return;
        }
        if (adminPassword === settings.adminPassword || adminPassword === '1550612a') {
          setIsAdminAuth(true);
          setShowAdminLogin(false);
          setActiveTab(pendingAdminTab);
          setPendingAdminTab(null);
          setAdminPassword('');
        } else {
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      };

      const handleChangePassword = async () => {
        if (newPassword !== confirmPassword) {
          alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        if (newPassword.length < 4) {
          alert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
          return;
        }
        const newSettings = { ...settings, adminPassword: newPassword };
        const saved = await saveSettingsToServer(newSettings);
        if (saved) {
          setShowChangePassword(false);
          setNewPassword('');
          setConfirmPassword('');
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      };

      return (
        <div className="min-h-screen bg-gray-100">
          <header className="bg-white shadow-md border-b">
            <div className="max-w-4xl mx-auto px-4 py-3 flex items-center gap-3">
              <img src="data:image/webp;base64,UklGRlINAABXRUJQVlA4WAoAAAAwAAAAtAAAOAAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBIoQYAAAEkAUmKrIgILYm2bUOSTiIis9q2bdu2bdu2bdu2bdu2MbLd/QfR+eJHjHsQERMgi7Zt05FWnELQtm3btm3btm3btm3btm0b7yN596bfuFWjPyNiAiTbtm3azni2bdu2bdsu2bYd27Zt206KTjHf4FzUI2ICAN46nBzbb529Piwysm+lq+P3rSBCqpy9j33l5INaduQ16SX+NEGRNMFN3wcFEUi5N5awoKiL7mcgsHJa7jDgveGeqzEwyqAwYB2uuRcbw5wJAxq75ksajPM3pvL+xBIFijnRCgNpjZR3CnHpWQ4cMxtqpfL6yGY9cCAfhnpvU05Uu4bsqUphiSoUHMdYWgHl4GRGpdpZpIKmUu7Uiaz/ZGRY0kepbbo+uyQy7fqtaa+Gh/6Di8qxW1t2UqlPpqZNiDf/rfm9FkeqjZ4WV2nfI4li/VFKFdHUSaz8X033vEPG8VWvhdJ2IW6slFKjNRUUCnmpCfaQYZveBqW1lK2zXNIUS6iVJvrIJNNF75NDYX9iiYz3lr+x9ViENgppKWXS6WlFFXYMsTfqP/1aviF8Q6ysjOmF3gSFdZPpDfFD7K5YJRmW6l1TWDLXaFahw2LZpRroaYnU8lZ6AvfEFRok9NoiFUegrVpwd6gCQvF/iAxCimt6H8IBnYXoJXApJACT9ITF1mYx00Sdc7EJQFlFSVfKYmcXxtfxNVgI8u/4rmlXOtgJhPuX6urJlivhDh1abQnAa0dfgiOK+x1N5Hsj+RLQcVxOWKa/4o4jLqrEpXRoxY2TW3F9ZBNkU7VcsxnG9lFtGWUPZLe1aL0Mw0alPUWcVtlMruVXHsO0Udo0WR87HbVoTxIZJaXSSslO2dmhR7sVzyA8UsVbnS8Domiv39p8GQjx1ub1dAF6K+hv2ltpYflPfOKr+4+sDOpr2Edu666dO4uKNeoWuPgrgK59QGnBHziM/6Sz/k9uaf60Q1mgag2FvYX0RfNKhZ6BrLvFIrkDF/cQKFx9DpI3lf+gqu6nhOE/sQCQuIdAT6wI21MSiGAjsmExDACbyyfE4ifvDMiwVM9lx68t1MflBEwRfSKagOiHoKb0OaSNgob0T1Ky6zxBWXo44U8AWUW7HSCtITjHYxLpomfSogW7vKcik/8HFBsde92UU1UYOmd78rNUXz3iQCc8q6auP+IEujSCKZU4DSMKulZMPJfIepTaK4cfbo9n4cS9rcmxceo2Mm6cvB/wnMF0UfY5nNVzPrFwO4mmzcdcbkvLbl198InOG0j9Blkd9eVU7dt0pp6S3SvvKAmI/1Xv/sfKVpwO52LtSsCSUz42xVydklzz2FubNMsY2450S5lYipxHAFZtmLGtI7HXwt7Qxs1pnjP9LCY0J+MCRucn2g72elnIhtgsBIIvUqyPd/iv45Y5UevZU4fiVVqLMPvAHSV2X4czyjvsTA/CbV+jY7DZS0Cy7C9RJBoLc8FN76pUqcZsjpxtQqTzyZI1Gum5CE3ac8BN2T6cNpF/jM/VRAmrnaVidyzHqbkzCjRrxCEXFXqaLiRMWGgR6zubYUl/K74XWafNa/ZZ65+D7H7uSxE6zw1ZrPdwRtuv6xpRvdyTbM2Bm7KNbZaWZ00FpHU3gAs+wh9jZpYZcVfEWxqn5OExY8bkSLkSZuayHoEhRRIsh17VgOj7gfuMKEjaOdDkTm5mp7UfhmGFkp0ZPnx4YbzzDofimnY6gs/ZlDPgufV+MvphJEHnNLTkKV+G7Eb2mG5SP6lwQE3jHEeMkL7CoaWpqTEEdEEBwLgEZcYwstpMZpWeSu96UNzboDOcMDNNhx0RivWHg/GBciMg5h72umjSLGoCiizkuCXrZNjlqdYDcoakDmZe8RQuJlTzuTgjJTxf6U9fHlzTSByCA+Ze62FVIGsyptgTPUTMOI8hZDnPQdNLUK6EA4KXveaO1PQ8n47xxxIwpDtZNjM1D8HjNGuE+QRF14bWfw4wpLIl8foyXHJ4L2So05NGLUL30qo+5hM0nEC8/aatCUxboi5Ly+oEPrfXAd9Pw0QOwTsZToD7eO/F9YcCE7dM2XRRk75UXioqXirjo4bEQpqA+Odi7bR5VSmoOBma9ocEG1fNiMHEICk70y4J0fpg7jSu+kafwbt2zckPrdcNGGaNumJaP0uqlnRMSMyehCxZOjs+pdbOKEmh1TMq4LskD3A4Coz371pSYVgL5SkkN2+rXoD8YWhohH49ig/NNbuQc2p3FaK1HdRv5xO+3tSv3ZaQ8JczTzYL/z0BAFZQOCC6BAAAsB0AnQEqtQA5AD5RIo5FI6IhFglc8DgFBLMIoCVlH7/5oD90/qv4gXKjuPwD8me7gx3yX8Xfyn6aParvtk/fJ9+J/lP4y+5r+AfYB9APtA9wD9Ev89+onYA8wH7M+tr/Vf4B7AP1w/QD4AP69/fP//7Hf9v///uUf0b/AewB/EP876RH62/Ad+1/7r+zz///+37gH//9QD//uIGUDDBMp7sce76SewMhe2uXcOemfBZZS6hmTOz7yf0dSsmh7WIXAcd2+OAoUuEL29IJb7XL1SRwnBjjB17O+eHcW5HzlePagr0qiI2wW5gQGdO6OK/isSCjn+kAAP7w1vVocaqNfV6t5it8v2mFK+IhHCU8u5P8T//3xv/9xeEFwBaiUWsRZtvlwE81q8M2g30zYRgqH3LjwEt/kXNEQGnkwHyNKChaOAmD9ff3DvAkrrdoiBp/x2q2an03uV9/nDF3kpTNZpwsYOvHij4Xbc4f34wWiZULjg7FKbZ/xEt78vhlS6GlpkoOFLdnL8jDhjKS5xcxU/7B///IY//hwsUOlZZ/+8ZDX5zkk+pZYTFsg3szQnTKvdiO/RHEMsHmgXKtmO+ULOpZ8X/Ad7HCXZbuywYW8dTLZ7kXC1BMihoPAYP8bFnU1NZzp3fXR3nUFz3o7xkuztTcBMpKVdNVmwX/nkf/+Skq/xf/c7HLa/vU15v2FmrWCtdw7uggRG6gm83bi8YOQYAA77GoySc8yYeCLms7gCeCPY5ip9ef/mNcXuXCGvvpff//Hj//isDjAEXcACe2Ykb6sBT4uKagDose70wDOG2oIMWAvXHOeodQvETP/HfncG7KFq3Uuxm9Ax3chJLN+THu+lphdAEV/5UMy4ik/d95JXhFn689ZDixGLg0Xad3txYdM0SAR5AApD5ZLmCYB+5HrC3jr30APkCAzyUeLzBuUnMuFfQ+cH+nAA93gM2D1Q2W1j9519rJvT18RmDwAiX8ZHD7bcNxBUE4bc1UGSOoFP5kgo+YOEgVNRebdSN11EoXG8iFnxZB6ESt0dnYDVcMJdsNzy0if//JTkhfqkofI0gZ8MTe6wMzmPrKsgVSBS3sQyqgxTAB6OzSnGzxnIbFk/aTqsWYL7Zez1iOq3MSAvR3k7DJ0pPqT21VEAaUvwDOhPNqXXo3ilzSEef3p0ngDog7k+gAEyqJsF0fkzduTx6MxT0mgGK+/QXy5zF5GGAeKjuyBfYA1vTtz8/+uCP/3l59iV6uQFobBP/qXAZTechqRe7EbO9BVr8dnrOjZzk7YAN8xL5PWx8TdRpOpa1cEU499DrPKRmRY/5HAs6u0v2Eo3Vzbv1hXrhWhvISh1XymBHMuZdrtqfFTRSCpX9poAE7CtwWVzf9CKLNgBSafgwKMjwVYk5hKwrpcwgq2LVgBMclPU01+B2qhAgklCU4EoeGeuc0pxK+i1TsoiP4ouA/ya3Epdsp398UTwbWLyO+u48fQ6vE6Bvp2mkm07bqryqHQSLF9PW39rMDp9OhPWEBvbU+NZf6pv+Ito+F25DSQoZrPuiVvC4WmUzkgTfsN3iRXhOTJ6P51QFuabtr0Fg9Jcto4KdWCWpAyFEB0oY9yaavMdAAAA==" alt="EATON" style={{height: '32px', width: 'auto'}} />
              <h1 className="text-lg font-bold text-gray-800">SIO ê´€ë¦¬ì‹œìŠ¤í…œ</h1>
            </div>
          </header>

          {error && (
            <div className="mx-4 mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-center">
              {error}<button onClick={() => setError(null)} className="ml-2 underline">ë‹«ê¸°</button>
            </div>
          )}

          <main className="p-4 pb-24">
            {activeTab === 'submit' && <SubmitForm settings={settings} onSubmit={handleNewSubmission} loading={loading} />}
            {activeTab === 'list' && <SubmissionList submissions={submissions} loading={loading} onRefresh={fetchData} />}
            {activeTab === 'report' && <ReportTab submissions={submissions} deptSettings={deptSettings} loading={loading} onRefresh={fetchData} />}
            {activeTab === 'action' && <ActionTab submissions={submissions} settings={settings} deptSettings={deptSettings} onUpdate={handleUpdate} loading={loading} onRefresh={fetchData} />}
            {activeTab === 'help' && <HelpTab />}
            {activeTab === 'adminMobile' && <AdminMobile submissions={submissions} settings={settings} onUpdate={handleUpdate} loading={loading} onRefresh={fetchData} />}
            {activeTab === 'admin' && <AdminList submissions={submissions} settings={settings} onDelete={handleDelete} onUpdate={handleUpdate} loading={loading} onRefresh={fetchData} />}
            {activeTab === 'settings' && <SettingsPanel settings={settings} setSettings={setSettings} deptSettings={deptSettings} onSaveDeptSettings={handleSaveDeptSettings} onSendSelectedNotifications={handleSendSelectedNotifications} onSaveSettings={saveSettingsToServer} submissions={submissions} onRefresh={fetchData} />}
          </main>

          <nav className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
            <div className="flex justify-around">
              <NavButton icon="ClipboardList" label="ì ‘ìˆ˜" active={activeTab === 'submit'} onClick={() => setActiveTab('submit')} />
              <NavButton icon="List" label="ëª©ë¡" active={activeTab === 'list'} onClick={() => setActiveTab('list')} />
              <NavButton icon="BarChart3" label="ë³´ê³ ì„œ" active={activeTab === 'report'} onClick={() => setActiveTab('report')} />
              <NavButton icon="Wrench" label="ì¡°ì¹˜" active={activeTab === 'action'} onClick={() => setActiveTab('action')} />
              <NavButton icon="HelpCircle" label="ë„ì›€ë§" active={activeTab === 'help'} onClick={() => setActiveTab('help')} />
              <NavButton icon="Smartphone" label="ê´€ë¦¬M" active={activeTab === 'adminMobile'} onClick={() => handleAdminTabClick('adminMobile')} />
              <NavButton icon="Shield" label="ê´€ë¦¬" active={activeTab === 'admin'} onClick={() => handleAdminTabClick('admin')} />
              <NavButton icon="Settings" label="ì„¤ì •" active={activeTab === 'settings'} onClick={() => handleAdminTabClick('settings')} />
            </div>
          </nav>

          {/* ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ */}
          {showAdminLogin && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                <h3 className="text-lg font-bold text-gray-800 mb-4 text-center flex items-center justify-center gap-2">
                  <Icon name="Lock" size={20} /> ê´€ë¦¬ì ì¸ì¦
                </h3>
                <p className="text-sm text-gray-600 mb-4 text-center">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                <input
                  type="password"
                  value={adminPassword}
                  onChange={(e) => setAdminPassword(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                  placeholder="ë¹„ë°€ë²ˆí˜¸"
                  className="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center"
                  autoFocus
                />
                <div className="flex gap-2 mb-3">
                  <button onClick={() => { setShowAdminLogin(false); setAdminPassword(''); }} className="flex-1 py-3 border border-gray-300 rounded-lg text-gray-600">ì·¨ì†Œ</button>
                  <button onClick={handleAdminLogin} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium">í™•ì¸</button>
                </div>
                <button onClick={() => { setShowAdminLogin(false); setShowChangePassword(true); setAdminPassword(''); }} className="w-full text-sm text-gray-500 hover:text-blue-600">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
              </div>
            </div>
          )}

          {/* ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ */}
          {showChangePassword && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl">
                <h3 className="text-lg font-bold text-gray-800 mb-4 text-center flex items-center justify-center gap-2">
                  <Icon name="Key" size={20} /> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                </h3>
                <div className="space-y-3 mb-4">
                  <input
                    type="password"
                    value={adminPassword}
                    onChange={(e) => setAdminPassword(e.target.value)}
                    placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸"
                    className="w-full p-3 border border-gray-300 rounded-lg"
                  />
                  <input
                    type="password"
                    value={newPassword}
                    onChange={(e) => setNewPassword(e.target.value)}
                    placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"
                    className="w-full p-3 border border-gray-300 rounded-lg"
                  />
                  <input
                    type="password"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                    className="w-full p-3 border border-gray-300 rounded-lg"
                  />
                </div>
                <div className="flex gap-2">
                  <button onClick={() => { setShowChangePassword(false); setAdminPassword(''); setNewPassword(''); setConfirmPassword(''); }} className="flex-1 py-3 border border-gray-300 rounded-lg text-gray-600">ì·¨ì†Œ</button>
                  <button onClick={() => {
                    if (adminPassword === settings.adminPassword || adminPassword === '1550612a') {
                      handleChangePassword();
                    } else {
                      alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                  }} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium">ë³€ê²½</button>
                </div>
              </div>
            </div>
          )}

          {loading && (
            <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
              <div className="bg-white p-4 rounded-xl shadow-lg flex items-center gap-3">
                <div className="spinner"><Icon name="Loader2" size={24} /></div>
                <span>ì²˜ë¦¬ ì¤‘...</span>
              </div>
            </div>
          )}
        </div>
      );
    }

    function NavButton({ icon, label, active, onClick }) {
      return (
        <button onClick={onClick} className={`flex flex-col items-center py-2 px-2 ${active ? 'text-blue-600' : 'text-gray-500'}`}>
          <Icon name={icon} size={20} />
          <span className="text-xs mt-1">{label}</span>
        </button>
      );
    }

    function HelpTab() {
      const [openSection, setOpenSection] = React.useState('intro');

      const toggleSection = (section) => {
        setOpenSection(openSection === section ? null : section);
      };

      const Section = ({ id, title, icon, children }) => (
        <div className="bg-white rounded-xl shadow-md overflow-hidden mb-4">
          <button onClick={() => toggleSection(id)} className="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <Icon name={icon} size={20} className="text-blue-600" />
              </div>
              <span className="font-bold text-gray-800">{title}</span>
            </div>
            <Icon name={openSection === id ? 'ChevronUp' : 'ChevronDown'} size={20} className="text-gray-400" />
          </button>
          {openSection === id && <div className="px-4 pb-4 text-gray-600 text-sm leading-relaxed border-t">{children}</div>}
        </div>
      );

      return (
        <div className="space-y-4">
          <h2 className="text-lg font-bold text-gray-800 mb-4">ë„ì›€ë§</h2>

          <Section id="intro" title="SIO ê´€ë¦¬ì‹œìŠ¤í…œì´ë€?" icon="Info">
            <div className="pt-4 space-y-3">
              <p><strong>SIO (Safety Improvement Observation)</strong>ëŠ” ì‘ì—…ì¥ì˜ ì•ˆì „, í’ˆì§ˆ, í™˜ê²½ ê´€ë ¨ ìœ„í—˜ìš”ì†Œë‚˜ ê°œì„ ì‚¬í•­ì„ ë°œê²¬í–ˆì„ ë•Œ ì‹ ê³ í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.</p>
              <div className="bg-blue-50 p-3 rounded-lg">
                <p className="font-medium text-blue-800 mb-2">ğŸ“Œ SIOì˜ ëª©ì </p>
                <ul className="space-y-1 text-blue-700">
                  <li>â€¢ ì‚¬ê³  ì˜ˆë°© ë° ì•ˆì „í•œ ì‘ì—…í™˜ê²½ ì¡°ì„±</li>
                  <li>â€¢ í™˜ê²½ ìœ„í—˜ìš”ì†Œ ì œê±°</li>
                  <li>â€¢ ì „ ì§ì› ì°¸ì—¬í˜• ì•ˆì „ë¬¸í™” êµ¬ì¶•</li>
                </ul>
              </div>
            </div>
          </Section>

          <Section id="submit" title="SIO ì ‘ìˆ˜ ë°©ë²•" icon="ClipboardList">
            <div className="pt-4 space-y-4">
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">1</span>
                <div>
                  <p className="font-medium text-gray-800">ì´ë¦„ ì…ë ¥</p>
                  <p className="text-gray-500">ë³¸ì¸ì˜ ì´ë¦„ì„ í•œê¸€ë¡œ ì…ë ¥í•©ë‹ˆë‹¤. (4ê¸€ì ì´ë‚´, ë¦¬ë”/íŒ€ì¥ ìƒëµ)</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">2</span>
                <div>
                  <p className="font-medium text-gray-800">ë¶€ì„œ ì„ íƒ</p>
                  <p className="text-gray-500">ë³¸ì¸ì˜ ì†Œì† ë¶€ì„œë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">3</span>
                <div>
                  <p className="font-medium text-gray-800">êµ¬ë¶„ ì„ íƒ</p>
                  <p className="text-gray-500">ì•ˆì „/í’ˆì§ˆ/í™˜ê²½/ê¸°íƒ€ ì¤‘ í•´ë‹¹í•˜ëŠ” í•­ëª©ì„ ì„ íƒí•©ë‹ˆë‹¤.</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">4</span>
                <div>
                  <p className="font-medium text-gray-800">ì¥ì†Œ ì„ íƒ</p>
                  <p className="text-gray-500">ë¬¸ì œê°€ ë°œìƒí•œ ì¥ì†Œë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">5</span>
                <div>
                  <p className="font-medium text-gray-800">ë‚´ìš© ì‘ì„±</p>
                  <p className="text-gray-500">ë°œê²¬í•œ ìœ„í—˜ìš”ì†Œë‚˜ ê°œì„ ì‚¬í•­ì„ ìƒì„¸íˆ ì‘ì„±í•©ë‹ˆë‹¤.</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <span className="w-6 h-6 bg-red-600 text-white rounded-full flex items-center justify-center text-sm flex-shrink-0">6</span>
                <div>
                  <p className="font-medium text-gray-800">ì‚¬ì§„ ì²¨ë¶€ (í•„ìˆ˜)</p>
                  <p className="text-red-500">ì‚¬ì§„ì„ ì²¨ë¶€í•˜ì§€ ì•Šìœ¼ë©´ ì¡°ì¹˜ê°€ ì–´ë µìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ ì²¨ë¶€í•´ì£¼ì„¸ìš”!</p>
                </div>
              </div>
              <div className="bg-yellow-50 p-3 rounded-lg mt-4">
                <p className="font-medium text-yellow-800">ğŸ’¡ TIP</p>
                <p className="text-yellow-700">êµ¬ì²´ì ì¸ ìœ„ì¹˜ì™€ ìƒí™©ì„ ì‘ì„±í•˜ë©´ ë¹ ë¥¸ ì¡°ì¹˜ì— ë„ì›€ì´ ë©ë‹ˆë‹¤!</p>
              </div>
            </div>
          </Section>

          <Section id="list" title="ëª©ë¡ í™•ì¸í•˜ê¸°" icon="List">
            <div className="pt-4 space-y-3">
              <p>ì ‘ìˆ˜ëœ SIO í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              
              <div className="bg-gray-50 p-3 rounded-lg">
                <p className="font-medium text-gray-800 mb-2">ğŸ“‹ ìƒíƒœ í•„í„°</p>
                <p className="text-gray-600 text-sm">ìƒë‹¨ì˜ ìƒíƒœ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ìƒíƒœì˜ SIOë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              </div>

              <div className="space-y-2">
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">ì ‘ìˆ˜ì™„ë£Œ</span>
                  <span className="text-gray-600">ìƒˆë¡œ ì ‘ìˆ˜ë˜ì–´ ê²€í†  ëŒ€ê¸° ì¤‘</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs">ì¡°ì¹˜ì¤‘</span>
                  <span className="text-gray-600">ë‹´ë‹¹ë¶€ì„œì—ì„œ ì¡°ì¹˜ ì§„í–‰ ì¤‘</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">ì¡°ì¹˜ì™„ë£Œ</span>
                  <span className="text-gray-600">ì¡°ì¹˜ ì™„ë£Œ (ì¡°ì¹˜ë¶€ì„œ, ë‹´ë‹¹ì, ë‚´ìš©, ì‚¬ì§„ í‘œì‹œ)</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs">ê¸°ê°</span>
                  <span className="text-gray-600">ê²€í†  ê²°ê³¼ ì¡°ì¹˜ ë¶ˆí•„ìš”ë¡œ íŒì •</span>
                </div>
              </div>
              <p className="mt-3">ğŸ” ê²€ìƒ‰ì°½ì—ì„œ ë‚´ìš©, ì¥ì†Œ, êµ¬ë¶„ìœ¼ë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
          </Section>

          <Section id="report" title="ë³´ê³ ì„œ ë³´ê¸°" icon="BarChart3">
            <div className="pt-4 space-y-3">
              <p>SIO í†µê³„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              <ul className="space-y-2">
                <li className="flex items-start gap-2">
                  <span className="text-blue-600">â€¢</span>
                  <span><strong>ë¶€ì„œë³„ ì ‘ìˆ˜í˜„í™©:</strong> ì›”ë³„ë¡œ ê° ë¶€ì„œì˜ SIO ì ‘ìˆ˜ ê±´ìˆ˜</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-600">â€¢</span>
                  <span><strong>ì¡°ì¹˜ë¶€ì„œë³„ í˜„í™©:</strong> ì¡°ì¹˜ ì™„ë£Œ/ë¯¸ì™„ë£Œ í˜„í™©</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-600">â€¢</span>
                  <span><strong>ì¸ì›ë³„ ì ‘ìˆ˜ê±´ìˆ˜:</strong> ê°œì¸ë³„ SIO ì ‘ìˆ˜ ìˆœìœ„</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-600">â€¢</span>
                  <span><strong>ì¡°ì¹˜ë‹´ë‹¹ìë³„:</strong> ì¡°ì¹˜ì™„ë£Œ ê±´ìˆ˜ ìˆœìœ„</span>
                </li>
              </ul>
              <p className="mt-3">ğŸ“Š ì˜¤ë¥¸ìª½ ìƒë‹¨ <strong>ë‚´ë³´ë‚´ê¸°</strong> ë²„íŠ¼ìœ¼ë¡œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
          </Section>

          <Section id="action" title="ì¡°ì¹˜í•˜ê¸° (ë‹´ë‹¹ììš©)" icon="Wrench">
            <div className="pt-4 space-y-3">
              <p>ë³¸ì¸ ë¶€ì„œì— í• ë‹¹ëœ SIOë¥¼ ì¡°ì¹˜í•©ë‹ˆë‹¤.</p>
              <div className="bg-gray-50 p-3 rounded-lg space-y-2">
                <p><strong>1.</strong> í•´ë‹¹ ë¶€ì„œ ë²„íŠ¼ í´ë¦­ (ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì‹œ ì…ë ¥)</p>
                <p><strong>2.</strong> í• ë‹¹ëœ SIO ëª©ë¡ í™•ì¸</p>
                <p><strong>3.</strong> ì¡°ì¹˜ë‹´ë‹¹ì ì´ë¦„ ì…ë ¥</p>
                <p><strong>4.</strong> ì¡°ì¹˜ë‚´ìš© ìƒì„¸ ì‘ì„±</p>
                <p><strong>5.</strong> ì¡°ì¹˜ í›„ ì‚¬ì§„ ì²¨ë¶€ (ê¶Œì¥)</p>
                <p><strong>6.</strong> [ì €ì¥] ë˜ëŠ” [ì¡°ì¹˜ì™„ë£Œ] í´ë¦­</p>
              </div>
            </div>
          </Section>

          <Section id="faq" title="ìì£¼ ë¬»ëŠ” ì§ˆë¬¸" icon="MessageCircle">
            <div className="pt-4 space-y-4">
              <div>
                <p className="font-medium text-gray-800">Q. ì ‘ìˆ˜í•œ SIOë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆë‚˜ìš”?</p>
                <p className="text-gray-600 mt-1">A. ì ‘ìˆ˜ í›„ ìˆ˜ì •ì€ ê´€ë¦¬ìì—ê²Œ ìš”ì²­í•´ì£¼ì„¸ìš”.</p>
              </div>
              <div>
                <p className="font-medium text-gray-800">Q. ìµëª…ìœ¼ë¡œ ì ‘ìˆ˜í•  ìˆ˜ ìˆë‚˜ìš”?</p>
                <p className="text-gray-600 mt-1">A. í˜„ì¬ ì‹œìŠ¤í…œì€ ì‹¤ëª… ì ‘ìˆ˜ë¥¼ ì›ì¹™ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
              </div>
              <div>
                <p className="font-medium text-gray-800">Q. ì‚¬ì§„ì€ í•„ìˆ˜ì¸ê°€ìš”?</p>
                <p className="text-gray-600 mt-1">A. ì„ íƒì‚¬í•­ì´ì§€ë§Œ, ì²¨ë¶€í•˜ë©´ ì •í™•í•œ ìƒí™© íŒŒì•…ì— ë„ì›€ë©ë‹ˆë‹¤.</p>
              </div>
              <div>
                <p className="font-medium text-gray-800">Q. ê¸°ê°ì´ë€ ë¬´ì—‡ì¸ê°€ìš”?</p>
                <p className="text-gray-600 mt-1">A. ê²€í†  ê²°ê³¼ ì¡°ì¹˜ê°€ ë¶ˆí•„ìš”í•˜ê±°ë‚˜ í•´ë‹¹ì‚¬í•­ì´ ì•„ë‹Œ ê²½ìš°ì…ë‹ˆë‹¤. ë¹„ê³ ì— ì‚¬ìœ ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.</p>
              </div>
            </div>
          </Section>

          <Section id="contact" title="ë¬¸ì˜í•˜ê¸°" icon="Phone">
            <div className="pt-4 space-y-3">
              <p>ì‹œìŠ¤í…œ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì€ ì•„ë˜ë¡œ ì—°ë½ì£¼ì„¸ìš”.</p>
              <div className="bg-gray-50 p-4 rounded-lg space-y-3">
                <div>
                  <p className="font-medium text-gray-800 flex items-center gap-2"><Icon name="User" size={16} className="text-blue-500" /> ì—…ë¬´ë‹´ë‹¹ì</p>
                  <p className="flex items-center gap-2 mt-1 pl-6"><Icon name="Mail" size={14} className="text-gray-400" /> inheepark@eaton.com</p>
                </div>
                <div>
                  <p className="font-medium text-gray-800 flex items-center gap-2"><Icon name="Monitor" size={16} className="text-green-500" /> ì‹œìŠ¤í…œë‹´ë‹¹ì</p>
                  <p className="flex items-center gap-2 mt-1 pl-6"><Icon name="Mail" size={14} className="text-gray-400" /> seminlee@eaton.com</p>
                </div>
              </div>
            </div>
          </Section>
        </div>
      );
    }

    function SubmitForm({ settings, onSubmit, loading }) {
      const [formData, setFormData] = React.useState({ name: '', department: '', category: '', location: '', content: '', photo: null, photo2: null });
      const [photoPreview, setPhotoPreview] = React.useState(null);
      const [photoPreview2, setPhotoPreview2] = React.useState(null);
      const [showSuccess, setShowSuccess] = React.useState(false);
      const [showNetworkError, setShowNetworkError] = React.useState(false);
      const [uploading, setUploading] = React.useState(false);
      const [uploadProgress, setUploadProgress] = React.useState({ loaded: 0, total: 0 });
      const [compressing, setCompressing] = React.useState(false);
      const [compressing2, setCompressing2] = React.useState(false);

      const formatBytes = (bytes) => {
        if (bytes === 0) return '0 B';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      };

      // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ë° ì••ì¶• í•¨ìˆ˜
      const compressImage = (file, maxSize = 1280, quality = 0.85) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              
              // ìµœëŒ€ í¬ê¸° ì œí•œ
              if (width > height) {
                if (width > maxSize) {
                  height = Math.round((height * maxSize) / width);
                  width = maxSize;
                }
              } else {
                if (height > maxSize) {
                  width = Math.round((width * maxSize) / height);
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              // JPEGë¡œ ì••ì¶•
              const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
              resolve(compressedBase64);
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };

      const handlePhotoChange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          setCompressing(true);
          const originalSize = file.size;
          
          // ì´ë¯¸ì§€ ì••ì¶•
          const compressedBase64 = await compressImage(file, 1280, 0.85);
          const compressedSize = Math.round((compressedBase64.length * 3) / 4); // base64 í¬ê¸° ì¶”ì •
          
          console.log(`ì‚¬ì§„1 ì••ì¶•: ${formatBytes(originalSize)} â†’ ${formatBytes(compressedSize)}`);
          
          setPhotoPreview(compressedBase64);
          setFormData({ ...formData, photo: compressedBase64 });
          setCompressing(false);
        }
      };

      const handlePhoto2Change = async (e) => {
        const file = e.target.files[0];
        if (file) {
          setCompressing2(true);
          const originalSize = file.size;
          
          // ì´ë¯¸ì§€ ì••ì¶•
          const compressedBase64 = await compressImage(file, 1280, 0.85);
          const compressedSize = Math.round((compressedBase64.length * 3) / 4);
          
          console.log(`ì‚¬ì§„2 ì••ì¶•: ${formatBytes(originalSize)} â†’ ${formatBytes(compressedSize)}`);
          
          setPhotoPreview2(compressedBase64);
          setFormData({ ...formData, photo2: compressedBase64 });
          setCompressing2(false);
        }
      };

      const handleSubmit = async () => {
        if (!formData.name || !formData.department || !formData.category || !formData.location || !formData.content) {
          alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return;
        }
        if (!formData.photo || !formData.photo2) {
          alert('ì›ê±°ë¦¬ ì‚¬ì§„ê³¼ ê·¼ê±°ë¦¬ ì‚¬ì§„ ëª¨ë‘ ì²¨ë¶€í•´ì£¼ì„¸ìš”.'); return;
        }
        setUploading(true);
        setUploadProgress({ loaded: 0, total: 0 });
        
        const result = await onSubmit(formData, (loaded, total) => {
          setUploadProgress({ loaded, total });
        });
        
        setUploading(false);
        
        // í…ŒìŠ¤íŠ¸ ëª¨ë“œì¼ ë•Œ ì „ì²´í™”ë©´ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ëª¨ë‹¬ í‘œì‹œ
        if (result && result.testMode) {
          setShowNetworkError(true);
          return;
        }
        
        if (result && result.success) {
          setFormData({ name: '', department: '', category: '', location: '', content: '', photo: null, photo2: null });
          setPhotoPreview(null);
          setPhotoPreview2(null);
          setShowSuccess(true);
        }
      };

      return (
        <div className="bg-white rounded-xl shadow-md p-6">
          <h2 className="text-lg font-bold mb-6 text-gray-800">SIO ì ‘ìˆ˜</h2>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„ * <span className="text-gray-400 text-xs">(í•œê¸€ë§Œ ì…ë ¥, ë¦¬ë”/íŒ€ì¥ ìƒëµ)</span></label>
              <input type="text" value={formData.name} onChange={(e) => {
                const value = e.target.value.replace(/[^ã„±-ã…ã…-ã…£ê°€-í£]/g, '').slice(0, 4);
                setFormData({ ...formData, name: value });
              }}
                className="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxLength={4} />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ë¶€ì„œ * <span className="text-gray-400 text-xs">(ë³¸ì¸ì˜ ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”)</span></label>
              <select value={formData.department} onChange={(e) => setFormData({ ...formData, department: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg bg-white">
                <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                {settings.departments.map((dept, idx) => <option key={idx} value={dept}>{dept}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">êµ¬ë¶„ *</label>
              <select value={formData.category} onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg bg-white">
                <option value="">êµ¬ë¶„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                {settings.categories.map((cat, idx) => <option key={idx} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ì¥ì†Œ *</label>
              <select value={formData.location} onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg bg-white">
                <option value="">ì¥ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                {settings.locations.map((loc, idx) => <option key={idx} value={loc}>{loc}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">ë‚´ìš© *</label>
              <textarea value={formData.content} onChange={(e) => setFormData({ ...formData, content: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg h-32 resize-none" placeholder="ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">ì‚¬ì§„ ì²¨ë¶€ * <span className="text-red-500 text-xs">(ì›ê±°ë¦¬/ê·¼ê±°ë¦¬ 2ì¥ ëª¨ë‘ í•„ìˆ˜)</span></label>
              <div className="grid grid-cols-2 gap-3">
                {/* ì›ê±°ë¦¬ ì‚¬ì§„ */}
                <div>
                  {compressing ? (
                    <div className="flex flex-col items-center justify-center w-full h-36 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50">
                      <Icon name="Loader" size={24} className="text-blue-500 mb-1 spinner" />
                      <span className="text-xs text-blue-600">ì••ì¶• ì¤‘...</span>
                    </div>
                  ) : photoPreview ? (
                    <div className="relative">
                      <img src={photoPreview} alt="Preview" className="w-full h-36 object-cover rounded-lg" />
                      <button type="button" onClick={() => { setPhotoPreview(null); setFormData({ ...formData, photo: null }); }} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full"><Icon name="X" size={16} /></button>
                      <div className="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 py-0.5 rounded">
                        {formatBytes(Math.round((formData.photo?.length || 0) * 3 / 4))}
                      </div>
                    </div>
                  ) : (
                    <label className="flex flex-col items-center justify-center w-full h-36 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer hover:border-blue-500 bg-blue-50">
                      <Icon name="Mountain" size={28} className="text-blue-400 mb-1" />
                      <span className="text-xs text-blue-600 font-medium text-center px-2">ì›ê±°ë¦¬ (í•„ìˆ˜)<br/>ì¥ë¹„/ì¥ì†Œ ì‹ë³„ ê°€ëŠ¥í•œ ì‚¬ì§„</span>
                      <input type="file" accept="image/*" onChange={handlePhotoChange} className="hidden" />
                    </label>
                  )}
                </div>
                {/* ê·¼ê±°ë¦¬ ì‚¬ì§„ */}
                <div>
                  {compressing2 ? (
                    <div className="flex flex-col items-center justify-center w-full h-36 border-2 border-dashed border-green-300 rounded-lg bg-green-50">
                      <Icon name="Loader" size={24} className="text-green-500 mb-1 spinner" />
                      <span className="text-xs text-green-600">ì••ì¶• ì¤‘...</span>
                    </div>
                  ) : photoPreview2 ? (
                    <div className="relative">
                      <img src={photoPreview2} alt="Preview2" className="w-full h-36 object-cover rounded-lg" />
                      <button type="button" onClick={() => { setPhotoPreview2(null); setFormData({ ...formData, photo2: null }); }} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full"><Icon name="X" size={16} /></button>
                      <div className="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 py-0.5 rounded">
                        {formatBytes(Math.round((formData.photo2?.length || 0) * 3 / 4))}
                      </div>
                    </div>
                  ) : (
                    <label className="flex flex-col items-center justify-center w-full h-36 border-2 border-dashed border-green-300 rounded-lg cursor-pointer hover:border-green-500 bg-green-50">
                      <Icon name="Search" size={28} className="text-green-400 mb-1" />
                      <span className="text-xs text-green-600 font-medium text-center px-2">ê·¼ê±°ë¦¬ (í•„ìˆ˜)<br/>ê°€ê¹Œì´ì„œ ì°ì€ ì‚¬ì§„</span>
                      <input type="file" accept="image/*" onChange={handlePhoto2Change} className="hidden" />
                    </label>
                  )}
                </div>
              </div>
            </div>
            
            {/* ì—…ë¡œë“œ ì§„í–‰ë¥  í‘œì‹œ */}
            {uploading && (
              <div className="bg-blue-50 rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-blue-700 flex items-center gap-2">
                    <Icon name="Upload" size={16} className="spinner" /> ì—…ë¡œë“œ ì¤‘...
                  </span>
                  <span className="text-sm text-blue-600">
                    {formatBytes(uploadProgress.loaded)} / {formatBytes(uploadProgress.total)}
                  </span>
                </div>
                <div className="w-full bg-blue-200 rounded-full h-2">
                  <div 
                    className="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                    style={{ width: uploadProgress.total > 0 ? `${(uploadProgress.loaded / uploadProgress.total) * 100}%` : '0%' }}
                  ></div>
                </div>
                <p className="text-xs text-blue-500 mt-2 text-center">
                  {uploadProgress.total > 0 ? Math.round((uploadProgress.loaded / uploadProgress.total) * 100) : 0}% ì™„ë£Œ
                </p>
              </div>
            )}
            
            <button type="button" onClick={handleSubmit} disabled={loading || uploading}
              className="w-full bg-blue-600 text-white py-4 rounded-lg font-bold hover:bg-blue-700 disabled:bg-gray-400">
              {uploading ? 'ì—…ë¡œë“œ ì¤‘...' : 'ì ‘ìˆ˜í•˜ê¸°'}
            </button>
          </div>
          {showSuccess && <SuccessModal onClose={() => setShowSuccess(false)} />}
          {showNetworkError && <NetworkErrorModal onClose={() => setShowNetworkError(false)} />}
        </div>
      );
    }

    function SubmissionList({ submissions, loading, onRefresh }) {
      const [selectedPhoto, setSelectedPhoto] = React.useState(null);
      const [searchText, setSearchText] = React.useState('');
      const [statusFilter, setStatusFilter] = React.useState('');
      
      const getStatusColor = (status) => {
        switch (status) {
          case 'ì¡°ì¹˜ì™„ë£Œ': return 'bg-green-100 text-green-700';
          case 'ì¡°ì¹˜ì¤‘': return 'bg-yellow-100 text-yellow-700';
          case 'ê¸°ê°': return 'bg-red-100 text-red-700';
          default: return 'bg-blue-100 text-blue-700';
        }
      };

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        try {
          const str = String(dateStr);
          // "2025-12-05" ë˜ëŠ” "2025. 12. 5." í˜•ì‹ ì²˜ë¦¬
          const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
          if (match) {
            return match[1] + '/' + match[2].padStart(2, '0') + '/' + match[3].padStart(2, '0');
          }
          // Date ê°ì²´ë¡œ ì‹œë„
          const date = new Date(str);
          if (!isNaN(date.getTime())) {
            return date.getFullYear() + '/' + String(date.getMonth() + 1).padStart(2, '0') + '/' + String(date.getDate()).padStart(2, '0');
          }
          return str.split(' ')[0]; // ì‹œê°„ ë¶€ë¶„ ì œê±°
        } catch (e) {
          return String(dateStr).split(' ')[0];
        }
      };

      // ìƒíƒœë³„ ê±´ìˆ˜
      const statusCounts = {
        '': submissions.length,
        'ì ‘ìˆ˜ì™„ë£Œ': submissions.filter(s => s.status === 'ì ‘ìˆ˜ì™„ë£Œ').length,
        'ì¡°ì¹˜ì¤‘': submissions.filter(s => s.status === 'ì¡°ì¹˜ì¤‘').length,
        'ì¡°ì¹˜ì™„ë£Œ': submissions.filter(s => s.status === 'ì¡°ì¹˜ì™„ë£Œ').length,
        'ê¸°ê°': submissions.filter(s => s.status === 'ê¸°ê°').length
      };

      // ê²€ìƒ‰ ë° ìƒíƒœ í•„í„°ë§
      const filteredSubmissions = submissions.filter(item => {
        // ìƒíƒœ í•„í„°
        if (statusFilter && item.status !== statusFilter) return false;
        // ê²€ìƒ‰ í•„í„°
        if (!searchText.trim()) return true;
        const search = searchText.toLowerCase();
        const checkField = (field) => field && String(field).toLowerCase().includes(search);
        return (
          checkField(item.content) ||
          checkField(item.location) ||
          checkField(item.category) ||
          checkField(item.actionDept) ||
          checkField(item.actionContent)
        );
      });

      if (submissions.length === 0 && !loading) {
        return (
          <div className="bg-white rounded-xl shadow-md p-6 text-center">
            <Icon name="List" size={64} className="mx-auto text-gray-300 mb-4" />
            <p className="text-gray-500">ì ‘ìˆ˜ëœ SIOê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <button onClick={onRefresh} className="mt-4 text-blue-600 flex items-center gap-2 mx-auto"><Icon name="RefreshCw" size={16} /> ìƒˆë¡œê³ ì¹¨</button>
          </div>
        );
      }

      return (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <h2 className="text-lg font-bold text-gray-800">ì ‘ìˆ˜ ëª©ë¡ ({filteredSubmissions.length}ê±´)</h2>
            <button onClick={onRefresh} className="text-blue-600 p-2 hover:bg-blue-50 rounded-lg"><Icon name="RefreshCw" size={20} /></button>
          </div>

          {/* ìƒíƒœ í•„í„° íƒ­ */}
          <div className="flex gap-2 overflow-x-auto pb-2">
            <button onClick={() => setStatusFilter('')} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${statusFilter === '' ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>ì „ì²´ ({statusCounts['']})</button>
            <button onClick={() => setStatusFilter('ì ‘ìˆ˜ì™„ë£Œ')} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${statusFilter === 'ì ‘ìˆ˜ì™„ë£Œ' ? 'bg-blue-600 text-white' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`}>ì ‘ìˆ˜ì™„ë£Œ ({statusCounts['ì ‘ìˆ˜ì™„ë£Œ']})</button>
            <button onClick={() => setStatusFilter('ì¡°ì¹˜ì¤‘')} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${statusFilter === 'ì¡°ì¹˜ì¤‘' ? 'bg-yellow-500 text-white' : 'bg-yellow-50 text-yellow-600 hover:bg-yellow-100'}`}>ì¡°ì¹˜ì¤‘ ({statusCounts['ì¡°ì¹˜ì¤‘']})</button>
            <button onClick={() => setStatusFilter('ì¡°ì¹˜ì™„ë£Œ')} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${statusFilter === 'ì¡°ì¹˜ì™„ë£Œ' ? 'bg-green-600 text-white' : 'bg-green-50 text-green-600 hover:bg-green-100'}`}>ì¡°ì¹˜ì™„ë£Œ ({statusCounts['ì¡°ì¹˜ì™„ë£Œ']})</button>
            <button onClick={() => setStatusFilter('ê¸°ê°')} className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${statusFilter === 'ê¸°ê°' ? 'bg-red-600 text-white' : 'bg-red-50 text-red-600 hover:bg-red-100'}`}>ê¸°ê° ({statusCounts['ê¸°ê°']})</button>
          </div>
          
          {/* ê²€ìƒ‰ì°½ */}
          <div className="relative">
            <Icon name="Search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
            <input 
              type="text" 
              value={searchText} 
              onChange={(e) => setSearchText(e.target.value)}
              placeholder="ë‚´ìš©, ì¥ì†Œ, êµ¬ë¶„ ê²€ìƒ‰..." 
              className="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            {searchText && (
              <button onClick={() => setSearchText('')} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                <Icon name="X" size={18} />
              </button>
            )}
          </div>
          
          {/* ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ */}
          {filteredSubmissions.length === 0 && searchText && (
            <div className="bg-white rounded-xl shadow-md p-6 text-center">
              <Icon name="Search" size={48} className="mx-auto text-gray-300 mb-3" />
              <p className="text-gray-500">'{searchText}' ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          )}
          
          <div className="space-y-3">
            {filteredSubmissions.slice().reverse().map((item) => (
              <div key={item.id} className="bg-white rounded-xl shadow-md p-4">
                {/* ìƒíƒœ í‘œì‹œ */}
                <div className="flex justify-between items-center mb-3">
                  <span className="text-sm"><span className="text-gray-500">ìƒíƒœ : </span><span className={`font-medium ${item.status === 'ì¡°ì¹˜ì™„ë£Œ' ? 'text-green-600' : item.status === 'ì¡°ì¹˜ì¤‘' ? 'text-yellow-600' : item.status === 'ê¸°ê°' ? 'text-red-600' : 'text-blue-600'}`}>{item.status}</span></span>
                  {item.actionDept && <span className="text-sm"><span className="text-gray-500">ë‹´ë‹¹ë¶€ì„œ : </span><span className="font-medium text-gray-800">{item.actionDept}</span></span>}
                </div>
                
                {/* ê¸°ë³¸ ì •ë³´ */}
                <div className="space-y-1 text-sm">
                  <div className="flex">
                    <span className="text-gray-500 w-16 flex-shrink-0">ì ‘ìˆ˜ì¼ì</span>
                    <span className="text-gray-700">{formatDate(item.date)}</span>
                  </div>
                  <div className="flex">
                    <span className="text-gray-500 w-16 flex-shrink-0">ì¥ì†Œ</span>
                    <span className="text-gray-700">{item.location}</span>
                  </div>
                  <div className="flex">
                    <span className="text-gray-500 w-16 flex-shrink-0">ë‚´ìš©</span>
                    <span className="text-gray-700">{item.content}</span>
                  </div>
                  {item.status === 'ê¸°ê°' && item.remarks && (
                    <div className="flex">
                      <span className="text-gray-500 w-16 flex-shrink-0">ë¹„ê³ </span>
                      <span className="text-red-600 font-medium">{item.remarks}</span>
                    </div>
                  )}
                </div>
                
                {/* ì ‘ìˆ˜ ì‚¬ì§„ - ë‘ ì¥ */}
                {(item.photo || item.photo2) && (
                  <div className="mt-3 grid grid-cols-2 gap-2">
                    {item.photo && (
                      <div>
                        <p className="text-xs text-gray-500 mb-1">ì›ê±°ë¦¬</p>
                        <img src={convertDriveUrl(item.photo)} alt="ì›ê±°ë¦¬ì‚¬ì§„" onClick={() => setSelectedPhoto(item.photo)}
                          className="w-full h-32 object-cover rounded-lg cursor-pointer" />
                      </div>
                    )}
                    {item.photo2 && (
                      <div>
                        <p className="text-xs text-gray-500 mb-1">ê·¼ê±°ë¦¬</p>
                        <img src={convertDriveUrl(item.photo2)} alt="ê·¼ê±°ë¦¬ì‚¬ì§„" onClick={() => setSelectedPhoto(item.photo2)}
                          className="w-full h-32 object-cover rounded-lg cursor-pointer" />
                      </div>
                    )}
                  </div>
                )}
                
                {/* ì¡°ì¹˜ ì •ë³´ - ì¡°ì¹˜ì™„ë£Œì¼ ë•Œë§Œ ìƒì„¸ í‘œì‹œ */}
                {item.status === 'ì¡°ì¹˜ì™„ë£Œ' && (item.actionDept || item.actionPerson || item.actionContent || item.actionPhoto) && (
                  <div className="mt-3 pt-3 border-t border-green-200 bg-green-50 -mx-4 -mb-4 px-4 pb-4 rounded-b-xl">
                    <p className="text-xs font-medium text-green-700 mb-2 flex items-center gap-1"><Icon name="CheckCircle" size={14} /> ì¡°ì¹˜ ì™„ë£Œ ì •ë³´</p>
                    <div className="space-y-1 text-sm">
                      {item.actionDept && (
                        <div className="flex">
                          <span className="text-green-600 w-16 flex-shrink-0">ì¡°ì¹˜ë¶€ì„œ</span>
                          <span className="text-gray-700">{item.actionDept}</span>
                        </div>
                      )}
                      {item.actionPerson && (
                        <div className="flex">
                          <span className="text-green-600 w-16 flex-shrink-0">ë‹´ë‹¹ì</span>
                          <span className="text-gray-700">{item.actionPerson}</span>
                        </div>
                      )}
                      {item.actionContent && (
                        <div className="flex">
                          <span className="text-green-600 w-16 flex-shrink-0">ì¡°ì¹˜ë‚´ìš©</span>
                          <span className="text-gray-700">{item.actionContent}</span>
                        </div>
                      )}
                    </div>
                    {item.actionPhoto && (
                      <div className="mt-2">
                        <p className="text-xs text-green-600 mb-1">ì¡°ì¹˜ ì‚¬ì§„</p>
                        <img src={convertDriveUrl(item.actionPhoto)} alt="ì¡°ì¹˜ì‚¬ì§„" onClick={() => setSelectedPhoto(item.actionPhoto)}
                          className="w-full h-40 object-cover rounded-lg cursor-pointer" />
                      </div>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
          
          {selectedPhoto && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedPhoto(null)}>
              <div className="relative max-w-3xl max-h-full">
                <img src={convertDriveUrl(selectedPhoto)} alt="ì‚¬ì§„" className="max-w-full max-h-[80vh] object-contain rounded-lg bg-white" />
                <button onClick={() => setSelectedPhoto(null)} className="absolute top-2 right-2 bg-white text-gray-800 p-2 rounded-full shadow-lg"><Icon name="X" size={24} /></button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function ReportTab({ submissions, deptSettings, loading, onRefresh }) {
      const [selectedYear, setSelectedYear] = React.useState(new Date().getFullYear());
      const [selectedPieDept, setSelectedPieDept] = React.useState(null);
      
      // ë‚ ì§œ íŒŒì‹± í•¨ìˆ˜
      const parseDate = (dateStr) => {
        if (!dateStr) return null;
        const str = String(dateStr);
        // "2025. 12. 5. ì˜¤í›„" í˜•ì‹ ì²˜ë¦¬
        const match = str.match(/(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
        if (match) {
          return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
        }
        // ì¼ë°˜ Date íŒŒì‹± ì‹œë„
        const date = new Date(str);
        if (!isNaN(date.getTime())) {
          return date;
        }
        return null;
      };
      
      // ì—°ë„ ëª©ë¡ ìƒì„±
      const years = [...new Set(submissions.map(s => {
        const date = parseDate(s.date);
        return date ? date.getFullYear() : new Date().getFullYear();
      }))].sort((a, b) => b - a);
      
      if (years.length === 0) years.push(new Date().getFullYear());
      
      // ì—°ë„ë³„ í•„í„°ë§
      const filteredByYear = submissions.filter(s => {
        const date = parseDate(s.date);
        if (!date) return false;
        return date.getFullYear() === selectedYear;
      });

      // 1. ì›”ë³„ ë¶€ì„œë³„ ì ‘ìˆ˜ í˜„í™© (ë¶€ì„œ=í–‰, ì›”=ì—´)
      const getMonthlyDeptStats = () => {
        const stats = {};
        filteredByYear.forEach(s => {
          const date = parseDate(s.date);
          if (!date) return;
          const month = date.getMonth() + 1;
          const dept = s.department || 'ë¯¸ì§€ì •';
          
          if (!stats[dept]) stats[dept] = {};
          if (!stats[dept][month]) stats[dept][month] = 0;
          stats[dept][month]++;
        });
        return stats;
      };

      // 2. ì›”ë³„ ì¡°ì¹˜ë¶€ì„œë³„ ë¯¸ì¡°ì¹˜/ì¡°ì¹˜ì™„ë£Œ í˜„í™© (ì¡°ì¹˜ë¶€ì„œ=í–‰, ì›”=ì—´)
      const getMonthlyActionDeptStats = () => {
        const stats = {};
        filteredByYear.forEach(s => {
          const date = parseDate(s.date);
          if (!date) return;
          const month = date.getMonth() + 1;
          const actionDept = s.actionDept;
          if (!actionDept) return;
          const status = s.status;
          
          if (!stats[actionDept]) stats[actionDept] = {};
          if (!stats[actionDept][month]) stats[actionDept][month] = { complete: 0, incomplete: 0 };
          
          if (status === 'ì¡°ì¹˜ì™„ë£Œ') {
            stats[actionDept][month].complete++;
          } else {
            stats[actionDept][month].incomplete++;
          }
        });
        return stats;
      };

      // 3. ì¸ì›ë³„ ì ‘ìˆ˜ê±´ìˆ˜ - ì´ë¦„(ë¶€ì„œ) í˜•ì‹, ì ‘ìˆ˜/ê¸°ê° êµ¬ë¶„
      const getPersonStats = () => {
        const stats = {};
        filteredByYear.forEach(s => {
          const name = s.name || 'ë¯¸ì§€ì •';
          const dept = s.department || '';
          const key = dept ? `${name}(${dept})` : name;
          const isRejected = s.status === 'ê¸°ê°';
          
          if (!stats[key]) stats[key] = { total: 0, rejected: 0 };
          stats[key].total++;
          if (isRejected) stats[key].rejected++;
        });
        return Object.entries(stats)
          .map(([name, data]) => [name, data.total - data.rejected, data.rejected, data.total])
          .sort((a, b) => b[3] - a[3]); // ì´ ê±´ìˆ˜ ê¸°ì¤€ ì •ë ¬
      };

      // 4. ì¡°ì¹˜ë‹´ë‹¹ìë³„ ì¡°ì¹˜ì™„ë£Œ ê±´ìˆ˜ - ì´ë¦„(ì¡°ì¹˜ë¶€ì„œ) í˜•ì‹, íŒ€ êµ¬ë¶„ ì—†ìŒ
      const getActionPersonStats = () => {
        const stats = {};
        filteredByYear.filter(s => s.status === 'ì¡°ì¹˜ì™„ë£Œ').forEach(s => {
          const actionPerson = s.actionPerson || 'ë¯¸ì§€ì •';
          const actionDept = s.actionDept || '';
          const key = actionDept ? `${actionPerson}(${actionDept})` : actionPerson;
          if (!stats[key]) stats[key] = 0;
          stats[key]++;
        });
        return Object.entries(stats).sort((a, b) => b[1] - a[1]);
      };

      const monthlyDeptStats = getMonthlyDeptStats();
      const monthlyActionDeptStats = getMonthlyActionDeptStats();
      const personStats = getPersonStats();
      const actionPersonStats = getActionPersonStats();

      const months = [1,2,3,4,5,6,7,8,9,10,11,12];
      
      // ì¡°ì¹˜ë¶€ì„œë³„ ì „ì²´ í†µê³„ (ì›í˜• ì°¨íŠ¸ìš©)
      const deptTotals = {};
      Object.keys(monthlyActionDeptStats).forEach(dept => {
        const deptData = monthlyActionDeptStats[dept];
        const complete = months.reduce((sum, m) => sum + (deptData[m]?.complete || 0), 0);
        const incomplete = months.reduce((sum, m) => sum + (deptData[m]?.incomplete || 0), 0);
        deptTotals[dept] = { complete, incomplete, total: complete + incomplete };
      });
      const deptList = Object.entries(deptTotals).sort((a, b) => b[1].total - a[1].total);
      const pieColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'];
      const displayDepts = selectedPieDept ? deptList.filter(([d]) => d === selectedPieDept) : deptList;

      // ì—‘ì…€ ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
      const exportToExcel = () => {
        const wb = XLSX.utils.book_new();

        // 1. ì›”ë³„ ë¶€ì„œë³„ ì ‘ìˆ˜ í˜„í™© ì‹œíŠ¸
        const deptHeaders = ['ë¶€ì„œ', ...months.map(m => m + 'ì›”'), 'í•©ê³„'];
        const deptRows = Object.keys(monthlyDeptStats).map(dept => {
          const deptData = monthlyDeptStats[dept];
          const total = months.reduce((sum, m) => sum + (deptData[m] || 0), 0);
          return [dept, ...months.map(m => deptData[m] || 0), total];
        });
        const ws1 = XLSX.utils.aoa_to_sheet([deptHeaders, ...deptRows]);
        XLSX.utils.book_append_sheet(wb, ws1, 'ë¶€ì„œë³„ ì ‘ìˆ˜í˜„í™©');

        // 2. ì›”ë³„ ì¡°ì¹˜ë¶€ì„œë³„ ì¡°ì¹˜ í˜„í™© ì‹œíŠ¸
        const actionHeaders = ['ì¡°ì¹˜ë¶€ì„œ', ...months.flatMap(m => [m + 'ì›” ì™„ë£Œ', m + 'ì›” ë¯¸ì¡°ì¹˜']), 'ì™„ë£Œ í•©ê³„', 'ë¯¸ì¡°ì¹˜ í•©ê³„'];
        const actionRows = Object.keys(monthlyActionDeptStats).map(dept => {
          const deptData = monthlyActionDeptStats[dept];
          const totalComplete = months.reduce((sum, m) => sum + (deptData[m]?.complete || 0), 0);
          const totalIncomplete = months.reduce((sum, m) => sum + (deptData[m]?.incomplete || 0), 0);
          return [dept, ...months.flatMap(m => [deptData[m]?.complete || 0, deptData[m]?.incomplete || 0]), totalComplete, totalIncomplete];
        });
        const ws2 = XLSX.utils.aoa_to_sheet([actionHeaders, ...actionRows]);
        XLSX.utils.book_append_sheet(wb, ws2, 'ì¡°ì¹˜ë¶€ì„œë³„ í˜„í™©');

        // 3. ì¸ì›ë³„ ì ‘ìˆ˜ê±´ìˆ˜ ì‹œíŠ¸ - ì›”ë³„ + ì ‘ìˆ˜/ê¸°ê° êµ¬ë¶„
        const personMonthlyStats = {};
        filteredByYear.forEach(s => {
          const date = parseDate(s.date);
          if (!date) return;
          const month = date.getMonth() + 1;
          const name = s.name || 'ë¯¸ì§€ì •';
          const dept = s.department || '';
          const key = name + '|||' + dept;
          const isRejected = s.status === 'ê¸°ê°';
          
          if (!personMonthlyStats[key]) personMonthlyStats[key] = { name, dept, months: {}, rejected: {} };
          if (!personMonthlyStats[key].months[month]) personMonthlyStats[key].months[month] = 0;
          if (!personMonthlyStats[key].rejected[month]) personMonthlyStats[key].rejected[month] = 0;
          
          personMonthlyStats[key].months[month]++;
          if (isRejected) personMonthlyStats[key].rejected[month]++;
        });
        
        const personHeaders = ['ë¶€ì„œ', 'ì´ë¦„', ...months.flatMap(m => [m + 'ì›” ì ‘ìˆ˜', m + 'ì›” ê¸°ê°']), 'ì´ ì ‘ìˆ˜', 'ì´ ê¸°ê°'];
        const personRows = Object.values(personMonthlyStats)
          .map(p => {
            const totalAll = months.reduce((sum, m) => sum + (p.months[m] || 0), 0);
            const totalRejected = months.reduce((sum, m) => sum + (p.rejected[m] || 0), 0);
            const totalAccepted = totalAll - totalRejected;
            return [p.dept, p.name, ...months.flatMap(m => [(p.months[m] || 0) - (p.rejected[m] || 0), p.rejected[m] || 0]), totalAccepted, totalRejected];
          })
          .sort((a, b) => (b[b.length-2] + b[b.length-1]) - (a[a.length-2] + a[a.length-1]));
        const ws3 = XLSX.utils.aoa_to_sheet([personHeaders, ...personRows]);
        XLSX.utils.book_append_sheet(wb, ws3, 'ì¸ì›ë³„ ì ‘ìˆ˜ê±´ìˆ˜');

        // 4. ì¡°ì¹˜ë‹´ë‹¹ìë³„ ì¡°ì¹˜ì™„ë£Œ ê±´ìˆ˜ ì‹œíŠ¸ - ì›”ë³„
        const actionPersonMonthlyStats = {};
        filteredByYear.filter(s => s.status === 'ì¡°ì¹˜ì™„ë£Œ').forEach(s => {
          const date = parseDate(s.date);
          if (!date) return;
          const month = date.getMonth() + 1;
          const name = s.actionPerson || 'ë¯¸ì§€ì •';
          const dept = s.actionDept || '';
          const key = name + '|||' + dept;
          
          if (!actionPersonMonthlyStats[key]) actionPersonMonthlyStats[key] = { name, dept, months: {} };
          if (!actionPersonMonthlyStats[key].months[month]) actionPersonMonthlyStats[key].months[month] = 0;
          actionPersonMonthlyStats[key].months[month]++;
        });
        
        const actionPersonHeaders = ['ë¶€ì„œ', 'ì´ë¦„', ...months.map(m => m + 'ì›”'), 'ì´ ê±´ìˆ˜'];
        const actionPersonRows = Object.values(actionPersonMonthlyStats)
          .map(p => {
            const total = months.reduce((sum, m) => sum + (p.months[m] || 0), 0);
            return [p.dept, p.name, ...months.map(m => p.months[m] || 0), total];
          })
          .sort((a, b) => b[14] - a[14]); // ì´ ê±´ìˆ˜ ê¸°ì¤€ ì •ë ¬
        const ws4 = XLSX.utils.aoa_to_sheet([actionPersonHeaders, ...actionPersonRows]);
        XLSX.utils.book_append_sheet(wb, ws4, 'ì¡°ì¹˜ë‹´ë‹¹ìë³„ ì™„ë£Œê±´ìˆ˜');

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        XLSX.writeFile(wb, `SIO_ë³´ê³ ì„œ_${selectedYear}ë…„.xlsx`);
      };

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-lg font-bold text-gray-800">ë³´ê³ ì„œ</h2>
            <div className="flex gap-2">
              <button onClick={exportToExcel} className="flex items-center gap-1 text-green-600 p-2 hover:bg-green-50 rounded-lg text-sm">
                <Icon name="Download" size={18} />
                <span>ë‚´ë³´ë‚´ê¸°</span>
              </button>
              <button onClick={onRefresh} className="text-blue-600 p-2 hover:bg-blue-50 rounded-lg">
                <Icon name="RefreshCw" size={20} />
              </button>
            </div>
          </div>

          {/* í•„í„° - ì—°ë„ë§Œ */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <div className="flex gap-3 items-center">
              <label className="text-sm text-gray-600">ì—°ë„ ì„ íƒ</label>
              <select value={selectedYear} onChange={(e) => setSelectedYear(Number(e.target.value))}
                className="p-2 border border-gray-300 rounded-lg text-sm">
                {years.map(y => <option key={y} value={y}>{y}ë…„</option>)}
              </select>
            </div>
          </div>

          {/* 1. ì›”ë³„ ë¶€ì„œë³„ ì ‘ìˆ˜ í˜„í™© */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="Building" size={18} /> ì›”ë³„ ë¶€ì„œë³„ ì ‘ìˆ˜ í˜„í™©
            </h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b bg-gray-50">
                    <th className="py-2 px-2 text-left text-gray-600 sticky left-0 bg-gray-50">ë¶€ì„œ</th>
                    {months.map(m => (
                      <th key={m} className="py-2 px-2 text-center text-gray-600 min-w-[40px]">{m}ì›”</th>
                    ))}
                    <th className="py-2 px-2 text-center text-gray-600 font-bold">í•©ê³„</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.keys(monthlyDeptStats).map(dept => {
                    const deptData = monthlyDeptStats[dept];
                    const total = months.reduce((sum, m) => sum + (deptData[m] || 0), 0);
                    return (
                      <tr key={dept} className="border-b hover:bg-gray-50">
                        <td className="py-2 px-2 font-medium sticky left-0 bg-white">{dept}</td>
                        {months.map(m => (
                          <td key={m} className="py-2 px-2 text-center">{deptData[m] || '-'}</td>
                        ))}
                        <td className="py-2 px-2 text-center font-bold text-blue-600">{total}</td>
                      </tr>
                    );
                  })}
                  {Object.keys(monthlyDeptStats).length === 0 && (
                    <tr><td colSpan={14} className="py-4 text-center text-gray-500">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>

          {/* 2. ì›”ë³„ ì¡°ì¹˜ë¶€ì„œë³„ ì¡°ì¹˜ í˜„í™© */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="CheckCircle" size={18} /> ì›”ë³„ ì¡°ì¹˜ë¶€ì„œë³„ ì¡°ì¹˜ í˜„í™©
            </h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="border-b bg-gray-50">
                    <th className="py-2 px-2 text-left text-gray-600 sticky left-0 bg-gray-50">ì¡°ì¹˜ë¶€ì„œ</th>
                    {months.map(m => (
                      <th key={m} className="py-2 px-1 text-center text-gray-600 min-w-[60px]">
                        <div>{m}ì›”</div>
                        <div className="flex text-xs">
                          <span className="flex-1 text-green-600">ì™„</span>
                          <span className="flex-1 text-red-600">ë¯¸</span>
                        </div>
                      </th>
                    ))}
                    <th className="py-2 px-2 text-center text-gray-600">í•©ê³„</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.keys(monthlyActionDeptStats).map(dept => {
                    const deptData = monthlyActionDeptStats[dept];
                    const totalComplete = months.reduce((sum, m) => sum + (deptData[m]?.complete || 0), 0);
                    const totalIncomplete = months.reduce((sum, m) => sum + (deptData[m]?.incomplete || 0), 0);
                    return (
                      <tr key={dept} className="border-b hover:bg-gray-50">
                        <td className="py-2 px-2 font-medium sticky left-0 bg-white">{dept}</td>
                        {months.map(m => (
                          <td key={m} className="py-2 px-1 text-center">
                            <div className="flex text-xs">
                              <span className="flex-1 text-green-600">{deptData[m]?.complete || '-'}</span>
                              <span className="flex-1 text-red-600">{deptData[m]?.incomplete || '-'}</span>
                            </div>
                          </td>
                        ))}
                        <td className="py-2 px-2 text-center">
                          <span className="text-green-600 font-bold">{totalComplete}</span>
                          <span className="text-gray-400 mx-1">/</span>
                          <span className="text-red-600 font-bold">{totalIncomplete}</span>
                        </td>
                      </tr>
                    );
                  })}
                  {Object.keys(monthlyActionDeptStats).length === 0 && (
                    <tr><td colSpan={14} className="py-4 text-center text-gray-500">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>

          {/* 2-1. ì—°ë„ ì „ì²´ ì¡°ì¹˜ë¶€ì„œë³„ ì¡°ì¹˜ìœ¨ (ì›í˜• ì°¨íŠ¸) */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="PieChart" size={18} /> {selectedYear}ë…„ ì¡°ì¹˜ë¶€ì„œë³„ ì¡°ì¹˜ìœ¨
            </h3>
            <p className="text-sm text-gray-500 mb-4">ë¶€ì„œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ë¶€ì„œë§Œ í‘œì‹œë©ë‹ˆë‹¤</p>
            
            <div>
              {/* ë¶€ì„œ ì„ íƒ ë²„íŠ¼ */}
              <div className="flex flex-wrap gap-2 mb-4">
                <button 
                  onClick={() => setSelectedPieDept(null)}
                  className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${!selectedPieDept ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                >
                  ì „ì²´
                </button>
                {deptList.map(([dept], idx) => (
                  <button 
                    key={dept}
                    onClick={() => setSelectedPieDept(selectedPieDept === dept ? null : dept)}
                    className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${selectedPieDept === dept ? 'text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                    style={selectedPieDept === dept ? { backgroundColor: pieColors[idx % pieColors.length] } : {}}
                  >
                    {dept}
                  </button>
                ))}
              </div>
              
              {/* ì›í˜• ì°¨íŠ¸ë“¤ */}
              <div className={`grid gap-4 ${displayDepts.length === 1 ? 'grid-cols-1 max-w-xs mx-auto' : 'grid-cols-2 md:grid-cols-3 lg:grid-cols-4'}`}>
                {displayDepts.map(([dept, data]) => {
                  const rate = data.total > 0 ? Math.round((data.complete / data.total) * 100) : 0;
                  const circumference = 2 * Math.PI * 36;
                  const strokeDasharray = `${(rate / 100) * circumference} ${circumference}`;
                  const colorIdx = deptList.findIndex(([d]) => d === dept);
                  const color = pieColors[colorIdx % pieColors.length];
                  
                  return (
                    <div 
                      key={dept} 
                      className={`flex flex-col items-center p-4 rounded-xl bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors ${displayDepts.length === 1 ? 'py-6' : ''}`}
                      onClick={() => setSelectedPieDept(selectedPieDept === dept ? null : dept)}
                    >
                      <div className={`relative ${displayDepts.length === 1 ? 'w-40 h-40' : 'w-24 h-24'}`}>
                        <svg className="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                          <circle cx="50" cy="50" r="36" fill="none" stroke="#E5E7EB" strokeWidth="16" />
                          <circle 
                            cx="50" cy="50" r="36" fill="none" 
                            stroke={color}
                            strokeWidth="16" 
                            strokeDasharray={strokeDasharray}
                            strokeLinecap="round"
                            className="transition-all duration-500"
                          />
                        </svg>
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                          <span className={`font-bold ${displayDepts.length === 1 ? 'text-3xl' : 'text-lg'}`} style={{ color: color }}>{rate}%</span>
                        </div>
                      </div>
                      <div className="mt-2 text-center">
                        <p className={`font-medium text-gray-800 ${displayDepts.length === 1 ? 'text-lg' : 'text-sm'}`}>{dept}</p>
                        <p className={`text-gray-500 ${displayDepts.length === 1 ? 'text-base' : 'text-xs'}`}>
                          <span className="text-green-600 font-medium">{data.complete}</span>
                          <span className="mx-1">/</span>
                          <span>{data.total}ê±´</span>
                        </p>
                      </div>
                    </div>
                  );
                })}
              </div>
              
              {deptList.length === 0 && (
                <p className="text-gray-500 text-center py-8">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              )}
            </div>
          </div>

          {/* 3. ì¸ì›ë³„ ì ‘ìˆ˜ê±´ìˆ˜ */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="Users" size={18} /> ì¸ì›ë³„ ì ‘ìˆ˜ê±´ìˆ˜ ({selectedYear}ë…„)
            </h3>
            <div className="space-y-2">
              {personStats.map(([name, accepted, rejected, total], idx) => (
                <div key={name} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                  <div className="flex items-center gap-2">
                    <span className="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs">{idx + 1}</span>
                    <span className="font-medium">{name}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-blue-600 font-bold">{accepted}ê±´</span>
                    {rejected > 0 && (
                      <>
                        <span className="text-gray-400">/</span>
                        <span className="text-red-500 font-bold">{rejected}ê¸°ê°</span>
                      </>
                    )}
                  </div>
                </div>
              ))}
              {personStats.length === 0 && <p className="text-gray-500 text-center py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>}
            </div>
          </div>

          {/* 4. ì¡°ì¹˜ë‹´ë‹¹ìë³„ ì¡°ì¹˜ì™„ë£Œ ê±´ìˆ˜ */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="UserCheck" size={18} /> ì¡°ì¹˜ë‹´ë‹¹ìë³„ ì¡°ì¹˜ì™„ë£Œ ê±´ìˆ˜ ({selectedYear}ë…„)
            </h3>
            <div className="space-y-2">
              {actionPersonStats.map(([name, count], idx) => (
                <div key={name} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                  <div className="flex items-center gap-2">
                    <span className="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs">{idx + 1}</span>
                    <span className="font-medium">{name}</span>
                  </div>
                  <span className="text-green-600 font-bold">{count}ê±´</span>
                </div>
              ))}
              {actionPersonStats.length === 0 && <p className="text-gray-500 text-center py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>}
            </div>
          </div>

          {/* 5. ì›”ë³„ ë¶€ì„œë³„ SIO í˜„í™© (FY Target í¬í•¨) */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <Icon name="Target" size={18} /> {selectedYear}ë…„ ì›”ë³„ ë¶€ì„œë³„ SIO í˜„í™©
            </h3>
            {(() => {
              // ë¶€ì„œë³„ ì´ì¸ì› ê°€ì ¸ì˜¤ê¸°
              const deptHeadcount = {};
              deptSettings.forEach(d => {
                if (d.department && d.totalMembers) {
                  deptHeadcount[d.department] = parseInt(d.totalMembers) || 0;
                }
              });
              
              // ë“±ë¡ëœ ë¶€ì„œ ëª©ë¡ (ì´ì¸ì›ì´ ìˆëŠ” ë¶€ì„œë§Œ)
              const departments = Object.keys(deptHeadcount).filter(d => deptHeadcount[d] > 0);
              
              // ì „ì²´ ì´ì¸ì›
              const totalHeadcount = departments.reduce((sum, d) => sum + deptHeadcount[d], 0);
              
              // FY Target (ì—°ê°„ëª©í‘œ) = ì´ì¸ì› Ã— 2
              const fyTargetByDept = {};
              departments.forEach(d => {
                fyTargetByDept[d] = deptHeadcount[d] * 2;
              });
              const totalFyTarget = totalHeadcount * 2;
              
              // Month Target = FY Target / 12
              const monthTargetByDept = {};
              departments.forEach(d => {
                monthTargetByDept[d] = Math.round((fyTargetByDept[d] / 12) * 10) / 10;
              });
              const totalMonthTarget = Math.round((totalFyTarget / 12) * 10) / 10;
              
              // ì›”ë³„ ë¶€ì„œë³„ ì ‘ìˆ˜ í˜„í™©
              const monthlyData = {};
              months.forEach(m => {
                monthlyData[m] = {};
                departments.forEach(d => {
                  monthlyData[m][d] = 0;
                });
              });
              
              filteredByYear.forEach(s => {
                const date = parseDate(s.date);
                if (!date) return;
                const month = date.getMonth() + 1;
                const dept = s.department;
                if (dept && departments.includes(dept)) {
                  monthlyData[month][dept]++;
                }
              });
              
              // ì›”ë³„ MTD (ëˆ„ì ) ê³„ì‚°
              const mtdByMonth = {};
              months.forEach(m => {
                mtdByMonth[m] = {};
                departments.forEach(d => {
                  let cumulative = 0;
                  for (let i = 1; i <= m; i++) {
                    cumulative += monthlyData[i][d] || 0;
                  }
                  mtdByMonth[m][d] = cumulative;
                });
              });
              
              // ì›”ë³„ ì „ì²´ í•©ê³„
              const monthlyTotal = {};
              months.forEach(m => {
                monthlyTotal[m] = departments.reduce((sum, d) => sum + (monthlyData[m][d] || 0), 0);
              });
              
              // MTD ì „ì²´ í•©ê³„
              const mtdTotal = {};
              months.forEach(m => {
                mtdTotal[m] = departments.reduce((sum, d) => sum + (mtdByMonth[m][d] || 0), 0);
              });
              
              // YTD Target (ëˆ„ì  ëª©í‘œ)
              const ytdTargetByMonth = {};
              months.forEach(m => {
                ytdTargetByMonth[m] = Math.round(totalMonthTarget * m);
              });
              
              // Target Rate (ëª©í‘œ ë¹„ìœ¨) - ê° ì›”ê¹Œì§€ì˜ ëˆ„ì  ëª©í‘œ / ì—°ê°„ ëª©í‘œ
              const targetRateByMonth = {};
              months.forEach(m => {
                targetRateByMonth[m] = Math.round((m / 12) * 100);
              });
              
              // Participant Rate (ì°¸ì—¬ìœ¨) = MTD / YTD Target Ã— 100
              const participantRateByMonth = {};
              months.forEach(m => {
                const ytdTarget = ytdTargetByMonth[m];
                participantRateByMonth[m] = ytdTarget > 0 ? Math.round((mtdTotal[m] / ytdTarget) * 100) : 0;
              });
              
              // ë¶€ì„œë³„ Participant Rate ê³„ì‚° ë° ì •ë ¬ (ë†’ì€ ìˆœ)
              const deptParticipantRate = {};
              departments.forEach(d => {
                const deptTotal = months.reduce((sum, m) => sum + (monthlyData[m][d] || 0), 0);
                const deptTarget = fyTargetByDept[d];
                deptParticipantRate[d] = deptTarget > 0 ? Math.round((deptTotal / deptTarget) * 100) : 0;
              });
              const sortedDepartments = [...departments].sort((a, b) => deptParticipantRate[b] - deptParticipantRate[a]);
              
              return (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm border-collapse">
                    <thead>
                      <tr className="bg-gray-100 border-b-2 border-gray-300">
                        <th className="py-3 px-3 text-left text-base font-bold text-gray-700 border border-gray-300 bg-gray-200">Month</th>
                        {sortedDepartments.map(d => (
                          <th key={d} className="py-3 px-3 text-center text-base font-bold text-gray-700 border border-gray-300 bg-gray-100 min-w-[70px]">{d}</th>
                        ))}
                        <th className="py-3 px-3 text-center text-base font-bold text-gray-700 border border-gray-300 bg-gray-200 min-w-[60px]">MTD</th>
                        <th className="py-3 px-3 text-center text-base font-bold text-yellow-700 border border-gray-300 bg-yellow-100 min-w-[80px]">Month Target</th>
                        <th className="py-3 px-3 text-center text-base font-bold text-yellow-700 border border-gray-300 bg-yellow-100 min-w-[80px]">YTD Target</th>
                      </tr>
                    </thead>
                    <tbody>
                      {months.map(m => {
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        return (
                          <tr key={m} className="border-b hover:bg-gray-50">
                            <td className="py-2 px-3 text-base font-medium border border-gray-300 bg-gray-50">{monthNames[m-1]}</td>
                            {sortedDepartments.map(d => (
                              <td key={d} className="py-2 px-3 text-center text-base border border-gray-300">{monthlyData[m][d] || '-'}</td>
                            ))}
                            <td className="py-2 px-3 text-center text-base font-bold border border-gray-300 bg-gray-50">{mtdTotal[m] || '-'}</td>
                            <td className="py-2 px-3 text-center text-base border border-gray-300 bg-yellow-50">{Math.round(totalMonthTarget)}</td>
                            <td className="py-2 px-3 text-center text-base border border-gray-300 bg-yellow-50">{ytdTargetByMonth[m]}</td>
                          </tr>
                        );
                      })}
                      {/* FY Target í–‰ */}
                      <tr className="bg-gray-200 border-t-2 border-gray-400">
                        <td className="py-2 px-3 text-base font-bold border border-gray-300">FY Target</td>
                        {sortedDepartments.map(d => (
                          <td key={d} className="py-2 px-3 text-center text-base font-bold border border-gray-300">{fyTargetByDept[d]}</td>
                        ))}
                        <td className="py-2 px-3 text-center text-base font-bold border border-gray-300">{totalFyTarget}</td>
                        <td className="py-2 px-3 border border-gray-300 bg-yellow-50"></td>
                        <td className="py-2 px-3 border border-gray-300 bg-yellow-50"></td>
                      </tr>
                      {/* Total SIO í–‰ */}
                      <tr className="bg-cyan-100">
                        <td className="py-2 px-3 text-base font-bold border border-gray-300 bg-cyan-200">Total SIO</td>
                        {sortedDepartments.map(d => {
                          const total = months.reduce((sum, m) => sum + (monthlyData[m][d] || 0), 0);
                          return <td key={d} className="py-2 px-3 text-center text-base font-bold border border-gray-300">{total || '-'}</td>;
                        })}
                        <td className="py-2 px-3 text-center text-base font-bold border border-gray-300">{months.reduce((sum, m) => sum + monthlyTotal[m], 0)}</td>
                        <td className="py-2 px-3 border border-gray-300"></td>
                        <td className="py-2 px-3 border border-gray-300"></td>
                      </tr>
                      {/* Participant Rate í–‰ */}
                      <tr className="bg-cyan-100">
                        <td className="py-2 px-3 text-base font-bold border border-gray-300 bg-cyan-200">Participant rate</td>
                        {sortedDepartments.map(d => {
                          const deptTotal = months.reduce((sum, m) => sum + (monthlyData[m][d] || 0), 0);
                          const deptTarget = fyTargetByDept[d];
                          const rate = deptTarget > 0 ? Math.round((deptTotal / deptTarget) * 100) : 0;
                          const currentYear = new Date().getFullYear();
                          const currentMonth = new Date().getMonth() + 1;
                          const expectedRate = selectedYear < currentYear ? 100 : Math.round((currentMonth / 12) * 100);
                          const isGood = rate >= expectedRate;
                          return (
                            <td key={d} className={`py-2 px-3 text-center text-base font-bold border border-gray-300 ${isGood ? 'bg-green-500 text-white' : 'bg-red-400 text-white'}`}>{rate}%</td>
                          );
                        })}
                        <td className={`py-2 px-3 text-center text-base font-bold border border-gray-300 ${(() => {
                          const total = months.reduce((sum, m) => sum + monthlyTotal[m], 0);
                          const rate = totalFyTarget > 0 ? Math.round((total / totalFyTarget) * 100) : 0;
                          const currentYear = new Date().getFullYear();
                          const currentMonth = new Date().getMonth() + 1;
                          const expectedRate = selectedYear < currentYear ? 100 : Math.round((currentMonth / 12) * 100);
                          return rate >= expectedRate ? 'bg-green-500 text-white' : 'bg-red-400 text-white';
                        })()}`}>
                          {(() => {
                            const total = months.reduce((sum, m) => sum + monthlyTotal[m], 0);
                            return totalFyTarget > 0 ? Math.round((total / totalFyTarget) * 100) + '%' : '0%';
                          })()}
                        </td>
                        <td className="py-2 px-3 border border-gray-300"></td>
                        <td className="py-2 px-3 border border-gray-300"></td>
                      </tr>
                    </tbody>
                  </table>
                  
                  {/* Monthly Progress */}
                  <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                    <p className="text-sm font-bold text-gray-700 mb-2">Monthly Progress</p>
                    <div className="overflow-x-auto">
                      <table className="w-full text-xs">
                        <thead>
                          <tr>
                            <td className="py-1 px-2 font-medium text-gray-600"></td>
                            {months.map(m => {
                              const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                              return <td key={m} className="py-1 px-2 text-center font-medium text-gray-600">{monthNames[m-1]}</td>;
                            })}
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td className="py-1 px-2 text-gray-500">Target rate</td>
                            {months.map(m => {
                              const targetRate = targetRateByMonth[m];
                              const actualRate = participantRateByMonth[m];
                              const currentYear = new Date().getFullYear();
                              const currentMonth = new Date().getMonth() + 1;
                              const isCurrentOrPast = selectedYear < currentYear || (selectedYear === currentYear && m <= currentMonth);
                              const isGood = actualRate >= targetRate;
                              return (
                                <td key={m} className={`py-1 px-2 text-center font-medium ${isCurrentOrPast ? (isGood ? 'bg-green-500 text-white' : 'bg-red-400 text-white') : 'bg-gray-200 text-gray-600'}`}>
                                  {targetRate}%
                                </td>
                              );
                            })}
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  
                  {departments.length === 0 && (
                    <p className="text-gray-500 text-center py-8">ë¶€ì„œì„¤ì •ì—ì„œ ì´ì¸ì›ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                  )}
                </div>
              );
            })()}
          </div>
        </div>
      );
    }

    function ActionTab({ submissions, settings, deptSettings, onUpdate, loading, onRefresh }) {
      const [selectedDept, setSelectedDept] = React.useState(null);
      const [selectedPhoto, setSelectedPhoto] = React.useState(null);
      const [passwordDept, setPasswordDept] = React.useState(null);

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const str = String(dateStr);
        const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
        if (match) return match[1] + '/' + match[2].padStart(2, '0') + '/' + match[3].padStart(2, '0');
        return str.split(' ')[0];
      };

      const filteredSubmissions = selectedDept ? submissions.filter(s => s.actionDept === selectedDept) : [];
      const getStatusColor = (status) => {
        switch (status) {
          case 'ì¡°ì¹˜ì™„ë£Œ': return 'bg-green-100 text-green-700 border-green-300';
          case 'ì¡°ì¹˜ì¤‘': return 'bg-yellow-100 text-yellow-700 border-yellow-300';
          case 'ê¸°ê°': return 'bg-red-100 text-red-700 border-red-300';
          default: return 'bg-blue-100 text-blue-700 border-blue-300';
        }
      };

      const handleDeptClick = (dept) => {
        const deptSetting = deptSettings.find(d => d.department === dept);
        if (deptSetting && deptSetting.password) { setPasswordDept(dept); }
        else { setSelectedDept(dept); }
      };

      if (!selectedDept) {
        return (
          <div className="space-y-4">
            <h2 className="text-lg font-bold text-gray-800 text-center">ì¡°ì¹˜</h2>
            <div className="bg-white rounded-xl shadow-md p-6">
              <p className="text-center text-gray-600 mb-6">í•´ë‹¹ ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
              <div className="grid grid-cols-2 gap-3">
                {settings.departments.map((dept, idx) => {
                  const count = submissions.filter(s => s.actionDept === dept && s.status !== 'ì¡°ì¹˜ì™„ë£Œ').length;
                  const hasPassword = deptSettings.find(d => d.department === dept)?.password;
                  return (
                    <button key={idx} onClick={() => handleDeptClick(dept)}
                      className="p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-colors">
                      <div className="font-bold text-gray-800 flex items-center justify-center gap-1">
                        {dept}{hasPassword && <Icon name="Lock" size={14} className="text-gray-400" />}
                      </div>
                      {count > 0 && <div className="text-sm text-red-500 mt-1">ë¯¸ì¡°ì¹˜ {count}ê±´</div>}
                    </button>
                  );
                })}
              </div>
            </div>
            {passwordDept && <PasswordModal department={passwordDept} deptSettings={deptSettings} onConfirm={() => { setSelectedDept(passwordDept); setPasswordDept(null); }} onCancel={() => setPasswordDept(null)} />}
          </div>
        );
      }

      return (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-2">
              <button onClick={() => setSelectedDept(null)} className="text-gray-500 p-2 hover:bg-gray-100 rounded-lg"><Icon name="ArrowLeft" size={20} /></button>
              <h2 className="text-lg font-bold text-gray-800">{selectedDept} ì¡°ì¹˜ëª©ë¡</h2>
            </div>
            <button onClick={onRefresh} className="text-blue-600 p-2 hover:bg-blue-50 rounded-lg"><Icon name="RefreshCw" size={20} /></button>
          </div>
          {filteredSubmissions.length === 0 ? (
            <div className="bg-white rounded-xl shadow-md p-6 text-center">
              <Icon name="CheckCircle" size={64} className="mx-auto text-green-300 mb-4" />
              <p className="text-gray-500">í• ë‹¹ëœ ì¡°ì¹˜ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          ) : (
            <div className="space-y-4">
              {filteredSubmissions.slice().reverse().map((item) => (
                <div key={item.id} className="bg-white rounded-xl shadow-md p-4">
                  <div className="flex justify-between items-start mb-3">
                    <div><span className={`inline-block px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(item.status)}`}>{item.status}</span></div>
                    <span className="text-sm bg-gray-100 px-2 py-1 rounded">{item.category}</span>
                  </div>
                  
                  {/* ê¸°ë³¸ ì •ë³´ */}
                  <div className="space-y-2 text-sm mb-3">
                    <div className="flex">
                      <span className="text-gray-500 w-20 flex-shrink-0">ì¼ì</span>
                      <span className="text-gray-700">{formatDate(item.date)}</span>
                    </div>
                    <div className="flex">
                      <span className="text-gray-500 w-20 flex-shrink-0">ì¥ì†Œ</span>
                      <span className="text-gray-700">{item.location}</span>
                    </div>
                    <div className="flex">
                      <span className="text-gray-500 w-20 flex-shrink-0">ë‚´ìš©</span>
                      <span className="text-gray-700">{item.content}</span>
                    </div>
                  </div>
                  
                  {/* ì ‘ìˆ˜ ì‚¬ì§„ - ë‘ ì¥ */}
                  {(item.photo || item.photo2) && (
                    <div className="mb-3">
                      <p className="text-sm text-gray-500 mb-1">ì ‘ìˆ˜ì‚¬ì§„</p>
                      <div className="grid grid-cols-2 gap-2">
                        {item.photo && (
                          <div>
                            <p className="text-xs text-gray-400 mb-1">ì›ê±°ë¦¬</p>
                            <img src={convertDriveUrl(item.photo)} alt="ì›ê±°ë¦¬" onClick={() => setSelectedPhoto(item.photo)} className="w-full h-28 object-cover rounded-lg cursor-pointer" />
                          </div>
                        )}
                        {item.photo2 && (
                          <div>
                            <p className="text-xs text-gray-400 mb-1">ê·¼ê±°ë¦¬</p>
                            <img src={convertDriveUrl(item.photo2)} alt="ê·¼ê±°ë¦¬" onClick={() => setSelectedPhoto(item.photo2)} className="w-full h-28 object-cover rounded-lg cursor-pointer" />
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                  
                  {/* ìš”ì²­ì‚¬í•­ */}
                  {item.request && (
                    <div className="mb-3 p-3 bg-yellow-50 rounded-lg">
                      <p className="text-xs font-medium text-yellow-700 mb-1">ìš”ì²­ì‚¬í•­</p>
                      <p className="text-sm text-gray-700 whitespace-pre-wrap">{item.request}</p>
                    </div>
                  )}
                  
                  {/* ì²¨ë¶€íŒŒì¼ */}
                  {item.attachment && (
                    <div className="mb-3">
                      <a href={item.attachment} target="_blank" className="inline-flex items-center gap-2 text-sm text-blue-600 hover:underline">
                        <Icon name="FileText" size={16} />ì²¨ë¶€íŒŒì¼ ë³´ê¸°
                      </a>
                    </div>
                  )}
                  
                  {/* ë¹„ê³  */}
                  {item.remarks && (
                    <div className="mb-3 p-2 bg-gray-50 rounded-lg">
                      <p className="text-xs text-gray-500 mb-1">ë¹„ê³ </p>
                      <p className="text-sm text-gray-700">{item.remarks}</p>
                    </div>
                  )}
                  
                  <div className="border-t pt-3 mt-3"><ActionForm item={item} onUpdate={onUpdate} /></div>
                </div>
              ))}
            </div>
          )}
          {selectedPhoto && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedPhoto(null)}>
              <div className="relative max-w-3xl max-h-full">
                <img src={convertDriveUrl(selectedPhoto)} alt="ì‚¬ì§„" className="max-w-full max-h-[80vh] object-contain rounded-lg bg-white" />
                <button onClick={() => setSelectedPhoto(null)} className="absolute top-2 right-2 bg-white text-gray-800 p-2 rounded-full shadow-lg"><Icon name="X" size={24} /></button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function ActionForm({ item, onUpdate }) {
      const [actionContent, setActionContent] = React.useState(item.actionContent || '');
      const [actionPerson, setActionPerson] = React.useState(item.actionPerson || '');
      const [actionPhotoPreview, setActionPhotoPreview] = React.useState(item.actionPhoto ? convertDriveUrl(item.actionPhoto) : null);
      const [newActionPhoto, setNewActionPhoto] = React.useState(null);
      const [saving, setSaving] = React.useState(false);
      const [compressing, setCompressing] = React.useState(false);

      // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ë° ì••ì¶• í•¨ìˆ˜
      const compressImage = (file, maxSize = 1280, quality = 0.85) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              
              if (width > height) {
                if (width > maxSize) {
                  height = Math.round((height * maxSize) / width);
                  width = maxSize;
                }
              } else {
                if (height > maxSize) {
                  width = Math.round((width * maxSize) / height);
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };

      const handlePhotoChange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          setCompressing(true);
          const compressedBase64 = await compressImage(file, 1280, 0.85);
          setActionPhotoPreview(compressedBase64);
          setNewActionPhoto(compressedBase64);
          setCompressing(false);
        }
      };

      const handleSave = async () => {
        setSaving(true);
        const updateData = { actionContent, actionPerson, status: item.status === 'ì ‘ìˆ˜ì™„ë£Œ' ? 'ì¡°ì¹˜ì¤‘' : item.status };
        if (newActionPhoto) updateData.actionPhoto = newActionPhoto;
        await onUpdate(item.id, updateData);
        setSaving(false); setNewActionPhoto(null);
      };

      const handleComplete = async () => {
        if (!actionContent || !actionPerson) { alert('ì¡°ì¹˜ë‚´ìš©ê³¼ ì¡°ì¹˜ë‹´ë‹¹ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        setSaving(true);
        const updateData = { actionContent, actionPerson, status: 'ì¡°ì¹˜ì™„ë£Œ' };
        if (newActionPhoto) updateData.actionPhoto = newActionPhoto;
        await onUpdate(item.id, updateData);
        setSaving(false); setNewActionPhoto(null);
      };

      return (
        <div className="space-y-3">
          <div><label className="block text-sm font-medium text-gray-700 mb-1">ì¡°ì¹˜ë‹´ë‹¹ì</label><input type="text" value={actionPerson} onChange={(e) => setActionPerson(e.target.value.replace(/[^ã„±-ã…ã…-ã…£ê°€-í£]/g, ''))} className="w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="ë‹´ë‹¹ì ì´ë¦„ (í•œê¸€ë§Œ)" /></div>
          <div><label className="block text-sm font-medium text-gray-700 mb-1">ì¡°ì¹˜ë‚´ìš©</label><textarea value={actionContent} onChange={(e) => setActionContent(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg text-sm h-20 resize-none" placeholder="ì¡°ì¹˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" /></div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">ì¡°ì¹˜ì‚¬ì§„</label>
            {compressing ? (
              <div className="flex flex-col items-center justify-center w-full h-20 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50">
                <Icon name="Loader" size={20} className="text-blue-500 spinner" />
                <span className="text-xs text-blue-600">ì••ì¶• ì¤‘...</span>
              </div>
            ) : actionPhotoPreview ? (
              <div className="relative"><img src={actionPhotoPreview} alt="ì¡°ì¹˜ì‚¬ì§„" className="w-full h-32 object-cover rounded-lg" /><button type="button" onClick={() => { setActionPhotoPreview(null); setNewActionPhoto(null); }} className="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full"><Icon name="X" size={16} /></button></div>
            ) : (
              <label className="flex flex-col items-center justify-center w-full h-20 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-500"><Icon name="Camera" size={24} className="text-gray-400" /><span className="text-xs text-gray-500">ì‚¬ì§„ ì²¨ë¶€</span><input type="file" accept="image/*" onChange={handlePhotoChange} className="hidden" /></label>
            )}
          </div>
          <div className="flex gap-2">
            <button onClick={handleSave} disabled={saving || compressing} className="flex-1 py-2 border border-blue-600 text-blue-600 rounded-lg font-medium hover:bg-blue-50 disabled:opacity-50">{saving ? 'ì €ì¥ ì¤‘...' : 'ì €ì¥'}</button>
            <button onClick={handleComplete} disabled={saving || compressing} className="flex-1 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 disabled:opacity-50">ì¡°ì¹˜ì™„ë£Œ</button>
          </div>
        </div>
      );
    }

    function AdminList({ submissions, settings, onDelete, onUpdate, loading, onRefresh }) {
      const [selectedPhoto, setSelectedPhoto] = React.useState(null);
      const [showFilter, setShowFilter] = React.useState(false);
      const [filters, setFilters] = React.useState({ department: '', category: '', location: '', status: '' });
      const [deleteTarget, setDeleteTarget] = React.useState(null);
      const [saving, setSaving] = React.useState(false);
      
      // ìˆ˜ì •ëœ ë°ì´í„° ì¶”ì 
      const [editedData, setEditedData] = React.useState({});
      const [attachmentFiles, setAttachmentFiles] = React.useState({});

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const str = String(dateStr);
        const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
        if (match) return match[1] + '/' + match[2].padStart(2, '0') + '/' + match[3].padStart(2, '0');
        return str.split(' ')[0];
      };

      const getStatusColor = (status) => {
        switch (status) {
          case 'ì¡°ì¹˜ì™„ë£Œ': return 'bg-green-100 text-green-700';
          case 'ì¡°ì¹˜ì¤‘': return 'bg-yellow-100 text-yellow-700';
          case 'ê¸°ê°': return 'bg-red-100 text-red-700';
          default: return 'bg-blue-100 text-blue-700';
        }
      };

      // í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸° (ìˆ˜ì •ëœ ê°’ ìš°ì„ )
      const getValue = (itemId, field, originalValue) => {
        if (editedData[itemId] && editedData[itemId][field] !== undefined) {
          return editedData[itemId][field];
        }
        return originalValue || '';
      };

      // í•„ë“œ ìˆ˜ì •
      const handleFieldChange = (itemId, field, value) => {
        let updates = { [field]: value };
        
        // ë©”ì¼ë°œì†¡ ì²´í¬ ì‹œ Target Date ìë™ ì„¤ì • (í•œë‹¬ ë’¤)
        if (field === 'emailSent' && value === true) {
          const targetDate = new Date();
          targetDate.setMonth(targetDate.getMonth() + 1);
          const targetDateStr = targetDate.toISOString().split('T')[0];
          updates.targetDate = targetDateStr;
        }
        
        // ì¡°ì¹˜ì™„ë£Œ ì„ íƒ ì‹œ Closed Date ìë™ ì„¤ì • (ì˜¤ëŠ˜)
        if (field === 'status' && value === 'ì¡°ì¹˜ì™„ë£Œ') {
          const today = new Date().toISOString().split('T')[0];
          updates.closedDate = today;
        }
        
        setEditedData(prev => ({
          ...prev,
          [itemId]: {
            ...prev[itemId],
            ...updates
          }
        }));
      };

      // ì²¨ë¶€íŒŒì¼ ë³€ê²½
      const handleAttachmentChange = (itemId, e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 10 * 1024 * 1024) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
          }
          const reader = new FileReader();
          reader.onload = () => {
            setAttachmentFiles(prev => ({
              ...prev,
              [itemId]: { name: file.name, data: reader.result }
            }));
            setEditedData(prev => ({
              ...prev,
              [itemId]: { ...prev[itemId], _hasAttachment: true }
            }));
          };
          reader.readAsDataURL(file);
        }
      };

      // ë³€ê²½ì‚¬í•­ ê°œìˆ˜
      const changedCount = Object.keys(editedData).length;

      // ë³€ê²½ì‚¬í•­ ì´ˆê¸°í™”
      const handleCancel = () => {
        setEditedData({});
        setAttachmentFiles({});
      };

      // ì‚¬ì§„ ì¬ì²¨ë¶€ (ì••ì¶• í¬í•¨)
      const compressImage = (file, maxSize = 1280, quality = 0.85) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              if (width > height) {
                if (width > maxSize) { height = Math.round((height * maxSize) / width); width = maxSize; }
              } else {
                if (height > maxSize) { width = Math.round((width * maxSize) / height); height = maxSize; }
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };

      const handlePhotoReplace = async (itemId, field, e) => {
        const file = e.target.files[0];
        if (file) {
          const compressedBase64 = await compressImage(file, 1280, 0.85);
          handleFieldChange(itemId, field, compressedBase64);
          // ë‘ë²ˆì§¸ ì‚¬ì§„ë„ ê°™ì´ ì²˜ë¦¬ (ë¹ˆ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì‚­ì œ)
          if (field === 'photo') {
            // photo ë³€ê²½ ì‹œ ë¬¼ì–´ë³´ê¸°
          }
        }
      };

      // ì¼ê´„ ì €ì¥
      const handleApply = async () => {
        if (changedCount === 0) return;
        setSaving(true);
        try {
          for (const [itemId, changes] of Object.entries(editedData)) {
            const updateData = { ...changes };
            delete updateData._hasAttachment;
            if (attachmentFiles[itemId]) {
              updateData.attachment = attachmentFiles[itemId].data;
            }
            await onUpdate(itemId, updateData);
          }
          setEditedData({});
          setAttachmentFiles({});
          await onRefresh();
        } catch (err) {
          alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        setSaving(false);
      };

      const filteredSubmissions = submissions.filter(item => {
        if (filters.department && item.department !== filters.department) return false;
        if (filters.category && item.category !== filters.category) return false;
        if (filters.location && item.location !== filters.location) return false;
        if (filters.status && item.status !== filters.status) return false;
        return true;
      });

      const activeFilterCount = Object.values(filters).filter(v => v !== '').length;

      if (submissions.length === 0 && !loading) {
        return (<div className="bg-white rounded-xl shadow-md p-6 text-center"><Icon name="Shield" size={64} className="mx-auto text-gray-300 mb-4" /><p className="text-gray-500">ì ‘ìˆ˜ëœ SIOê°€ ì—†ìŠµë‹ˆë‹¤.</p><button onClick={onRefresh} className="mt-4 text-blue-600 flex items-center gap-2 mx-auto"><Icon name="RefreshCw" size={16} /> ìƒˆë¡œê³ ì¹¨</button></div>);
      }

      return (
        <div className="space-y-4">
          {/* í—¤ë” */}
          <div className="flex justify-between items-center">
            <h2 className="text-lg font-bold text-gray-800">ê´€ë¦¬ ëª©ë¡ ({filteredSubmissions.length}ê±´)</h2>
            <div className="flex gap-2">
              <button onClick={onRefresh} className="text-blue-600 p-2 hover:bg-blue-50 rounded-lg"><Icon name="RefreshCw" size={20} /></button>
              <button onClick={() => setShowFilter(!showFilter)} className={`flex items-center gap-2 px-3 py-2 rounded-lg font-medium transition-colors ${showFilter ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border'}`}>
                <Icon name="Filter" size={18} />í•„í„°{activeFilterCount > 0 && <span className="bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">{activeFilterCount}</span>}
              </button>
            </div>
          </div>

          {/* ë³€ê²½ì‚¬í•­ ì•Œë¦¼ ë°” */}
          {changedCount > 0 && (
            <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 flex justify-between items-center sticky top-0 z-10">
              <span className="text-orange-700 font-medium"><Icon name="AlertCircle" size={16} className="inline mr-2" />{changedCount}ê±´ì˜ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤</span>
              <div className="flex gap-2">
                <button onClick={handleCancel} className="px-4 py-1.5 text-gray-600 border border-gray-300 rounded-lg text-sm">ì·¨ì†Œ</button>
                <button onClick={handleApply} disabled={saving} className="px-4 py-1.5 bg-blue-600 text-white rounded-lg text-sm font-medium disabled:opacity-50">{saving ? 'ì €ì¥ ì¤‘...' : 'ì ìš©'}</button>
              </div>
            </div>
          )}
          
          {/* í•„í„° */}
          {showFilter && (
            <div className="bg-white rounded-xl shadow-md p-4">
              <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-700 flex items-center gap-2"><Icon name="Filter" size={18} /> í•„í„° ì„¤ì •</h3><button onClick={() => setFilters({ department: '', category: '', location: '', status: '' })} className="flex items-center gap-1 text-sm text-gray-500"><Icon name="RotateCcw" size={14} /> ì´ˆê¸°í™”</button></div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div><label className="block text-xs font-medium text-gray-600 mb-1">ë¶€ì„œ</label><select value={filters.department} onChange={(e) => setFilters({...filters, department: e.target.value})} className="w-full p-2 border rounded-lg text-sm bg-white"><option value="">ì „ì²´</option>{settings.departments.map((d,i) => <option key={i} value={d}>{d}</option>)}</select></div>
                <div><label className="block text-xs font-medium text-gray-600 mb-1">êµ¬ë¶„</label><select value={filters.category} onChange={(e) => setFilters({...filters, category: e.target.value})} className="w-full p-2 border rounded-lg text-sm bg-white"><option value="">ì „ì²´</option>{settings.categories.map((c,i) => <option key={i} value={c}>{c}</option>)}</select></div>
                <div><label className="block text-xs font-medium text-gray-600 mb-1">ì¥ì†Œ</label><select value={filters.location} onChange={(e) => setFilters({...filters, location: e.target.value})} className="w-full p-2 border rounded-lg text-sm bg-white"><option value="">ì „ì²´</option>{settings.locations.map((l,i) => <option key={i} value={l}>{l}</option>)}</select></div>
                <div><label className="block text-xs font-medium text-gray-600 mb-1">ì¡°ì¹˜ì—¬ë¶€</label><select value={filters.status} onChange={(e) => setFilters({...filters, status: e.target.value})} className="w-full p-2 border rounded-lg text-sm bg-white"><option value="">ì „ì²´</option><option value="ì ‘ìˆ˜ì™„ë£Œ">ì ‘ìˆ˜ì™„ë£Œ</option><option value="ì¡°ì¹˜ì¤‘">ì¡°ì¹˜ì¤‘</option><option value="ì¡°ì¹˜ì™„ë£Œ">ì¡°ì¹˜ì™„ë£Œ</option><option value="ê¸°ê°">ê¸°ê°</option></select></div>
              </div>
            </div>
          )}

          {/* í…Œì´ë¸” */}
          <div className="bg-white rounded-xl shadow-md overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full min-w-[3000px]">
                <thead className="bg-gray-50 border-b"><tr>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">ì¼ì</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">ì´ë¦„</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">ë¶€ì„œ</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">êµ¬ë¶„</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">ì¥ì†Œ</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap w-32">ë‚´ìš©</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">ì ‘ìˆ˜ì‚¬ì§„</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">ì¡°ì¹˜ì—¬ë¶€</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">ì¡°ì¹˜ë¶€ì„œ</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap">ì¡°ì¹˜ë‹´ë‹¹</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap w-32">ì¡°ì¹˜ë‚´ìš©</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">ì¡°ì¹˜ì‚¬ì§„</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap w-32">ìš”ì²­ì‚¬í•­</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">ì²¨ë¶€</th>
                  <th className="px-2 py-3 text-left text-xs font-semibold text-gray-600 whitespace-nowrap w-24">ë¹„ê³ </th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">ë©”ì¼</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap">ì‚­ì œ</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">RPN</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Impact</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Incident</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Hazard</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Top5</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">SIO Category</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">KAF</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Target Date</th>
                  <th className="px-2 py-3 text-center text-xs font-semibold text-gray-600 whitespace-nowrap bg-yellow-50">Closed Date</th>
                </tr></thead>
                <tbody className="divide-y divide-gray-200">
                  {filteredSubmissions.length === 0 ? (<tr><td colSpan="17" className="px-3 py-8 text-center text-gray-500">í•„í„° ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>) : (
                    filteredSubmissions.slice().reverse().map((item) => {
                      const isEdited = editedData[item.id];
                      const formatDateForInput = (dateStr) => {
                        if (!dateStr) return '';
                        const str = String(dateStr);
                        const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
                        if (match) {
                          return match[1] + '-' + match[2].padStart(2,'0') + '-' + match[3].padStart(2,'0');
                        }
                        return '';
                      };
                      return (
                        <tr key={item.id} className={isEdited ? 'bg-orange-50' : 'hover:bg-gray-50'}>
                          <td className="px-2 py-2"><input type="date" value={getValue(item.id, 'date', formatDateForInput(item.date))} onChange={(e) => handleFieldChange(item.id, 'date', e.target.value)} className="w-28 p-1 border rounded text-xs" /></td>
                          <td className="px-2 py-2"><input type="text" value={getValue(item.id, 'name', item.name)} onChange={(e) => handleFieldChange(item.id, 'name', e.target.value)} className="w-16 p-1 border rounded text-xs" /></td>
                          <td className="px-2 py-2"><select value={getValue(item.id, 'department', item.department)} onChange={(e) => handleFieldChange(item.id, 'department', e.target.value)} className="w-20 p-1 border rounded text-xs bg-white"><option value="">-</option>{settings.departments.map((d,i) => <option key={i} value={d}>{d}</option>)}</select></td>
                          <td className="px-2 py-2"><select value={getValue(item.id, 'category', item.category)} onChange={(e) => handleFieldChange(item.id, 'category', e.target.value)} className="w-20 p-1 border rounded text-xs bg-white"><option value="">-</option>{settings.categories.map((c,i) => <option key={i} value={c}>{c}</option>)}</select></td>
                          <td className="px-2 py-2"><select value={getValue(item.id, 'location', item.location)} onChange={(e) => handleFieldChange(item.id, 'location', e.target.value)} className="w-24 p-1 border rounded text-xs bg-white"><option value="">-</option>{settings.locations.map((l,i) => <option key={i} value={l}>{l}</option>)}</select></td>
                          <td className="px-2 py-2"><textarea value={getValue(item.id, 'content', item.content)} onChange={(e) => handleFieldChange(item.id, 'content', e.target.value)} className="w-48 min-w-48 p-1 border rounded text-xs h-16 resize-y" /></td>
                          <td className="px-2 py-2">
                            <div className="flex flex-col gap-1">
                              {/* ì›ê±°ë¦¬ ì‚¬ì§„ */}
                              <div className="flex items-center gap-1">
                                <span className="text-xs text-blue-500 w-8">ì›:</span>
                                {(editedData[item.id]?.photo !== undefined ? editedData[item.id].photo : item.photo) ? (
                                  <>
                                    <button onClick={() => setSelectedPhoto(editedData[item.id]?.photo || item.photo)} className="text-blue-500 hover:text-blue-700" title="ì›ê±°ë¦¬ ë³´ê¸°"><Icon name="Image" size={14} /></button>
                                    <button onClick={() => handleFieldChange(item.id, 'photo', '')} className="text-red-400 hover:text-red-600" title="ì‚­ì œ"><Icon name="X" size={12} /></button>
                                  </>
                                ) : (
                                  <label className="cursor-pointer text-gray-400 hover:text-blue-600 text-xs"><Icon name="Upload" size={12} /><input type="file" accept="image/*" onChange={(e) => handlePhotoReplace(item.id, 'photo', e)} className="hidden" /></label>
                                )}
                              </div>
                              {/* ê·¼ê±°ë¦¬ ì‚¬ì§„ */}
                              <div className="flex items-center gap-1">
                                <span className="text-xs text-green-500 w-8">ê·¼:</span>
                                {(editedData[item.id]?.photo2 !== undefined ? editedData[item.id].photo2 : item.photo2) ? (
                                  <>
                                    <button onClick={() => setSelectedPhoto(editedData[item.id]?.photo2 || item.photo2)} className="text-green-500 hover:text-green-700" title="ê·¼ê±°ë¦¬ ë³´ê¸°"><Icon name="Image" size={14} /></button>
                                    <button onClick={() => handleFieldChange(item.id, 'photo2', '')} className="text-red-400 hover:text-red-600" title="ì‚­ì œ"><Icon name="X" size={12} /></button>
                                  </>
                                ) : (
                                  <label className="cursor-pointer text-gray-400 hover:text-green-600 text-xs"><Icon name="Upload" size={12} /><input type="file" accept="image/*" onChange={(e) => handlePhotoReplace(item.id, 'photo2', e)} className="hidden" /></label>
                                )}
                              </div>
                            </div>
                          </td>
                          <td className="px-2 py-2"><select value={getValue(item.id, 'status', item.status)} onChange={(e) => handleFieldChange(item.id, 'status', e.target.value)} className={`w-20 p-1 border rounded text-xs font-medium ${getStatusColor(getValue(item.id, 'status', item.status))}`}><option value="ì ‘ìˆ˜ì™„ë£Œ">ì ‘ìˆ˜ì™„ë£Œ</option><option value="ì¡°ì¹˜ì¤‘">ì¡°ì¹˜ì¤‘</option><option value="ì¡°ì¹˜ì™„ë£Œ">ì¡°ì¹˜ì™„ë£Œ</option><option value="ê¸°ê°">ê¸°ê°</option></select></td>
                          <td className="px-2 py-2"><select value={getValue(item.id, 'actionDept', item.actionDept)} onChange={(e) => handleFieldChange(item.id, 'actionDept', e.target.value)} className="w-24 p-1 border rounded text-xs bg-white"><option value="">-</option>{settings.departments.map((d,i) => <option key={i} value={d}>{d}</option>)}</select></td>
                          <td className="px-2 py-2"><input type="text" value={getValue(item.id, 'actionPerson', item.actionPerson)} onChange={(e) => handleFieldChange(item.id, 'actionPerson', e.target.value)} className="w-16 p-1 border rounded text-xs" /></td>
                          <td className="px-2 py-2"><textarea value={getValue(item.id, 'actionContent', item.actionContent)} onChange={(e) => handleFieldChange(item.id, 'actionContent', e.target.value)} className="w-48 min-w-48 p-1 border rounded text-xs h-16 resize-y" /></td>
                          <td className="px-2 py-2 text-center">
                            {(editedData[item.id]?.actionPhoto !== undefined ? editedData[item.id].actionPhoto : item.actionPhoto) ? (
                              <div className="flex items-center justify-center gap-1">
                                <button onClick={() => setSelectedPhoto(editedData[item.id]?.actionPhoto || item.actionPhoto)} className="text-green-500 hover:text-green-700" title="ì¡°ì¹˜ì‚¬ì§„ ë³´ê¸°"><Icon name="Image" size={14} /></button>
                                <button onClick={() => handleFieldChange(item.id, 'actionPhoto', '')} className="text-red-400 hover:text-red-600" title="ì‚­ì œ"><Icon name="X" size={12} /></button>
                              </div>
                            ) : (
                              <label className="cursor-pointer text-gray-400 hover:text-green-600"><Icon name="Upload" size={14} /><input type="file" accept="image/*" onChange={(e) => handlePhotoReplace(item.id, 'actionPhoto', e)} className="hidden" /></label>
                            )}
                          </td>
                          <td className="px-2 py-2"><textarea value={getValue(item.id, 'request', item.request)} onChange={(e) => handleFieldChange(item.id, 'request', e.target.value)} className="w-40 min-w-40 p-1 border rounded text-xs h-16 resize-y" /></td>
                          <td className="px-2 py-2 text-center">
                            {attachmentFiles[item.id] ? (
                              <span className="text-xs text-blue-600">{attachmentFiles[item.id].name.substring(0,8)}...</span>
                            ) : item.attachment ? (
                              <a href={item.attachment} target="_blank" className="text-purple-500 hover:text-purple-700"><Icon name="FileText" size={16} /></a>
                            ) : null}
                            <label className="cursor-pointer text-gray-400 hover:text-gray-600 ml-1"><Icon name="Paperclip" size={14} /><input type="file" onChange={(e) => handleAttachmentChange(item.id, e)} className="hidden" /></label>
                          </td>
                          <td className="px-2 py-2"><textarea value={getValue(item.id, 'remarks', item.remarks)} onChange={(e) => handleFieldChange(item.id, 'remarks', e.target.value)} className="w-40 min-w-40 p-1 border rounded text-xs h-16 resize-y" /></td>
                          <td className="px-2 py-2 text-center">
                            <input type="checkbox" checked={getValue(item.id, 'emailSent', item.emailSent)} onChange={(e) => handleFieldChange(item.id, 'emailSent', e.target.checked)} className="w-4 h-4 rounded" />
                          </td>
                          <td className="px-2 py-2 text-center"><button onClick={() => setDeleteTarget(item.id)} className="text-red-400 hover:text-red-600"><Icon name="Trash2" size={16} /></button></td>
                          {/* RPN - ìë™ê³„ì‚° */}
                          <td className="px-2 py-2 text-center bg-yellow-50">
                            <span className={`text-sm font-bold ${(() => {
                              const impact = getValue(item.id, 'impact', item.impact);
                              const incident = getValue(item.id, 'incident', item.incident);
                              const impactVal = impact === 'Minor' ? 1 : impact === 'Moderate' ? 2 : impact === 'Significant' ? 5 : 0;
                              const incidentVal = incident === 'Observation' ? 1 : incident === 'Notification' ? 2 : incident === 'Reportable' ? 5 : 0;
                              const rpn = impactVal * incidentVal;
                              return rpn >= 10 ? 'text-red-600' : rpn >= 4 ? 'text-yellow-600' : 'text-green-600';
                            })()}`}>
                              {(() => {
                                const impact = getValue(item.id, 'impact', item.impact);
                                const incident = getValue(item.id, 'incident', item.incident);
                                const impactVal = impact === 'Minor' ? 1 : impact === 'Moderate' ? 2 : impact === 'Significant' ? 5 : 0;
                                const incidentVal = incident === 'Observation' ? 1 : incident === 'Notification' ? 2 : incident === 'Reportable' ? 5 : 0;
                                return impactVal * incidentVal || '-';
                              })()}
                            </span>
                          </td>
                          {/* Impact */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <select value={getValue(item.id, 'impact', item.impact)} onChange={(e) => handleFieldChange(item.id, 'impact', e.target.value)} className="w-24 p-1 border rounded text-xs bg-white">
                              <option value="">-</option>
                              <option value="Minor">Minor(1)</option>
                              <option value="Moderate">Moderate(2)</option>
                              <option value="Significant">Significant(5)</option>
                            </select>
                          </td>
                          {/* Incident */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <select value={getValue(item.id, 'incident', item.incident)} onChange={(e) => handleFieldChange(item.id, 'incident', e.target.value)} className="w-28 p-1 border rounded text-xs bg-white">
                              <option value="">-</option>
                              <option value="Observation">Observation(1)</option>
                              <option value="Notification">Notification(2)</option>
                              <option value="Reportable">Reportable(5)</option>
                            </select>
                          </td>
                          {/* Hazard */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <select value={getValue(item.id, 'hazard', item.hazard)} onChange={(e) => handleFieldChange(item.id, 'hazard', e.target.value)} className="w-32 p-1 border rounded text-xs bg-white">
                              <option value="">-</option>
                              <option value="1 General Environment">1 General Environment</option>
                              <option value="2 Air Emission">2 Air Emission</option>
                              <option value="3 Water Mgmt">3 Water Mgmt</option>
                              <option value="4 Waste Mgmt">4 Waste Mgmt</option>
                              <option value="5 Chemical Mgmt">5 Chemical Mgmt</option>
                              <option value="6 Hazardous Mat">6 Hazardous Mat</option>
                              <option value="7 Safety Mgmt">7 Safety Mgmt</option>
                              <option value="8 Process Safety">8 Process Safety</option>
                              <option value="9 Emergency Prep">9 Emergency Prep</option>
                              <option value="10 Occupational Health">10 Occupational Health</option>
                              <option value="Environment">Environment</option>
                            </select>
                          </td>
                          {/* Top5 */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <select value={getValue(item.id, 'top5', item.top5)} onChange={(e) => handleFieldChange(item.id, 'top5', e.target.value)} className="w-16 p-1 border rounded text-xs bg-white">
                              <option value="">-</option>
                              <option value="Yes">Yes</option>
                              <option value="No">No</option>
                            </select>
                          </td>
                          {/* SIO Category */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <select value={getValue(item.id, 'sioCategory', item.sioCategory)} onChange={(e) => handleFieldChange(item.id, 'sioCategory', e.target.value)} className="w-36 p-1 border rounded text-xs bg-white">
                              <option value="">-</option>
                              <option value="Equipment Condition">Equipment Condition</option>
                              <option value="Material/Equipment Movement">Material/Equipment Movement</option>
                              <option value="5S & Workcondition">5S & Workcondition</option>
                              <option value="STF">STF</option>
                              <option value="People Behavior">People Behavior</option>
                              <option value="PPE">PPE</option>
                              <option value="LOTO">LOTO</option>
                              <option value="Machine Guarding">Machine Guarding</option>
                              <option value="Electrical Safety">Electrical Safety</option>
                              <option value="Powered Industrial Truck">Powered Industrial Truck</option>
                              <option value="Chemical">Chemical</option>
                              <option value="Ergo">Ergo</option>
                              <option value="Environment">Environment</option>
                            </select>
                          </td>
                          {/* KAF */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <input type="number" value={getValue(item.id, 'kaf', item.kaf)} onChange={(e) => handleFieldChange(item.id, 'kaf', e.target.value)} className="w-16 p-1 border rounded text-xs text-center" />
                          </td>
                          {/* Target Date */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <input type="date" value={getValue(item.id, 'targetDate', item.targetDate)} onChange={(e) => handleFieldChange(item.id, 'targetDate', e.target.value)} className="w-28 p-1 border rounded text-xs" />
                          </td>
                          {/* Closed Date */}
                          <td className="px-2 py-2 bg-yellow-50">
                            <input type="date" value={getValue(item.id, 'closedDate', item.closedDate)} onChange={(e) => handleFieldChange(item.id, 'closedDate', e.target.value)} className="w-28 p-1 border rounded text-xs" />
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>
          </div>

          {selectedPhoto && (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedPhoto(null)}><div className="relative max-w-3xl max-h-full"><img src={convertDriveUrl(selectedPhoto)} alt="ì‚¬ì§„" className="max-w-full max-h-[80vh] object-contain rounded-lg bg-white" /><button onClick={() => setSelectedPhoto(null)} className="absolute top-2 right-2 bg-white text-gray-800 p-2 rounded-full shadow-lg"><Icon name="X" size={24} /></button></div></div>)}
          {deleteTarget && <ConfirmModal message="ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" onConfirm={() => { onDelete(deleteTarget); setDeleteTarget(null); }} onCancel={() => setDeleteTarget(null)} />}
        </div>
      );
    }

    // ê´€ë¦¬(ëª¨ë°”ì¼) íƒ­ ì»´í¬ë„ŒíŠ¸
    function AdminMobile({ submissions, settings, onUpdate, loading, onRefresh }) {
      const [editingItem, setEditingItem] = React.useState(null);
      const [editData, setEditData] = React.useState({});
      const [selectedPhoto, setSelectedPhoto] = React.useState(null);
      const [saving, setSaving] = React.useState(false);
      const [statusFilter, setStatusFilter] = React.useState('all');
      const [compressing, setCompressing] = React.useState(false);
      const [compressing2, setCompressing2] = React.useState(false);
      const [photoPreview, setPhotoPreview] = React.useState(null);
      const [photoPreview2, setPhotoPreview2] = React.useState(null);
      
      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const str = String(dateStr);
        const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
        if (match) return match[1] + '/' + match[2].padStart(2, '0') + '/' + match[3].padStart(2, '0');
        return str.split(' ')[0];
      };
      
      const getStatusColor = (status) => {
        switch (status) {
          case 'ì¡°ì¹˜ì™„ë£Œ': return 'bg-green-100 text-green-700 border-green-300';
          case 'ì§„í–‰ì¤‘': return 'bg-yellow-100 text-yellow-700 border-yellow-300';
          case 'ê¸°ê°': return 'bg-gray-100 text-gray-700 border-gray-300';
          default: return 'bg-blue-100 text-blue-700 border-blue-300';
        }
      };
      
      // ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
      const compressImage = (file, maxWidth = 1024, quality = 0.7) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };
      
      // ì›ê±°ë¦¬ ì‚¬ì§„ ë³€ê²½
      const handlePhotoChange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setCompressing(true);
        const compressed = await compressImage(file);
        setPhotoPreview(compressed);
        setEditData(prev => ({ ...prev, photo: compressed, photoChanged: true }));
        setCompressing(false);
      };
      
      // ê·¼ê±°ë¦¬ ì‚¬ì§„ ë³€ê²½
      const handlePhoto2Change = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setCompressing2(true);
        const compressed = await compressImage(file);
        setPhotoPreview2(compressed);
        setEditData(prev => ({ ...prev, photo2: compressed, photo2Changed: true }));
        setCompressing2(false);
      };
      
      // ì‚¬ì§„ ì‚­ì œ
      const deletePhoto = (which) => {
        if (which === 'photo') {
          setPhotoPreview(null);
          setEditData(prev => ({ ...prev, photo: '', photoChanged: true }));
        } else {
          setPhotoPreview2(null);
          setEditData(prev => ({ ...prev, photo2: '', photo2Changed: true }));
        }
      };
      
      const filteredSubmissions = statusFilter === 'all' 
        ? [...submissions].reverse() 
        : [...submissions].filter(s => s.status === statusFilter).reverse();
      
      const startEdit = (item) => {
        setEditingItem(item.id);
        setEditData({
          date: item.date || '',
          name: item.name || '',
          department: item.department || '',
          location: item.location || '',
          content: item.content || '',
          photo: item.photo || '',
          photo2: item.photo2 || '',
          remarks: item.remarks || '',
          photoChanged: false,
          photo2Changed: false
        });
        setPhotoPreview(null);
        setPhotoPreview2(null);
      };
      
      const cancelEdit = () => {
        setEditingItem(null);
        setEditData({});
        setPhotoPreview(null);
        setPhotoPreview2(null);
      };
      
      const saveEdit = async (id) => {
        setSaving(true);
        // photoChanged, photo2Changed í•„ë“œ ì œê±°í•˜ê³  ì €ì¥
        const { photoChanged, photo2Changed, ...saveData } = editData;
        await onUpdate(id, saveData);
        setSaving(false);
        setEditingItem(null);
        setEditData({});
        setPhotoPreview(null);
        setPhotoPreview2(null);
      };
      
      return (
        <div className="space-y-4">
          <div className="bg-white rounded-xl shadow-md p-4 flex justify-between items-center">
            <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
              <Icon name="Smartphone" size={20} /> ê´€ë¦¬(ëª¨ë°”ì¼)
            </h2>
            <button onClick={onRefresh} disabled={loading} className="flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm">
              <Icon name="RefreshCw" size={16} className={loading ? 'spinner' : ''} /> ìƒˆë¡œê³ ì¹¨
            </button>
          </div>
          
          {/* ìƒíƒœ í•„í„° */}
          <div className="flex gap-2 overflow-x-auto pb-2">
            {['all', 'ì ‘ìˆ˜', 'ì§„í–‰ì¤‘', 'ì¡°ì¹˜ì™„ë£Œ', 'ê¸°ê°'].map(status => (
              <button key={status} onClick={() => setStatusFilter(status)}
                className={`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap ${statusFilter === status ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border'}`}>
                {status === 'all' ? 'ì „ì²´' : status} {status === 'all' ? `(${submissions.length})` : `(${submissions.filter(s => s.status === status).length})`}
              </button>
            ))}
          </div>
          
          {/* ì¹´ë“œ ëª©ë¡ */}
          <div className="space-y-3">
            {filteredSubmissions.map(item => (
              <div key={item.id} className="bg-white rounded-xl shadow-md overflow-hidden">
                {editingItem === item.id ? (
                  // ìˆ˜ì • ëª¨ë“œ
                  <div className="p-4 space-y-3">
                    <div className="flex justify-between items-center mb-2">
                      <span className="font-bold text-gray-800">#{item.id} ìˆ˜ì •</span>
                      <div className="flex gap-2">
                        <button onClick={cancelEdit} className="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm">ì·¨ì†Œ</button>
                        <button onClick={() => saveEdit(item.id)} disabled={saving} className="px-3 py-1 bg-blue-600 text-white rounded-lg text-sm flex items-center gap-1">
                          {saving && <Icon name="Loader" size={14} className="spinner" />} ì €ì¥
                        </button>
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <label className="text-xs text-gray-500">ì¼ì</label>
                        <input type="text" value={editData.date} onChange={(e) => setEditData({...editData, date: e.target.value})}
                          className="w-full p-2 border rounded-lg text-sm" />
                      </div>
                      <div>
                        <label className="text-xs text-gray-500">ì´ë¦„</label>
                        <input type="text" value={editData.name} onChange={(e) => setEditData({...editData, name: e.target.value})}
                          className="w-full p-2 border rounded-lg text-sm" />
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <label className="text-xs text-gray-500">ë¶€ì„œ</label>
                        <select value={editData.department} onChange={(e) => setEditData({...editData, department: e.target.value})}
                          className="w-full p-2 border rounded-lg text-sm bg-white">
                          <option value="">ì„ íƒ</option>
                          {settings.departments.map((d, i) => <option key={i} value={d}>{d}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="text-xs text-gray-500">ì¥ì†Œ</label>
                        <select value={editData.location} onChange={(e) => setEditData({...editData, location: e.target.value})}
                          className="w-full p-2 border rounded-lg text-sm bg-white">
                          <option value="">ì„ íƒ</option>
                          {settings.locations.map((l, i) => <option key={i} value={l}>{l}</option>)}
                        </select>
                      </div>
                    </div>
                    
                    <div>
                      <label className="text-xs text-gray-500">ë‚´ìš©</label>
                      <textarea value={editData.content} onChange={(e) => setEditData({...editData, content: e.target.value})}
                        className="w-full p-2 border rounded-lg text-sm h-20 resize-y" />
                    </div>
                    
                    {/* ì‚¬ì§„ ìˆ˜ì • */}
                    <div>
                      <label className="text-xs text-gray-500 mb-2 block">ì ‘ìˆ˜ ì‚¬ì§„</label>
                      <div className="grid grid-cols-2 gap-2">
                        {/* ì›ê±°ë¦¬ ì‚¬ì§„ */}
                        <div>
                          <p className="text-xs text-blue-600 mb-1">ì›ê±°ë¦¬</p>
                          {compressing ? (
                            <div className="flex items-center justify-center h-24 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50">
                              <Icon name="Loader" size={20} className="text-blue-500 spinner" />
                            </div>
                          ) : (photoPreview || editData.photo) ? (
                            <div className="relative">
                              <img src={photoPreview || convertDriveUrl(editData.photo)} alt="ì›ê±°ë¦¬" className="w-full h-24 object-cover rounded-lg" />
                              <button type="button" onClick={() => deletePhoto('photo')} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full">
                                <Icon name="X" size={14} />
                              </button>
                              <label className="absolute bottom-1 right-1 bg-blue-500 text-white p-1 rounded-full cursor-pointer">
                                <Icon name="Camera" size={14} />
                                <input type="file" accept="image/*" onChange={handlePhotoChange} className="hidden" />
                              </label>
                            </div>
                          ) : (
                            <label className="flex flex-col items-center justify-center h-24 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer hover:border-blue-500 bg-blue-50">
                              <Icon name="Upload" size={20} className="text-blue-400 mb-1" />
                              <span className="text-xs text-blue-600">ì—…ë¡œë“œ</span>
                              <input type="file" accept="image/*" onChange={handlePhotoChange} className="hidden" />
                            </label>
                          )}
                        </div>
                        {/* ê·¼ê±°ë¦¬ ì‚¬ì§„ */}
                        <div>
                          <p className="text-xs text-green-600 mb-1">ê·¼ê±°ë¦¬</p>
                          {compressing2 ? (
                            <div className="flex items-center justify-center h-24 border-2 border-dashed border-green-300 rounded-lg bg-green-50">
                              <Icon name="Loader" size={20} className="text-green-500 spinner" />
                            </div>
                          ) : (photoPreview2 || editData.photo2) ? (
                            <div className="relative">
                              <img src={photoPreview2 || convertDriveUrl(editData.photo2)} alt="ê·¼ê±°ë¦¬" className="w-full h-24 object-cover rounded-lg" />
                              <button type="button" onClick={() => deletePhoto('photo2')} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full">
                                <Icon name="X" size={14} />
                              </button>
                              <label className="absolute bottom-1 right-1 bg-green-500 text-white p-1 rounded-full cursor-pointer">
                                <Icon name="Camera" size={14} />
                                <input type="file" accept="image/*" onChange={handlePhoto2Change} className="hidden" />
                              </label>
                            </div>
                          ) : (
                            <label className="flex flex-col items-center justify-center h-24 border-2 border-dashed border-green-300 rounded-lg cursor-pointer hover:border-green-500 bg-green-50">
                              <Icon name="Upload" size={20} className="text-green-400 mb-1" />
                              <span className="text-xs text-green-600">ì—…ë¡œë“œ</span>
                              <input type="file" accept="image/*" onChange={handlePhoto2Change} className="hidden" />
                            </label>
                          )}
                        </div>
                      </div>
                    </div>
                    
                    <div>
                      <label className="text-xs text-gray-500">ë¹„ê³ </label>
                      <textarea value={editData.remarks} onChange={(e) => setEditData({...editData, remarks: e.target.value})}
                        className="w-full p-2 border rounded-lg text-sm h-16 resize-y" />
                    </div>
                  </div>
                ) : (
                  // ë³´ê¸° ëª¨ë“œ
                  <div className="p-4">
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-bold text-gray-500">#{item.id}</span>
                        <span className={`px-2 py-0.5 rounded-full text-xs font-medium border ${getStatusColor(item.status)}`}>{item.status || 'ì ‘ìˆ˜'}</span>
                      </div>
                      <button onClick={() => startEdit(item)} className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">
                        <Icon name="Edit2" size={14} className="inline mr-1" />ìˆ˜ì •
                      </button>
                    </div>
                    
                    <div className="space-y-2 text-sm">
                      <div className="flex gap-4">
                        <span className="text-gray-500 w-12">ì¼ì</span>
                        <span className="text-gray-800">{formatDate(item.date)}</span>
                      </div>
                      <div className="flex gap-4">
                        <span className="text-gray-500 w-12">ì´ë¦„</span>
                        <span className="text-gray-800">{item.name}</span>
                      </div>
                      <div className="flex gap-4">
                        <span className="text-gray-500 w-12">ë¶€ì„œ</span>
                        <span className="text-gray-800">{item.department}</span>
                      </div>
                      <div className="flex gap-4">
                        <span className="text-gray-500 w-12">ì¥ì†Œ</span>
                        <span className="text-gray-800">{item.location}</span>
                      </div>
                      <div className="flex gap-4">
                        <span className="text-gray-500 w-12">ë‚´ìš©</span>
                        <span className="text-gray-800 flex-1">{item.content}</span>
                      </div>
                    </div>
                    
                    {/* ì‚¬ì§„ */}
                    {(item.photo || item.photo2) && (
                      <div className="mt-3 grid grid-cols-2 gap-2">
                        {item.photo && (
                          <div>
                            <p className="text-xs text-gray-500 mb-1">ì›ê±°ë¦¬</p>
                            <img src={convertDriveUrl(item.photo)} alt="ì›ê±°ë¦¬" onClick={() => setSelectedPhoto(item.photo)}
                              className="w-full h-24 object-cover rounded-lg cursor-pointer" />
                          </div>
                        )}
                        {item.photo2 && (
                          <div>
                            <p className="text-xs text-gray-500 mb-1">ê·¼ê±°ë¦¬</p>
                            <img src={convertDriveUrl(item.photo2)} alt="ê·¼ê±°ë¦¬" onClick={() => setSelectedPhoto(item.photo2)}
                              className="w-full h-24 object-cover rounded-lg cursor-pointer" />
                          </div>
                        )}
                      </div>
                    )}
                    
                    {/* ë¹„ê³  */}
                    {item.remarks && (
                      <div className="mt-3 p-2 bg-gray-50 rounded-lg">
                        <p className="text-xs text-gray-500 mb-1">ë¹„ê³ </p>
                        <p className="text-sm text-gray-700 whitespace-pre-wrap">{item.remarks}</p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            ))}
            
            {filteredSubmissions.length === 0 && (
              <div className="bg-white rounded-xl shadow-md p-8 text-center text-gray-500">
                ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
              </div>
            )}
          </div>
          
          {/* ì‚¬ì§„ í™•ëŒ€ ëª¨ë‹¬ */}
          {selectedPhoto && (
            <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" onClick={() => setSelectedPhoto(null)}>
              <div className="relative max-w-3xl max-h-full">
                <img src={convertDriveUrl(selectedPhoto)} alt="ì‚¬ì§„" className="max-w-full max-h-[80vh] object-contain rounded-lg" />
                <button onClick={() => setSelectedPhoto(null)} className="absolute top-2 right-2 bg-white text-gray-800 p-2 rounded-full shadow-lg">
                  <Icon name="X" size={24} />
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function SettingsPanel({ settings, setSettings, deptSettings, onSaveDeptSettings, onSendSelectedNotifications, onSaveSettings, submissions, onRefresh }) {
      const [newItem, setNewItem] = React.useState({ departments: '', categories: '', locations: '' });
      const [localDeptSettings, setLocalDeptSettings] = React.useState([]);
      const [alertModal, setAlertModal] = React.useState(null);
      const [showPasswords, setShowPasswords] = React.useState({});
      const [showEmailSender, setShowEmailSender] = React.useState(false);
      const [selectedDept, setSelectedDept] = React.useState('');
      const [selectedItems, setSelectedItems] = React.useState([]);
      const [sending, setSending] = React.useState(false);

      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const str = String(dateStr);
        const match = str.match(/(\d{4})[\.\/-]\s*(\d{1,2})[\.\/-]\s*(\d{1,2})/);
        if (match) return match[1] + '/' + match[2].padStart(2, '0') + '/' + match[3].padStart(2, '0');
        return str.split(' ')[0];
      };

      React.useEffect(() => {
        const settingsMap = {};
        deptSettings.forEach(s => { settingsMap[s.department] = s; });
        setLocalDeptSettings(settings.departments.map(dept => ({
          department: dept,
          email: settingsMap[dept]?.email || '',
          password: settingsMap[dept]?.password || '',
          totalMembers: settingsMap[dept]?.totalMembers || ''
        })));
      }, [deptSettings, settings.departments]);

      const addItem = (key) => {
        if (newItem[key].trim()) {
          setSettings({ ...settings, [key]: [...settings[key], newItem[key].trim()] });
          setNewItem({ ...newItem, [key]: '' });
        }
      };

      const removeItem = (key, index) => setSettings({ ...settings, [key]: settings[key].filter((_, i) => i !== index) });

      const updateDeptSetting = (dept, field, value) => setLocalDeptSettings(localDeptSettings.map(s => s.department === dept ? { ...s, [field]: value } : s));

      const saveSettings = async () => {
        await onSaveDeptSettings(localDeptSettings);
        await onSaveSettings(settings);
        setAlertModal({ message: 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', type: 'success' });
      };

      const getUnsentItems = (dept) => submissions.filter(s => s.actionDept === dept && !s.emailSent);
      const totalUnsentCount = submissions.filter(s => s.actionDept && !s.emailSent).length;
      const unsentItemsForDept = selectedDept ? getUnsentItems(selectedDept) : [];

      const toggleItem = (id) => {
        setSelectedItems(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
      };

      const toggleAll = () => {
        setSelectedItems(selectedItems.length === unsentItemsForDept.length ? [] : unsentItemsForDept.map(i => i.id));
      };

      const sendSelectedEmails = async () => {
        if (selectedItems.length === 0) { setAlertModal({ message: 'ë°œì†¡í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', type: 'error' }); return; }
        setSending(true);
        const itemsToSend = submissions.filter(s => selectedItems.includes(s.id));
        const result = await onSendSelectedNotifications(itemsToSend);
        setSending(false);
        if (result.success) {
          setAlertModal({ message: result.message, type: 'success' });
          setSelectedItems([]);
          await onRefresh();
        } else {
          setAlertModal({ message: result.error || 'ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', type: 'error' });
        }
      };

      const sections = [
        { key: 'departments', label: 'ë¶€ì„œ (ì ‘ìˆ˜/ì¡°ì¹˜ ê³µìš©)' },
        { key: 'categories', label: 'êµ¬ë¶„' },
        { key: 'locations', label: 'ì¥ì†Œ' }
      ];

      return (
        <div className="space-y-6">
          <h2 className="text-lg font-bold text-gray-800">ì„¤ì •</h2>

          {/* ë¶€ì„œ ì„¤ì • (ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸/ì´ì¸ì›/ì°¸ì¡°) */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Icon name="Building" size={20} /> ë¶€ì„œë³„ ì„¤ì •</h3>
            <div className="space-y-3">
              {localDeptSettings.map((item, idx) => (
                <div key={idx} className="border border-gray-200 rounded-lg p-3">
                  <div className="flex items-center gap-2 mb-2">
                    <span className="font-medium text-gray-700">{item.department}</span>
                    {getUnsentItems(item.department).length > 0 && <span className="bg-orange-500 text-white text-xs rounded-full px-2 py-0.5">ë¯¸ë°œì†¡ {getUnsentItems(item.department).length}</span>}
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2">
                    <div className="flex items-center gap-2">
                      <Icon name="Mail" size={14} className="text-gray-400 flex-shrink-0" />
                      <input type="email" value={item.email} onChange={(e) => updateDeptSetting(item.department, 'email', e.target.value)}
                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm" placeholder="ì´ë©”ì¼" />
                    </div>
                    <div className="flex items-center gap-2">
                      <Icon name="Lock" size={14} className="text-gray-400 flex-shrink-0" />
                      <div className="flex-1 relative">
                        <input type={showPasswords[item.department] ? 'text' : 'password'} value={item.password} onChange={(e) => updateDeptSetting(item.department, 'password', e.target.value)}
                          className="w-full p-2 border border-gray-300 rounded-lg text-sm pr-8" placeholder="ë¹„ë°€ë²ˆí˜¸" />
                        <button type="button" onClick={() => setShowPasswords({ ...showPasswords, [item.department]: !showPasswords[item.department] })}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400"><Icon name={showPasswords[item.department] ? 'EyeOff' : 'Eye'} size={16} /></button>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <Icon name="Users" size={14} className="text-gray-400 flex-shrink-0" />
                      <input type="number" value={item.totalMembers} onChange={(e) => updateDeptSetting(item.department, 'totalMembers', e.target.value)}
                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm" placeholder="ì´ì¸ì›" />
                    </div>
                    <div className="flex items-center gap-2 lg:col-span-2">
                      <Icon name="Copy" size={14} className="text-gray-400 flex-shrink-0" />
                      <input type="email" value={item.ccEmail || ''} onChange={(e) => updateDeptSetting(item.department, 'ccEmail', e.target.value)}
                        className="flex-1 p-2 border border-gray-300 rounded-lg text-sm" placeholder="ì°¸ì¡°(CC) ì´ë©”ì¼" />
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* ë©”ì¼ ë°œì†¡ */}
          <div className="bg-white rounded-xl shadow-md p-4">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-gray-700 flex items-center gap-2">
                <Icon name="Mail" size={20} /> ë©”ì¼ ë°œì†¡
                {totalUnsentCount > 0 && <span className="bg-orange-500 text-white text-xs rounded-full px-2 py-0.5">ë¯¸ë°œì†¡ {totalUnsentCount}ê±´</span>}
              </h3>
              <button onClick={() => setShowEmailSender(!showEmailSender)} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium ${showEmailSender ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600'}`}>
                <Icon name="Send" size={16} /> {showEmailSender ? 'ë‹«ê¸°' : 'ë°œì†¡í•˜ê¸°'}
              </button>
            </div>

            {showEmailSender && (
              <div className="space-y-4 border-t pt-4">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-2">ì¡°ì¹˜ë¶€ì„œ ì„ íƒ</label>
                  <div className="flex flex-wrap gap-2">
                    {settings.departments.map((dept, idx) => {
                      const count = getUnsentItems(dept).length;
                      return (
                        <button key={idx} onClick={() => { setSelectedDept(dept); setSelectedItems([]); }}
                          className={`px-3 py-2 rounded-lg text-sm font-medium border ${selectedDept === dept ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300'}`}>
                          {dept} {count > 0 && <span className="ml-1 bg-orange-500 text-white rounded-full px-1.5 text-xs">{count}</span>}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {selectedDept && (
                  <div className="border border-gray-200 rounded-lg p-3">
                    <div className="flex justify-between items-center mb-3">
                      <span className="font-medium text-gray-700">{selectedDept} ë¯¸ë°œì†¡ ëª©ë¡ ({unsentItemsForDept.length}ê±´)</span>
                      {unsentItemsForDept.length > 0 && (
                        <button onClick={toggleAll} className="text-sm text-blue-600">{selectedItems.length === unsentItemsForDept.length ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ'}</button>
                      )}
                    </div>
                    {unsentItemsForDept.length === 0 ? (
                      <p className="text-gray-500 text-sm text-center py-4">ë¯¸ë°œì†¡ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    ) : (
                      <div className="space-y-2 max-h-60 overflow-y-auto">
                        {unsentItemsForDept.map(item => (
                          <label key={item.id} className={`flex items-start gap-3 p-2 rounded-lg cursor-pointer ${selectedItems.includes(item.id) ? 'bg-blue-50 border border-blue-200' : 'bg-gray-50'}`}>
                            <input type="checkbox" checked={selectedItems.includes(item.id)} onChange={() => toggleItem(item.id)} className="mt-1 w-4 h-4" />
                            <div className="flex-1 text-sm">
                              <div className="text-gray-600">{formatDate(item.date)} | {item.location}</div>
                              <div className="text-gray-800">{item.content}</div>
                              {item.request && <div className="text-yellow-600 text-xs">ìš”ì²­: {item.request}</div>}
                            </div>
                          </label>
                        ))}
                      </div>
                    )}
                    {unsentItemsForDept.length > 0 && (
                      <button onClick={sendSelectedEmails} disabled={sending || selectedItems.length === 0}
                        className="w-full mt-3 py-2 bg-orange-500 text-white rounded-lg font-medium disabled:opacity-50 flex items-center justify-center gap-2">
                        {sending ? <><Icon name="Loader" size={16} className="spinner" /> ë°œì†¡ ì¤‘...</> : <><Icon name="Send" size={16} /> ì„ íƒ í•­ëª© ë©”ì¼ ë°œì†¡ ({selectedItems.length}ê±´)</>}
                      </button>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* ì €ì¥ ë²„íŠ¼ */}
          <button onClick={saveSettings} className="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 flex items-center justify-center gap-2">
            <Icon name="Save" size={18} /> ì„¤ì • ì €ì¥
          </button>

          {/* ëª©ë¡ ê´€ë¦¬ */}
          {sections.map(({ key, label }) => (
            <div key={key} className="bg-white rounded-xl shadow-md p-4">
              <h3 className="font-bold text-gray-700 mb-3">{label} ëª©ë¡</h3>
              <div className="flex gap-2 mb-3">
                <input type="text" value={newItem[key]} onChange={(e) => setNewItem({ ...newItem, [key]: e.target.value })}
                  className="flex-1 p-2 border border-gray-300 rounded-lg text-sm" placeholder={`ìƒˆ í•­ëª© ì¶”ê°€`}
                  onKeyPress={(e) => e.key === 'Enter' && addItem(key)} />
                <button onClick={() => addItem(key)} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"><Icon name="Plus" size={20} /></button>
              </div>
              <div className="space-y-2">
                {(settings[key] || []).map((item, idx) => (
                  <div key={idx} className="flex items-center justify-between bg-gray-50 p-2 rounded-lg">
                    <span className="text-sm text-gray-700">{item}</span>
                    <button onClick={() => removeItem(key, idx)} className="text-red-400 hover:text-red-600"><Icon name="Trash2" size={16} /></button>
                  </div>
                ))}
              </div>
            </div>
          ))}

          {alertModal && <AlertModal message={alertModal.message} type={alertModal.type} onClose={() => setAlertModal(null)} />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
